<!DOCTYPE html>
<html class="dark" lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RPG da Vida Real - Aventura</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

  <!-- Google Fonts e Ícones -->
  <link href="https://fonts.googleapis.com/css2?family=Spline+Sans:wght@400;500;700&amp;display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

  <!-- Configuração do Tailwind -->
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#13ec6d",
            "background-light": "#f6f8f7",
            "background-dark": "#102218",
            // Cores do novo Hub
            "surface-dark": "#1a3828",
            "text-dark-primary": "#ffffff",
            "text-dark-secondary": "#9db9a8",
            "border-dark": "#335c47",
            "health": "#ef4444",
            "mana": "#3b82f6",
            "xp": "#f59e0b"
          },
          fontFamily: {
            "display": ["Spline Sans", "sans-serif"]
          },
          borderRadius: {
            "DEFAULT": "1rem",
            "lg": "1.5rem",
            "xl": "2rem",
            "full": "9999px"
          },
          boxShadow: {
            'glow-primary': '0 0 15px 0px rgba(19, 236, 109, 0.3)',
          },
        },
      },
    }
  </script>

  <!-- Estilos Globais -->
  <style>
    body {
      min-height: max(884px, 100dvh);
      background-color: #102218;
      font-family: 'Spline Sans', sans-serif;
    }

    .material-symbols-outlined {
      font-variation-settings:
        'FILL' 0,
        'wght' 400,
        'GRAD' 0,
        'opsz' 24;
    }

    /* Classe helper para a seleção de avatar */
    .avatar-selected {
      border-color: #13ec6d !important;
      box-shadow: 0 0 15px 2px rgba(19, 236, 109, 0.5);
    }

    /* Classe helper para o tipo de tarefa selecionado */
    .task-type-selected {
        background-color: #13ec6d !important;
        color: #102218 !important;
        border-color: #13ec6d !important;
    }
    /* Classe helper para a prioridade de tarefa selecionada */
    .task-priority-selected {
        background-color: #f59e0b !important; /* Cor de XP para destaque */
        color: #102218 !important;
        border-color: #f59e0b !important;
    }
    /* Classe helper para o dia da semana de recorrência selecionado */
    .weekday-btn-selected {
        background-color: #3b82f6 !important; /* Cor de Mana para destaque */
        color: #ffffff !important;
        border-color: #3b82f6 !important;
    }
  </style>
</head>

<body class="bg-background-light dark:bg-background-dark font-display text-white">

  <!-- Container Principal da Aplicação -->
  <div id="app-container">

    <!-- Tela 1: Abertura (Splash) -->
    <div id="screen-splash" class="relative flex min-h-screen w-full flex-col dark group/design-root overflow-x-hidden">
      <!-- Background Image -->
      <div class="absolute inset-0 z-0">
        <div class="h-full w-full bg-center bg-no-repeat bg-cover opacity-10" data-alt="A subtle, stylized texture resembling an old, weathered fantasy map." style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuD6sSjEhz7hgGMCO9BdTp0pHGvGbE3XMpV6jPLsVzsYPwCqNXpNCbXwpEujggDvZYrE9pQH3Y5d5BVF7gvg7jPZ0AXCp2Nwx2A7FFDzew_5BcOaQSLjVdbARuQ92QAHPYPKFF8zuiCOXoXUsMSviMA_KKbTiUtBIpnFlJBm280neUs4DCq_Bfit7g90h0YuQrldqBiXPliiGMqqxXfOBfNx_NLz-YaO63IyoVmNdwY8nkPEARovFkiWn0qj-T5XhZjUWMi1i1P7O7tL_");'></div>
      </div>
      <!-- Main Content -->
      <div class="relative z-10 flex w-full grow flex-col justify-between p-4 @container min-h-screen">
        <div class="flex flex-1 flex-col items-center justify-center">
          <!-- Logo -->
          <div class="flex flex-col items-center justify-center text-center mb-8">
            <div class="text-primary" data-icon="ShieldCheck" data-size="64px" data-weight="bold">
              <svg class="fill-current" height="64" viewbox="0 0 256 256" width="64" xmlns="http://www.w3.org/2000/svg">
                <path d="M229.06,75.12,139,17.26a16,16,0,0,0-22,0L26.94,75.12A16,16,0,0,0,20,87.82V168a16,16,0,0,0,16,16H220a16,16,0,0,0,16-16V87.82A16,16,0,0,0,229.06,75.12Z" opacity="0.2"></path>
                <path d="M220,48H36A20,20,0,0,0,16,68V188a20,20,0,0,0,20,20H220a20,20,0,0,0,20-20V68A20,20,0,0,0,220,48Zm4,140a4,4,0,0,1-4,4H36a4,4,0,0,1-4-4V68a4,4,0,0,1,4-4H220a4,4,0,0,1,4,4Zm-54.34-82.34-48,48a8,8,0,0,1-11.32,0l-24-24a8,8,0,0,1,11.32-11.32L112,124.69l42.34-42.35a8,8,0,0,1,11.32,11.32Z"></path>
              </svg>
            </div>
            <h1 class="text-white text-3xl font-bold mt-2">RPG da Vida</h1>
          </div>
          <!-- Slogan/Tagline -->
          <h3 class="text-white tracking-light text-2xl font-bold leading-tight px-4 text-center pb-8 pt-5">Sua vida, suas regras, seu próximo nível.</h3>
        </div>
        <!-- Action Buttons and Social Login -->
        <div class="flex w-full flex-col items-center">
          <div class="flex w-full flex-1 flex-col items-stretch gap-3 max-w-[480px] py-3">
            <button id="btn-goto-register" class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-12 px-5 bg-primary text-background-dark text-base font-bold leading-normal tracking-[0.015em] w-full">
              <span class="truncate">Iniciar Jornada</span>
            </button>
            <button id="btn-goto-login" class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-12 px-5 bg-primary/20 text-white text-base font-bold leading-normal tracking-[0.015em] w-full">
              <span class="truncate">Continuar Aventura</span>
            </button>
          </div>
          <p class="text-[#9db9a8]/80 text-sm font-normal leading-normal pb-3 pt-4 px-4 text-center">Ou entre com</p>
          <div class="w-full max-w-[480px]">
            <div class="gap-4 px-4 grid-cols-[repeat(auto-fit,_minmax(80px,_1fr))] grid">
              <div id="btn-google-login" class="flex flex-col items-center gap-2 py-2.5 text-center cursor-pointer">
                <div class="rounded-full bg-primary/20 p-3.5">
                  <span class="material-symbols-outlined text-white text-[24px]">
                    sports_esports
                  </span>
                </div>
                <p class="text-white text-sm font-medium leading-normal">Google</p>
              </div>
              <div class="flex flex-col items-center gap-2 py-2.5 text-center opacity-50 cursor-not-allowed" title="Login com Apple em breve">
                <div class="rounded-full bg-primary/20 p-3.5">
                  <span class="material-symbols-outlined text-white text-[24px]">ios</span>
                </div>
                <p class="text-white text-sm font-medium leading-normal">Apple</p>
              </div>
              <div class="flex flex-col items-center gap-2 py-2.5 text-center opacity-50 cursor-not-allowed" title="Login com Facebook em breve">
                <div class="rounded-full bg-primary/20 p-3.5">
                  <span class="material-symbols-outlined text-white text-[24px]">social_leaderboard</span>
                </div>
                <p class="text-white text-sm font-medium leading-normal">Facebook</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tela 2: Cadastro (Criação de Personagem) -->
    <div id="screen-register" class="hidden relative flex h-auto min-h-screen w-full flex-col bg-background-light dark:bg-background-dark group/design-root overflow-x-hidden">
      <!-- Top App Bar -->
      <div class="flex items-center bg-background-light dark:bg-background-dark p-4 pb-2 justify-between sticky top-0 z-10">
        <button id="reg-back-btn" class="text-white flex size-12 shrink-0 items-center justify-center cursor-pointer">
          <span class="material-symbols-outlined text-3xl">arrow_back</span>
        </button>
        <h2 class="text-white text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center pr-12">Criação de Personagem</h2>
      </div>
      <!-- Page Indicators -->
      <div class="flex w-full flex-row items-center justify-center gap-3 py-5 px-4">
        <div id="progress-1" class="h-1 flex-1 rounded-full bg-primary"></div>
        <div id="progress-2" class="h-1 flex-1 rounded-full bg-primary/20"></div>
        <div id="progress-3" class="h-1 flex-1 rounded-full bg-primary/20"></div>
      </div>
      <main class="flex-grow px-4">
        <!-- Step 1: Identidade -->
        <section class="flex flex-col gap-4" id="step-1">
          <h1 class="text-white tracking-light text-[32px] font-bold leading-tight text-left pb-3 pt-6">Identidade</h1>
          <div class="flex flex-col gap-4">
            <label class="flex flex-col w-full">
              <p class="text-white text-base font-medium leading-normal pb-2">Nome de Aventureiro</p>
              <input id="reg-nickname" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-white focus:outline-0 focus:ring-0 border border-primary/30 bg-[#1C2720] focus:border-primary h-14 placeholder:text-white/40 p-[15px] text-base font-normal leading-normal" placeholder="Ex: Aragorn" value="" />
            </label>
            <label class="flex flex-col w-full">
              <p class="text-white text-base font-medium leading-normal pb-2">Email</p>
              <input id="reg-email" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-white focus:outline-0 focus:ring-0 border border-primary/30 bg-[#1C2720] focus:border-primary h-14 placeholder:text-white/40 p-[15px] text-base font-normal leading-normal" placeholder="seu.email@dominio.com" type="email" value="" />
            </label>
            <label class="flex flex-col w-full">
              <p class="text-white text-base font-medium leading-normal pb-2">Senha</p>
              <input id="reg-password" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-white focus:outline-0 focus:ring-0 border border-primary/30 bg-[#1C2720] focus:border-primary h-14 placeholder:text-white/40 p-[15px] text-base font-normal leading-normal" placeholder="Crie uma senha forte" type="password" value="" />
            </label>
          </div>
        </section>
        <!-- Step 2: Vitals -->
        <section class="hidden flex-col gap-4" id="step-2">
          <h1 class="text-white tracking-light text-[32px] font-bold leading-tight text-left pb-1 pt-6">Atributos Físicos</h1>
          <p class="text-white/70 text-base font-normal leading-normal px-0 pb-4">Esses são seus "atributos base" iniciais. Você poderá evoluí-los durante sua jornada.</p>
          <div class="flex flex-col gap-4">
            <label class="flex flex-col w-full">
              <p class="text-white text-base font-medium leading-normal pb-2">Altura (cm)</p>
              <input id="reg-height" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-white focus:outline-0 focus:ring-0 border border-primary/30 bg-[#1C2720] focus:border-primary h-14 placeholder:text-white/40 p-[15px] text-base font-normal leading-normal" placeholder="Ex: 180" type="number" value="" />
            </label>
            <div class="grid grid-cols-2 gap-4">
              <label class="flex flex-col w-full">
                <p class="text-white text-base font-medium leading-normal pb-2">Peso Atual (kg)</p>
                <input id="reg-weight" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-white focus:outline-0 focus:ring-0 border border-primary/30 bg-[#1C2720] focus:border-primary h-14 placeholder:text-white/40 p-[15px] text-base font-normal leading-normal" placeholder="Ex: 85" type="number" value="" />
              </label>
              <label class="flex flex-col w-full">
                <p class="text-white text-base font-medium leading-normal pb-2">Meta de Peso (kg)</p>
                <input id="reg-weight-target" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-white focus:outline-0 focus:ring-0 border border-primary/30 bg-[#1C2720] focus:border-primary h-14 placeholder:text-white/40 p-[15px] text-base font-normal leading-normal" placeholder="Ex: 80" type="number" value="" />
              </label>
            </div>
          </div>
        </section>
        <!-- Step 3: Aparência -->
        <section class="hidden flex-col gap-4" id="step-3">
          <h1 class="text-white tracking-light text-[32px] font-bold leading-tight text-left pb-1 pt-6">Aparência</h1>
          <p class="text-white/70 text-base font-normal leading-normal px-0 pb-4">Escolha sua representação no jogo. Esta será sua identidade visual.</p>
          <div class="grid grid-cols-2 gap-4" id="avatar-selection">
            <div class="avatar-option aspect-square bg-primary/20 rounded-lg flex items-center justify-center border-2 border-transparent cursor-pointer transition-all" data-avatar-url="https://lh3.googleusercontent.com/aida-public/AB6AXuDTxayBmUlfJy71v5imptwwCT0UyzBNOkbhEA-t6F2WaM8NWdT5j0bfCglTU4pllPR2e_1y6jYkKhzENWZrh1VKExhriwROlAjFE7YD3FxTA6CFpG80I7MBWdHw2RFQ6MPMK9AP6tB8eoFjjtVXcpwxntGiq995k5WVtg_7PNsrhToO7kcyGsjqtQ8yYsD4kKHSFVTG_6fC86DCZOGTRR6MVocBqIfg0hoU_0pBKWQ-GBcl10KH3aQAJV5ku9BFDaHxpGqfEgXb85eG">
              <img class="w-full h-full object-cover rounded-lg" alt="Avatar de uma mulher com cabelos escuros e olhar sério." src="https://lh3.googleusercontent.com/aida-public/AB6AXuDTxayBmUlfJy71v5imptwwCT0UyzBNOkbhEA-t6F2WaM8NWdT5j0bfCglTU4pllPR2e_1y6jYkKhzENWZrh1VKExhriwROlAjFE7YD3FxTA6CFpG80I7MBWdHw2RFQ6MPMK9AP6tB8eoFjjtVXcpwxntGiq995k5WVtg_7PNsrhToO7kcyGsjqtQ8yYsD4kKHSFVTG_6fC86DCZOGTRR6MVocBqIfg0hoU_0pBKWQ-GBcl10KH3aQAJV5ku9BFDaHxpGqfEgXb85eG" />
            </div>
            <div class="avatar-option aspect-square bg-primary/20 rounded-lg flex items-center justify-center border-2 border-transparent cursor-pointer transition-all" data-avatar-url="https://lh3.googleusercontent.com/aida-public/AB6AXuD1-IRdijy5eIYxAJ8uLTiddsEQK3MJwU5C_RvIxbDB9hNknG2wwTYDShf_fTx_J4zhN90tO-xtflTqR4QukN-Vw09rmrUe_2RUryc74DsE84MJcvzOVP7mu52BaYchp6OI0cYIZO0-kIwmZfI85sAot-g-CrAR9eLRT-2anb-SRe86Cj1sCqJSbiRWOpOJDLWbrm4MCVXxMP31_p3E3B3vIzqAuquxMz-f3s_XKhmHY7ekL2tWx0qoM3JDAe__2XXs0iCCaRrAJ0yE">
              <img class="w-full h-full object-cover rounded-lg" alt="Avatar de um homem com barba e cabelo claro." src="https://lh3.googleusercontent.com/aida-public/AB6AXuD1-IRdijy5eIYxAJ8uLTiddsEQK3MJwU5C_RvIxbDB9hNknG2wwTYDShf_fTx_J4zhN90tO-xtflTqR4QukN-Vw09rmrUe_2RUryc74DsE84MJcvzOVP7mu52BaYchp6OI0cYIZO0-kIwmZfI85sAot-g-CrAR9eLRT-2anb-SRe86Cj1sCqJSbiRWOpOJDLWbrm4MCVXxMP31_p3E3B3vIzqAuquxMz-f3s_XKhmHY7ekL2tWx0qoM3JDAe__2XXs0iCCaRrAJ0yE" />
            </div>
            <div class="avatar-option aspect-square bg-primary/20 rounded-lg flex items-center justify-center border-2 border-transparent cursor-pointer transition-all" data-avatar-url="https://lh3.googleusercontent.com/aida-public/AB6AXuCwJvAfIhox0DQ7co5wKoPWq0KzXMm51LJPD_1nNcjur8TKp2PPRLlgHNdSdPSdSaq6X6P0n8syWafh4hKCORvoUMXl1dBJHiV0mSjoL7xSGkhY2gRcWPX2y-AIh0pWYCfQPYWl0CqjgTNtl88r-pfB12qjAECTYmw3rnbUwQC4WjY8qnOqWd80zLeT-2I66Y5nRV9yCZNjaCpzE4zvqgDL3gHyjcCVPAyo2qIfLwD-NY6aajvPCgnr_G8w03U2yDgYPlSvZVMcsKgY">
              <img class="w-full h-full object-cover rounded-lg" alt="Avatar de uma mulher com sardas e cabelo castanho." src="https://lh3.googleusercontent.com/aida-public/AB6AXuCwJvAfIhox0DQ7co5wKoPWq0KzXMm51LJPD_1nNcjur8TKp2PPRLlgHNdSdPSdSaq6X6P0n8syWafh4hKCORvoUMXl1dBJHiV0mSjoL7xSGkhY2gRcWPX2y-AIh0pWYCfQPYWl0CqjgTNtl88r-pfB12qjAECTYmw3rnbUwQC4WjY8qnOqWd80zLeT-2I66Y5nRV9yCZNjaCpzE4zvqgDL3gHyjcCVPAyo2qIfLwD-NY6aajvPCgnr_G8w03U2yDgYPlSvZVMcsKgY" />
            </div>
            <div class="avatar-option aspect-square bg-primary/20 rounded-lg flex items-center justify-center border-2 border-transparent cursor-pointer transition-all" data-avatar-url="https://lh3.googleusercontent.com/aida-public/AB6AXuCaowuyHYeVV7QLQqkErji5qLb-CvJFR_rMYtZL7M6YLr1_O81-xKH-NNRhUm420Z8-FlXfIjQJmh8Xsq7ZKS2zyPFvLqGKvJSn_qgtwm71_5hCGdwD8ZRu9nvr2r93N39r1md_0C_ux1921h8wuWOD-OqZYoIL1nP4laPvRN0A-fQBRFxRr-Mz1J_7qnacmNgqF2h_srHsnmNr6kqETAh9l9wSS0FzA8na_BvHMxHN8E7E6wj-4ZIiXEsZ5ulR7MCUFhJcjDMfdJT5">
              <img class="w-full h-full object-cover rounded-lg" alt="Avatar de um homem sorrindo com cabelo escuro." src="https://lh3.googleusercontent.com/aida-public/AB6AXuCaowuyHYeVV7QLQqkErji5qLb-CvJFR_rMYtZL7M6YLr1_O81-xKH-NNRhUm420Z8-FlXfIjQJmh8Xsq7ZKS2zyPFvLqGKvJSn_qgtwm71_5hCGdwD8ZRu9nvr2r93N39r1md_0C_ux1921h8wuWOD-OqZYoIL1nP4laPvRN0A-fQBRFxRr-Mz1J_7qnacmNgqF2h_srHsnmNr6kqETAh9l9wSS0FzA8na_BvHMxHN8E7E6wj-4ZIiXEsZ5ulR7MCUFhJcjDMfdJT5" />
            </div>
          </div>
        </section>
      </main>
      <!-- Footer with Action Button -->
      <footer class="sticky bottom-0 bg-background-light dark:bg-background-dark p-4 pt-6">
        <button id="reg-next-btn" class="flex w-full items-center justify-center rounded-xl bg-primary h-14 text-background-dark text-lg font-bold">
          Próximo
        </button>
      </footer>
    </div>

    <!-- Tela 3: Login (Acessar Personagem) -->
    <div id="screen-login" class="hidden relative flex h-auto min-h-screen w-full flex-col items-center bg-background-light dark:bg-background-dark group/design-root overflow-x-hidden p-4">
      <button id="login-back-btn" class="text-white flex size-12 shrink-0 items-center justify-center cursor-pointer absolute top-4 left-4 z-10">
        <span class="material-symbols-outlined text-3xl">arrow_back</span>
      </button>
      <div class="flex w-full max-w-md flex-col items-center justify-center pt-20 pb-8">
        <svg class="h-20 w-20 text-primary" fill="none" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" fill="currentColor"></path>
        </svg>
        <h1 class="text-white text-2xl font-bold leading-tight text-center tracking-wider mt-4">RPG DA VIDA REAL</h1>
      </div>
      <div class="w-full max-w-md">
        <h1 class="text-white tracking-light text-[32px] font-bold leading-tight px-4 text-center pb-8 pt-6">Acessar seu Personagem</h1>
        <div class="flex w-full flex-col gap-4 px-4 py-3">
          <label class="flex flex-col w-full flex-1">
            <p class="text-white text-base font-medium leading-normal pb-2">Email</p>
            <div class="flex w-full flex-1 items-stretch rounded-xl border border-[#3b5445] bg-[#1c2720] focus-within:ring-2 focus-within:ring-primary focus-within:border-primary">
              <div class="text-[#9db9a8] flex items-center justify-center pl-[15px]">
                <span class="material-symbols-outlined">person</span>
              </div>
              <input id="login-email" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden text-white focus:outline-0 focus:ring-0 border-0 bg-transparent h-14 placeholder:text-[#9db9a8] p-[15px] text-base font-normal leading-normal" placeholder="Digite seu email" value="" />
            </div>
          </label>
        </div>
        <div class="flex w-full flex-col gap-4 px-4 py-3">
          <label class="flex flex-col w-full flex-1">
            <p class="text-white text-base font-medium leading-normal pb-2">Senha</p>
            <div class="flex w-full flex-1 items-stretch rounded-xl border border-[#3b5445] bg-[#1c2720] focus-within:ring-2 focus-within:ring-primary focus-within:border-primary">
              <div class="text-[#9db9a8] flex items-center justify-center pl-[15px]">
                <span class="material-symbols-outlined">lock</span>
              </div>
              <input id="login-password" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden text-white focus:outline-0 focus:ring-0 border-0 bg-transparent h-14 placeholder:text-[#9db9a8] p-[15px] text-base font-normal leading-normal" placeholder="Digite sua senha" type="password" value="" />
              <button class="text-[#9db9a8] flex items-center justify-center pr-[15px] bg-transparent border-0" onclick="togglePasswordVisibility('login-password', this)">
                <span class="material-symbols-outlined">visibility</span>
              </button>
            </div>
          </label>
        </div>
        <div class="flex px-4 py-6">
          <button id="login-btn" class="flex min-w-[84px] w-full cursor-pointer items-center justify-center overflow-hidden rounded-full h-12 px-5 flex-1 bg-primary text-[#111814] text-base font-bold leading-normal tracking-[0.015em] hover:bg-opacity-90 transition-opacity">
            <span class="truncate">[ Entrar ]</span>
          </button>
        </div>
        <p id="login-forgot-link" class="text-[#9db9a8] text-sm font-normal leading-normal pb-3 pt-1 px-4 text-center underline cursor-pointer hover:text-primary transition-colors">Perdeu o mapa? (Esqueci a senha)</p>
      </div>
    </div>

    <!-- Tela 4: Recuperação de Senha -->
    <div id="screen-forgot-password" class="hidden relative flex min-h-screen w-full flex-col antialiased">
      <main class="flex flex-1 flex-col">
        <div class="flex items-center p-4">
          <button id="forgot-back-btn" class="text-white flex size-12 shrink-0 items-center justify-start cursor-pointer">
            <span class="material-symbols-outlined text-3xl text-slate-300 dark:text-slate-400">arrow_back</span>
          </button>
          <h1 class="flex-1 text-center text-lg font-bold leading-tight tracking-[-0.015em] text-slate-800 dark:text-white -ml-12">Recuperação de Aventura</h1>
        </div>
        <div class="flex flex-1 flex-col justify-center px-4">
          <div class="flex flex-col items-center">
            <p class="text-center text-base font-normal leading-normal text-slate-600 dark:text-slate-300">Enviaremos um 'Pergaminho de Recuperação' para seu email.</p>
          </div>
          <div class="mt-8 mb-4 flex w-full max-w-[480px] flex-col self-center">
            <label class="flex w-full flex-col">
              <p class="pb-2 text-base font-medium leading-normal text-slate-800 dark:text-white">Seu Email</p>
              <div class="relative flex w-full flex-1 items-stretch">
                <input id="forgot-email" class="form-input flex h-14 w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg border border-slate-300/70 bg-background-light p-4 pr-12 text-base font-normal leading-normal text-slate-900 placeholder:text-slate-400 focus:border-primary/80 focus:outline-none focus:ring-2 focus:ring-primary/40 dark:border-slate-700 dark:bg-background-dark dark:text-white dark:placeholder:text-slate-500 dark:focus:border-primary" placeholder="seu-heroi@email.com" value="" />
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center justify-center pr-4 text-slate-400 dark:text-slate-500">
                  <span class="material-symbols-outlined">mail</span>
                </div>
              </div>
            </label>
          </div>
          <div class="mt-4 flex w-full max-w-[480px] self-center">
            <button id="forgot-btn" class="flex h-12 min-w-[84px] flex-1 cursor-pointer items-center justify-center overflow-hidden rounded-full bg-primary px-5 text-base font-bold leading-normal tracking-[0.015em] text-slate-900 transition-colors hover:bg-primary/90">
              <span class="truncate">Enviar Pergaminho de Recuperação</span>
            </button>
          </div>
          <div class="mt-2 flex w-full max-w-[480px] justify-center self-center">
            <button id="forgot-cancel-btn" class="flex h-10 min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-full bg-transparent px-4 text-sm font-bold leading-normal tracking-[0.015em] text-slate-500 transition-colors hover:bg-slate-500/10 dark:text-slate-400 dark:hover:bg-slate-400/10">
              <span class="truncate">Cancelar</span>
            </button>
          </div>
        </div>
      </main>
    </div>

    <!-- Tela 5: Dashboard (Logado) - NOVO DESIGN -->
    <div id="screen-dashboard" class="hidden relative flex min-h-screen w-full flex-col overflow-x-hidden">
      <!-- Background -->
      <div class="absolute inset-0 z-0">
        <div class="h-full w-full bg-center bg-no-repeat bg-cover opacity-10" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuD6sSjEhz7hgGMCO9BdTp0pHGvGbE3XMpV6jPLsVzsYPwCqNXpNCbXwpEujggDvZYrE9pQH3Y5d5BVF7gvg7jPZ0AXCp2Nwx2A7FFDzew_5BcOaQSLjVdbARuQ92QAHPYPKFF8zuiCOXoXUsMSviMA_KKbTiUtBIpnFlJBm280neUs4DCq_Bfit7g90h0YuQrldqBiXPliiGMqqxXfOBfNx_NLz-YaO63IyoVmNdwY8nkPEARovFkiWn0qj-T5XhZjUWMi1i1P7O7tL_");'></div>
      </div>
      <!-- Conteúdo do Hub -->
      <div class="relative z-10 flex w-full grow flex-col pb-24">
        <!-- Header -->
        <header class="flex items-center justify-between p-4">
          <div class="flex items-center gap-3">
            <img id="hub-avatar" alt="Avatar do Aventureiro" class="h-12 w-12 rounded-full border-2 border-primary" src="https://placehold.co/100x100/1a3828/13ec6d?text=?" />
            <div>
              <h1 id="hub-nickname" class="text-xl font-bold">Carregando...</h1>
              <p id="hub-level-title" class="text-sm text-text-dark-secondary">
                <span id="hub-level">Nv. 1</span>
              </p>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <button class="flex h-10 w-10 items-center justify-center rounded-full bg-surface-dark/80 backdrop-blur-sm">
              <span class="material-symbols-outlined text-text-dark-secondary">leaderboard</span>
            </button>
            <button class="flex h-10 w-10 items-center justify-center rounded-full bg-surface-dark/80 backdrop-blur-sm">
              <span class="material-symbols-outlined text-text-dark-secondary">notifications</span>
            </button>
          </div>
        </header>

        <!-- Barras de Status -->
        <section class="px-4 py-2">
          <div class="flex flex-col gap-2.5 rounded-lg bg-surface-dark/50 p-4 backdrop-blur-sm border border-border-dark">
            <!-- HP -->
            <div class="flex items-center gap-2">
              <span class="material-symbols-outlined text-health text-lg">favorite</span>
              <div class="h-2.5 w-full flex-1 rounded-full bg-background-dark">
                <div id="hub-hp-bar" class="h-2.5 rounded-full bg-health" style="width: 100%"></div>
              </div>
              <span id="hub-hp-text" class="text-sm font-semibold text-text-dark-secondary">100/100</span>
            </div>
            <!-- Mana -->
            <div class="flex items-center gap-2">
              <span class="material-symbols-outlined text-mana text-lg">bolt</span>
              <div class="h-2.5 w-full flex-1 rounded-full bg-background-dark">
                <div id="hub-mana-bar" class="h-2.5 rounded-full bg-mana" style="width: 100%"></div>
              </div>
              <span id="hub-mana-text" class="text-sm font-semibold text-text-dark-secondary">100/100</span>
            </div>
            <!-- XP -->
            <div class="flex items-center gap-2">
              <span class="material-symbols-outlined text-xp text-lg">star</span>
              <div class="h-2.5 w-full flex-1 rounded-full bg-background-dark">
                <div id="hub-xp-bar" class="h-2.5 rounded-full bg-xp" style="width: 0%"></div>
              </div>
              <span id="hub-xp-text" class="text-sm font-semibold text-text-dark-secondary">0/1000</span>
            </div>
          </div>
        </section>

        <!-- Atributos e Status -->
        <section class="grid grid-cols-2 gap-4 px-4 py-2">
          <!-- Atributos -->
          <div class="flex flex-col gap-2 rounded-lg bg-surface-dark/50 p-4 backdrop-blur-sm border border-border-dark">
            <h2 class="text-base font-bold text-primary">Atributos</h2>
            <div id="hub-stats-forca" class="flex items-center gap-2 text-sm">
              <span class="material-symbols-outlined text-red-400 text-base">swords</span>
              <span>Força: 1</span>
            </div>
            <div id="hub-stats-inteligencia" class="flex items-center gap-2 text-sm">
              <span class="material-symbols-outlined text-blue-400 text-base">school</span>
              <span>Inteligência: 1</span>
            </div>
            <div id="hub-stats-vitalidade" class="flex items-center gap-2 text-sm">
              <span class="material-symbols-outlined text-green-400 text-base">shield</span>
              <span>Vitalidade: 1</span>
            </div>
            <div id="hub-stats-velocidade" class="flex items-center gap-2 text-sm">
              <span class="material-symbols-outlined text-yellow-400 text-base">sprint</span>
              <span>Velocidade: 1</span>
            </div>
          </div>
          <!-- Status Atuais -->
          <div class="flex flex-col gap-2 rounded-lg bg-surface-dark/50 p-4 backdrop-blur-sm border border-border-dark">
            <h2 class="text-base font-bold text-primary">Status Atuais</h2>
            <div id="hub-status-effects" class="flex flex-col gap-2">
              <!-- Status são inseridos dinamicamente aqui -->
              <p class="text-sm text-text-dark-secondary">Nenhum efeito ativo.</p>
            </div>
          </div>
        </section>

        <!-- Registro de Missões -->
        <section class="flex flex-col gap-3 px-4 py-2">
          <h2 class="text-lg font-bold">Registro de Missões</h2>
          <div id="hub-mission-list" class="flex flex-col gap-3">
            <!-- Missões são inseridas dinamicamente aqui -->
            <p class="text-sm text-text-dark-secondary p-4">Nenhuma missão encontrada. Adicione uma nova!</p>
          </div>
        </section>
      </div>

      <!-- Botão Adicionar Missão -->
      <div class="fixed bottom-24 right-4 z-20">
        <button id="btn-show-add-task" class="flex h-16 w-16 items-center justify-center rounded-full bg-primary text-background-dark shadow-lg shadow-primary/30">
          <span class="material-symbols-outlined text-4xl">add</span>
        </button>
      </div>

      <!-- Navegação Principal -->
      <nav class="fixed bottom-0 left-0 right-0 z-20 border-t border-border-dark bg-surface-dark/80 backdrop-blur-lg">
        <div class="mx-auto flex h-20 max-w-md items-center justify-around px-4">
          <a classa="flex flex-col items-center gap-1 text-primary" href="#">
            <span class="material-symbols-outlined">home</span>
            <span class="text-xs font-bold">Início</span>
          </a>
          <a class="flex flex-col items-center gap-1 text-text-dark-secondary" href="#">
            <span class="material-symbols-outlined">shield_person</span>
            <span class="text-xs">Personagem</span>
          </a>
          <a class="flex flex-col items-center gap-1 text-text-dark-secondary" href="#">
            <span class="material-symbols-outlined">swords</span>
            <span class="text-xs">Guilda</span>
          </a>
          <a class="flex flex-col items-center gap-1 text-text-dark-secondary" href="#">
            <span class="material-symbols-outlined">store</span>
            <span class="text-xs">Mercado</span>
          </a>
          <a id="hub-logout-btn" class="flex flex-col items-center gap-1 text-text-dark-secondary cursor-pointer" href="#">
            <span class="material-symbols-outlined">settings</span>
            <span class="text-xs">Opções</span>
          </a>
        </div>
      </nav>
    </div>

    <!-- Tela 6: Criar Nova Tarefa (IA) -->
    <div id="screen-add-task" class="hidden relative flex min-h-screen w-full flex-col bg-background-dark">
      <!-- Header -->
      <div class="flex items-center bg-background-dark p-4 pb-2 justify-between sticky top-0 z-10">
        <button id="task-back-btn" class="text-white flex size-12 shrink-0 items-center justify-center cursor-pointer">
          <span class="material-symbols-outlined text-3xl">arrow_back</span>
        </button>
        <h2 class="text-white text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center pr-12">Criar Nova Missão</h2>
      </div>

      <!-- Formulário -->
      <main class="flex-grow p-4 space-y-6">
        <!-- Título -->
        <label class="flex flex-col w-full">
          <p class="text-white text-base font-medium leading-normal pb-2">Título da Missão</p>
          <input id="task-title" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-white focus:outline-0 focus:ring-0 border border-primary/30 bg-[#1C2720] focus:border-primary h-14 placeholder:text-white/40 p-[15px] text-base font-normal leading-normal" placeholder="Ex: Correr 30 min na esteira" value="" />
        </label>
        
        <!-- Tipo de Missão -->
        <div>
           <p class="text-white text-base font-medium leading-normal pb-2">Tipo de Missão (Sua escolha)</p>
           <div id="task-type-group" class="grid grid-cols-3 gap-3">
               <button data-type="habito" class="task-type-btn flex items-center justify-center rounded-lg border-2 border-border-dark bg-surface-dark/50 p-4 font-bold text-text-dark-secondary transition-all">
                 <span class="material-symbols-outlined mr-2">menu_book</span> Hábito
               </button>
               <button data-type="diaria" class="task-type-btn flex items-center justify-center rounded-lg border-2 border-border-dark bg-surface-dark/50 p-4 font-bold text-text-dark-secondary transition-all">
                 <span class="material-symbols-outlined mr-2">fitness_center</span> Diária
               </button>
               <button data-type="projeto" class="task-type-btn flex items-center justify-center rounded-lg border-2 border-border-dark bg-surface-dark/50 p-4 font-bold text-text-dark-secondary transition-all">
                 <span class="material-symbols-outlined mr-2">work</span> Projeto
               </button>
           </div>
        </div>

        <!-- Prioridade da Missão -->
        <div>
           <p class="text-white text-base font-medium leading-normal pb-2">Tipo de Missão (Sua Prioridade)</p>
           <div id="task-priority-group" class="grid grid-cols-3 gap-3">
               <button data-priority="secundaria" class="task-priority-btn flex items-center justify-center rounded-lg border-2 border-border-dark bg-surface-dark/50 p-4 font-bold text-text-dark-secondary transition-all">
                 Secundária
               </button>
               <button data-priority="contrato" class="task-priority-btn flex items-center justify-center rounded-lg border-2 border-border-dark bg-surface-dark/50 p-4 font-bold text-text-dark-secondary transition-all">
                 Contrato
               </button>
               <button data-priority="principal" class="task-priority-btn flex items-center justify-center rounded-lg border-2 border-border-dark bg-surface-dark/50 p-4 font-bold text-text-dark-secondary transition-all">
                 Principal
               </button>
           </div>
        </div>

        <!-- Duração (Opcional) -->
        <div>
            <p class="text-white/70 text-base font-medium leading-normal pb-2">Duração Estimada (Opcional)</p>
            <div class="grid grid-cols-2 gap-4">
                <label class="flex flex-col w-full">
                    <p class="text-white/70 text-sm pb-1">Horas</p>
                    <input id="task-duration-hours" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-white focus:outline-0 focus:ring-0 border border-primary/30 bg-[#1C2720] focus:border-primary h-14 placeholder:text-white/40 p-[15px] text-base font-normal leading-normal" type="number" min="0" placeholder="0" />
                </label>
                <label class="flex flex-col w-full">
                    <p class="text-white/70 text-sm pb-1">Minutos</p>
                    <input id="task-duration-minutes" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-white focus:outline-0 focus:ring-0 border border-primary/30 bg-[#1C2720] focus:border-primary h-14 placeholder:text-white/40 p-[15px] text-base font-normal leading-normal" type="number" min="0" max="59" placeholder="30" />
                </label>
            </div>
        </div>

        <!-- Prazos e Recorrência (Opcional) -->
        <div class="grid grid-cols-2 gap-4">
            <label class="flex flex-col w-full">
              <p class="text-white/70 text-base font-medium leading-normal pb-2">Prazo Final (Opcional)</p>
              <input id="task-deadline" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-white focus:outline-0 focus:ring-0 border border-primary/30 bg-[#1C2720] focus:border-primary h-14 placeholder:text-white/40 p-[15px] text-base font-normal leading-normal" type="date" />
            </label>
            <button id="btn-open-recurrence" class="flex items-center justify-center rounded-xl border-2 border-dashed border-border-dark bg-surface-dark/30 h-14 text-text-dark-secondary hover:border-primary transition-colors">
              <span class="material-symbols-outlined mr-2">event_repeat</span>
              Definir Recorrência
            </button>
        </div>
        <p id="recurrence-summary" class="text-center text-sm text-primary -mt-2 mb-2"></p>

        <!-- Notas / Anexos -->
        <div>
            <p class="text-white/70 text-base font-medium leading-normal pb-2">Notas / Anexos (Opcional)</p>
            <textarea id="task-notes" class="form-textarea flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-white focus:outline-0 focus:ring-0 border border-primary/30 bg-[#1C2720] focus:border-primary placeholder:text-white/40 p-[15px] text-base font-normal leading-normal mb-2" placeholder="Adicione links, lembretes ou qualquer contexto adicional aqui..." rows="3"></textarea>
            <input type="file" id="task-attachment-input" class="hidden" />
            <button id="btn-add-attachment" class="flex w-full items-center justify-center rounded-lg border-2 border-dashed border-border-dark bg-surface-dark/30 h-12 text-text-dark-secondary hover:border-primary transition-colors">
              <span class="material-symbols-outlined mr-2">attach_file</span>
              Adicionar Anexo
            </button>
            <p id="attachment-name" class="text-sm text-primary text-center mt-2"></p>
        </div>

        <!-- Sub-tarefas (Checklist) -->
        <div>
            <p class="text-white text-base font-medium leading-normal pb-2">Sub-tarefas (Checklist)</p>
            <div class="flex gap-2">
                <input id="task-subtask-input" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-white focus:outline-0 focus:ring-0 border border-primary/30 bg-[#1C2720] focus:border-primary h-14 placeholder:text-white/40 p-[15px] text-base font-normal leading-normal" placeholder="Ex: Pesquisar referências" value="" />
                <button id="task-add-subtask-btn" class="flex items-center justify-center rounded-xl bg-primary/20 h-14 w-14 text-primary text-2xl font-bold">
                    +
                </button>
            </div>
            <div id="task-subtask-list" class="mt-3 space-y-2">
                <!-- Sub-tarefas adicionadas aparecerão aqui -->
            </div>
        </div>

        <!-- Estimativa de Recompensa (IA) -->
        <div>
          <p class="text-white text-base font-medium leading-normal pb-2">Análise da Missão (IA)</p>
          <div class="rounded-lg bg-surface-dark/50 p-4 backdrop-blur-sm border border-border-dark min-h-[160px] flex items-center justify-center">

            <!-- Estado Inicial/Carregando -->
            <div id="reward-loading" class="text-center text-text-dark-secondary">
              <div id="reward-spinner" class="hidden animate-spin w-6 h-6 border-2 border-primary border-t-transparent rounded-full mx-auto mb-3"></div>
              <p id="reward-loading-text">Digite sua missão para calcularmos a recompensa...</p>
            </div>

            <!-- Resultados da IA -->
            <div id="reward-results" class="hidden w-full space-y-2">
                <div class="flex justify-between items-center">
                    <span class="font-bold text-primary">Atributo:</span>
                    <span id="reward-attribute" class="font-bold uppercase"></span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="font-bold text-primary">Dificuldade:</span>
                    <span id="reward-difficulty" class="font-bold uppercase"></span>
                </div>
                <hr class="border-border-dark my-2" />
                <div class="flex justify-between items-center text-xp">
                    <span class="font-bold">XP Global:</span>
                    <span id="reward-xp-global" class="font-bold"></span>
                </div>
                <div class="flex justify-between items-center text-xp">
                    <span id="reward-xp-attribute-label" class="font-bold">XP de Atributo:</span>
                    <span id="reward-xp-attribute" class="font-bold"></span>
                </div>
                <div class="flex justify-between items-center text-yellow-400">
                    <span class="font-bold">Moedas:</span>
                    <span id="reward-coins" class="font-bold"></span>
                </div>
            </div>

          </div>
        </div>
      </main>

      <!-- Footer com Botão Salvar -->
      <footer class="sticky bottom-0 bg-background-dark p-4 pt-6">
        <button id="task-save-btn" class="flex w-full items-center justify-center rounded-xl bg-primary h-14 text-background-dark text-lg font-bold">
          Salvar Missão
        </button>
      </footer>
    </div>

    <!-- Tela 7: Detalhes da Missão (NOVA TELA) -->
    <div id="screen-mission-details" class="hidden relative flex min-h-screen w-full flex-col bg-background-dark pb-24">
        <!-- Header -->
        <header class="flex items-center p-4 pb-2 justify-between sticky top-0 bg-background-dark z-10">
            <button id="details-back-btn" class="text-white flex size-12 shrink-0 items-center justify-center">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h1 id="details-mission-title" class="text-white text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center">Carregando Missão...</h1>
            <div class="flex size-12 shrink-0 items-center justify-center">
                <button id="details-edit-btn" class="flex shrink-0 items-center justify-center rounded-full size-12 text-white">
                    <span class="material-symbols-outlined">edit_note</span>
                </button>
            </div>
        </header>

        <!-- Animação/Video Container -->
        <div class="p-4">
            <div id="mission-animation-container" class="relative flex items-center justify-center bg-surface-dark/50 aspect-video rounded-lg p-4 border border-border-dark">
                <!-- Conteúdo da animação (genérica ou vídeo) será inserido aqui -->
                <p class="text-text-dark-secondary">Animação da missão aparecerá aqui.</p>
            </div>
        </div>

        <!-- Timers -->
        <div id="mission-timers-container" class="flex flex-col items-center justify-center px-4 pb-3">
             <p class="text-sm text-text-dark-secondary">Tempo da Sessão Atual</p>
             <p id="session-timer" class="text-4xl font-bold text-white">00:00:00</p>
             <p id="total-timer" class="text-sm text-primary">Tempo Total Acumulado: 00:00:00</p>
        </div>

        <!-- Controles de Estado -->
        <div id="mission-controls-container" class="flex gap-3 flex-wrap px-4 py-3 justify-between">
            <!-- Botões de controle serão inseridos dinamicamente aqui -->
        </div>

        <!-- Diário de Bordo (Sub-tarefas) -->
        <div class="flex justify-between items-center px-4 pb-3 pt-5">
            <h2 class="text-white text-[22px] font-bold leading-tight tracking-[-0.015em]">Diário de Bordo da Missão</h2>
            <button id="details-history-btn" class="inline-flex items-center gap-2 text-primary text-sm">
                <span class="material-symbols-outlined !text-xl">history</span>
                <span>Histórico</span>
            </button>
        </div>
        <div class="px-4 pb-4">
            <div id="mission-sub-task-list" class="flex flex-col divide-y divide-border-dark">
                <!-- Sub-tarefas serão inseridas aqui -->
                <p class="text-sm text-text-dark-secondary py-4">Nenhuma sub-tarefa definida.</p>
            </div>
        </div>

        <!-- Progresso e Recompensas -->
        <h2 class="text-white text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">Progresso e Recompensas</h2>
        <div id="mission-rewards-container" class="px-4">
            <div class="flex flex-col gap-4 rounded-lg bg-surface-dark/50 p-4 border border-border-dark">
                 <!-- Recompensas serão preenchidas aqui -->
            </div>
        </div>

        <!-- Botão Flutuante para Adicionar Sub-tarefa -->
        <div class="fixed bottom-6 right-6 z-20">
            <button id="details-add-subtask-btn" class="flex items-center justify-center gap-2 h-14 pl-5 pr-6 rounded-full bg-primary text-background-dark shadow-lg shadow-primary/30">
                <span class="material-symbols-outlined !text-2xl">post_add</span>
                <span class="font-bold text-base">Nova Subtarefa</span>
            </button>
        </div>
    </div>


  </div>

  <!-- Modal de Mensagem/Erro -->
  <div id="modal-message" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
    <div class="bg-[#1C2720] border border-primary/50 rounded-lg p-6 w-full max-w-sm text-center">
      <h3 id="modal-title" class="text-primary text-xl font-bold mb-3"></h3>
      <p id="modal-body" class="text-white/90 mb-6"></p>
      <button id="modal-close-btn" class="flex min-w-[84px] w-full cursor-pointer items-center justify-center overflow-hidden rounded-full h-12 px-5 bg-primary text-[#111814] text-base font-bold">
        Entendido
      </button>
    </div>
  </div>

  <!-- Modal de Recorrência -->
  <div id="modal-recurrence" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
    <div class="bg-[#1C2720] border border-primary/50 rounded-lg p-6 w-full max-w-sm">
      <h3 class="text-primary text-xl font-bold mb-4">Definir Recorrência</h3>

      <!-- Opção 1: A cada X dias -->
      <div class="space-y-2">
          <label class="text-white/90">Repetir a cada:</label>
          <div class="flex items-center gap-2">
              <input id="recurrence-days-input" type="number" min="1" class="form-input w-20 bg-[#102218] border-border-dark rounded" placeholder="1">
              <span class="text-white/90">dias</span>
          </div>
      </div>

      <div class="my-4 text-center text-text-dark-secondary">ou</div>

      <!-- Opção 2: Dias da Semana -->
      <div class="space-y-2">
          <label class="text-white/90">Repetir nos dias:</label>
          <div id="recurrence-weekdays" class="grid grid-cols-4 gap-2 text-center">
              <button data-day="1" class="weekday-btn p-2 rounded border border-border-dark">Seg</button>
              <button data-day="2" class="weekday-btn p-2 rounded border border-border-dark">Ter</button>
              <button data-day="3" class="weekday-btn p-2 rounded border border-border-dark">Qua</button>
              <button data-day="4" class="weekday-btn p-2 rounded border border-border-dark">Qui</button>
              <button data-day="5" class="weekday-btn p-2 rounded border border-border-dark">Sex</button>
              <button data-day="6" class="weekday-btn p-2 rounded border border-border-dark">Sáb</button>
              <button data-day="0" class="weekday-btn p-2 rounded border border-border-dark">Dom</button>
          </div>
      </div>

      <div class="mt-6 flex justify-end gap-3">
        <button id="recurrence-cancel-btn" class="px-4 py-2 rounded bg-surface-dark/50 text-white/80">Cancelar</button>
        <button id="recurrence-save-btn" class="px-4 py-2 rounded bg-primary text-background-dark font-bold">Salvar</button>
      </div>
    </div>
  </div>

  <!-- Modal de Histórico (Diário de Bordo) -->
  <div id="modal-history" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
    <div class="bg-[#1C2720] border border-primary/50 rounded-lg p-6 w-full max-w-sm text-left">
      <h3 class="text-primary text-xl font-bold mb-4 flex items-center gap-2"><span class="material-symbols-outlined">history</span> Diário de Bordo</h3>
      <div id="history-log-content" class="text-white/90 mb-6 space-y-2 max-h-[60vh] overflow-y-auto">
        <!-- Conteúdo do log será inserido aqui -->
      </div>
      <button id="history-close-btn" class="flex min-w-[84px] w-full cursor-pointer items-center justify-center overflow-hidden rounded-full h-12 px-5 bg-primary text-[#111814] text-base font-bold">
        Fechar
      </button>
    </div>
  </div>


  <!-- Firebase SDKs -->
  <script type="module">
    // Importações do Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth,
      signInAnonymously,
      signInWithCustomToken,
      onAuthStateChanged,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      sendPasswordResetEmail,
      GoogleAuthProvider,
      signInWithPopup,
      signOut,
      updateProfile
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      getDoc,
      updateDoc,
      onSnapshot,
      collection,
      addDoc,
      setLogLevel,
      Timestamp,
      writeBatch,
      query,
      orderBy,
      getDocs
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import {
        getStorage,
        ref,
        uploadBytes,
        getDownloadURL
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    // --- Exibe o Domínio para Autorização no Firebase ---
    const currentHostname = window.location.hostname;
    console.warn('--- DOMÍNIO PARA AUTORIZAR NO FIREBASE ---');
    console.warn('Para o Login com Google funcionar, adicione este domínio à sua lista de "Domínios autorizados" no Firebase Auth -> Configurações:');
    console.warn(currentHostname);
    console.warn('----------------------------------------------');

    // --- Configuração do Firebase ---
    // Configuração fornecida pelo usuário
    const firebaseConfigUser = {
      apiKey: "AIzaSyBeLq53I4Zu8TIcttgYwcyhFUBu4uneCxQ",
      authDomain: "rpglife-8f33d.firebaseapp.com",
      projectId: "rpglife-8f33d",
      storageBucket: "rpglife-8f33d.firebasestorage.app",
      messagingSenderId: "428052124083",
      appId: "1:428052124083:web:1190108bd19638ad2bfbc6",
      measurementId: "G-5LCK5W2JNH"
    };

    // Configuração do Canvas (obrigatória)
    const firebaseConfig = typeof __firebase_config !== 'undefined'
      ? JSON.parse(__firebase_config)
      : firebaseConfigUser;

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'rpglife-app';

    // Inicialização do Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app); // <-- ADICIONADO
    setLogLevel('Debug'); // Para logs detalhados no console

    // --- Variáveis de Estado Global ---
    let currentUserId = null;
    let profileListener = null; // Para o listener do onSnapshot do perfil
    let tasksListener = null; // Para o listener do onSnapshot das tarefas
    let currentRegistrationStep = 1;
    let selectedAvatarUrl = null;

    // --- Variáveis da Tela de Tarefas ---
    let selectedTaskType = null;
    let selectedTaskPriority = 'contrato';
    let recurrenceRule = null;
    let attachmentFile = null; // Para armazenar o arquivo do anexo
    let subtasksList = [];
    let aiResults = null;
    let calculatedRewards = null;
    let debounceTimer = null;

    // --- Variáveis da Tela de Detalhes da Missão ---
    let activeMission = {
        id: null,
        data: null,
        timerInterval: null,
        totalTimeInterval: null,
        sessionSeconds: 0
    };

    // --- Tabelas Base de Recompensa (Conforme GDD) ---
    const REWARDS_DIFFICULTY = {
        FACIL: { xp_attr: 10 },
        MEDIA: { xp_attr: 25 },
        DIFICIL: { xp_attr: 50 }
    };
    const REWARDS_TYPE = {
        habito:  { xp_global: 5,  moedas: 5 },
        diaria:  { xp_global: 15, moedas: 10 },
        projeto: { xp_global: 75, moedas: 50 }
    };

    // --- Seletores de Elementos ---
    const screens = {
      splash: document.getElementById('screen-splash'),
      register: document.getElementById('screen-register'),
      login: document.getElementById('screen-login'),
      forgot: document.getElementById('screen-forgot-password'),
      dashboard: document.getElementById('screen-dashboard'),
      addTask: document.getElementById('screen-add-task'),
      missionDetails: document.getElementById('screen-mission-details')
    };

    const registerSteps = {
      step1: document.getElementById('step-1'),
      step2: document.getElementById('step-2'),
      step3: document.getElementById('step-3')
    };

    const taskForm = {
        title: document.getElementById('task-title'),
        typeGroup: document.getElementById('task-type-group'),
        typeButtons: document.querySelectorAll('.task-type-btn'),
        priorityGroup: document.getElementById('task-priority-group'),
        priorityButtons: document.querySelectorAll('.task-priority-btn'),
        durationHours: document.getElementById('task-duration-hours'),
        durationMinutes: document.getElementById('task-duration-minutes'),
        deadline: document.getElementById('task-deadline'),
        openRecurrenceBtn: document.getElementById('btn-open-recurrence'),
        recurrenceSummary: document.getElementById('recurrence-summary'),
        notes: document.getElementById('task-notes'),
        addAttachmentBtn: document.getElementById('btn-add-attachment'),
        attachmentInput: document.getElementById('task-attachment-input'),
        attachmentName: document.getElementById('attachment-name'),
        subtaskInput: document.getElementById('task-subtask-input'),
        addSubtaskBtn: document.getElementById('task-add-subtask-btn'),
        subtaskList: document.getElementById('task-subtask-list'),
        saveBtn: document.getElementById('task-save-btn'),
        backBtn: document.getElementById('task-back-btn')
    };

    const rewardBox = {
        loading: document.getElementById('reward-loading'),
        loadingText: document.getElementById('reward-loading-text'),
        spinner: document.getElementById('reward-spinner'),
        results: document.getElementById('reward-results'),
        attribute: document.getElementById('reward-attribute'),
        difficulty: document.getElementById('reward-difficulty'),
        xpGlobal: document.getElementById('reward-xp-global'),
        xpAttribute: document.getElementById('reward-xp-attribute'),
        xpAttributeLabel: document.getElementById('reward-xp-attribute-label'),
        coins: document.getElementById('reward-coins')
    };

    const progressBars = {
      p1: document.getElementById('progress-1'),
      p2: document.getElementById('progress-2'),
      p3: document.getElementById('progress-3')
    };

    const modal = {
      container: document.getElementById('modal-message'),
      title: document.getElementById('modal-title'),
      body: document.getElementById('modal-body'),
      closeBtn: document.getElementById('modal-close-btn')
    };

    const recurrenceModal = {
        container: document.getElementById('modal-recurrence'),
        daysInput: document.getElementById('recurrence-days-input'),
        weekdaysGroup: document.getElementById('recurrence-weekdays'),
        weekdayButtons: document.querySelectorAll('.weekday-btn'),
        saveBtn: document.getElementById('recurrence-save-btn'),
        cancelBtn: document.getElementById('recurrence-cancel-btn')
    };

    const historyModal = {
        container: document.getElementById('modal-history'),
        content: document.getElementById('history-log-content'),
        closeBtn: document.getElementById('history-close-btn')
    };

    // Inputs de Cadastro
    const regInputs = {
      nickname: document.getElementById('reg-nickname'),
      email: document.getElementById('reg-email'),
      password: document.getElementById('reg-password'),
      height: document.getElementById('reg-height'),
      weight: document.getElementById('reg-weight'),
      weightTarget: document.getElementById('reg-weight-target')
    };

    // Inputs de Login
    const loginInputs = {
      email: document.getElementById('login-email'),
      password: document.getElementById('login-password')
    };

    // --- Funções Auxiliares ---
    function showScreen(screenId) {
      console.log(`Navegando para: ${screenId}`);
      Object.values(screens).forEach(screen => screen.classList.add('hidden'));
      if (screens[screenId]) {
        screens[screenId].classList.remove('hidden');
      }
    }

    function showMessage(title, message) {
      modal.title.textContent = title;
      modal.body.textContent = message;
      modal.container.classList.remove('hidden');
    }

    modal.closeBtn.addEventListener('click', () => modal.container.classList.add('hidden'));

    window.togglePasswordVisibility = (inputId, button) => {
      const input = document.getElementById(inputId);
      const icon = button.querySelector('span');
      if (input.type === 'password') {
        input.type = 'text';
        icon.textContent = 'visibility_off';
      } else {
        input.type = 'password';
        icon.textContent = 'visibility';
      }
    }

    function debounce(func, delay) {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(func, delay);
    }

    // --- Lógica de Navegação ---
    document.getElementById('btn-goto-register').addEventListener('click', () => showScreen('register'));
    document.getElementById('btn-goto-login').addEventListener('click', () => showScreen('login'));
    document.getElementById('login-back-btn').addEventListener('click', () => showScreen('splash'));
    document.getElementById('login-forgot-link').addEventListener('click', () => showScreen('forgot'));
    document.getElementById('forgot-back-btn').addEventListener('click', () => showScreen('login'));
    document.getElementById('forgot-cancel-btn').addEventListener('click', () => showScreen('login'));
    document.getElementById('btn-show-add-task').addEventListener('click', () => {
        resetTaskForm();
        showScreen('addTask');
    });
    taskForm.backBtn.addEventListener('click', () => showScreen('dashboard'));


    // --- Lógica de Cadastro (Etapas) ---
    function updateRegistrationStepUI() {
      const nextBtn = document.getElementById('reg-next-btn');
      Object.values(registerSteps).forEach(step => step.classList.add('hidden'));
      progressBars.p1.className = 'h-1 flex-1 rounded-full bg-primary/20';
      progressBars.p2.className = 'h-1 flex-1 rounded-full bg-primary/20';
      progressBars.p3.className = 'h-1 flex-1 rounded-full bg-primary/20';
      if (currentRegistrationStep === 1) {
        registerSteps.step1.classList.remove('hidden');
        progressBars.p1.classList.replace('bg-primary/20', 'bg-primary');
        nextBtn.textContent = 'Próximo';
      } else if (currentRegistrationStep === 2) {
        registerSteps.step2.classList.remove('hidden');
        progressBars.p1.classList.replace('bg-primary/20', 'bg-primary');
        progressBars.p2.classList.replace('bg-primary/20', 'bg-primary');
        nextBtn.textContent = 'Próximo';
      } else if (currentRegistrationStep === 3) {
        registerSteps.step3.classList.remove('hidden');
        progressBars.p1.classList.replace('bg-primary/20', 'bg-primary');
        progressBars.p2.classList.replace('bg-primary/20', 'bg-primary');
        progressBars.p3.classList.replace('bg-primary/20', 'bg-primary');
        nextBtn.textContent = 'Confirmar e Iniciar Jornada!';
      }
    }
    document.getElementById('reg-back-btn').addEventListener('click', () => {
      if (currentRegistrationStep > 1) {
        currentRegistrationStep--;
        updateRegistrationStepUI();
      } else {
        showScreen('splash');
      }
    });
    document.getElementById('reg-next-btn').addEventListener('click', () => {
      if (currentRegistrationStep === 1) {
        if (!regInputs.nickname.value || !regInputs.email.value || !regInputs.password.value) {
          showMessage('Campo Obrigatório', 'Por favor, preencha seu nome, email e senha.');
          return;
        }
        if (regInputs.password.value.length < 6) {
          showMessage('Senha Fraca', 'Sua senha deve ter pelo menos 6 caracteres.');
          return;
        }
        currentRegistrationStep = 2;
      } else if (currentRegistrationStep === 2) {
        if (!regInputs.height.value || !regInputs.weight.value) {
          showMessage('Campo Obrigatório', 'Por favor, preencha sua altura e peso atual.');
          return;
        }
        currentRegistrationStep = 3;
      } else if (currentRegistrationStep === 3) {
        if (!selectedAvatarUrl) {
          showMessage('Campo Obrigatório', 'Escolha sua aparência (avatar) para continuar.');
          return;
        }
        handleRegister();
      }
      updateRegistrationStepUI();
    });
    document.getElementById('avatar-selection').addEventListener('click', (e) => {
      const clickedAvatar = e.target.closest('.avatar-option');
      if (!clickedAvatar) return;
      document.querySelectorAll('.avatar-option').forEach(el => {
        el.classList.remove('avatar-selected', 'border-primary');
        el.classList.add('border-transparent');
      });
      clickedAvatar.classList.add('avatar-selected', 'border-primary');
      clickedAvatar.classList.remove('border-transparent');
      selectedAvatarUrl = clickedAvatar.dataset.avatarUrl;
    });


    // --- Lógica de Autenticação Firebase ---
    onAuthStateChanged(auth, (user) => {
      if (profileListener) profileListener();
      if (tasksListener) tasksListener();

      if (user && !user.isAnonymous) {
        console.log('Usuário logado:', user.uid);
        currentUserId = user.uid;

        const profileRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'details');
        const tasksRef = collection(db, 'artifacts', appId, 'users', user.uid, 'tasks');

        profileListener = onSnapshot(profileRef, (docSnap) => {
          if (docSnap.exists()) {
            const data = docSnap.data();
            populateDashboard(user, data);
            showScreen('dashboard');
          } else {
            console.log('Perfil não encontrado, redirecionando para cadastro...');
            showMessage('Personagem Incompleto', 'Quase lá! Precisamos de seus dados vitais para forjar seu personagem.');
            regInputs.nickname.value = user.displayName || '';
            regInputs.email.value = user.email || '';
            if (user.providerData.some(p => p.providerId === 'google.com')) {
              regInputs.nickname.disabled = true;
              regInputs.email.disabled = true;
              regInputs.password.closest('label').classList.add('hidden');
            }
            currentRegistrationStep = 2;
            updateRegistrationStepUI();
            showScreen('register');
          }
        });

        tasksListener = onSnapshot(tasksRef, (querySnapshot) => {
          const tasks = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          checkAndGenerateRecurrentTasks(tasks);
          populateMissions(tasks);
        });

      } else {
        console.log('Usuário deslogado.');
        currentUserId = null;
        profileListener = null;
        tasksListener = null;
        resetRegistrationForm();
        showScreen('splash');
      }
    });

    function populateDashboard(user, profileData) {
      const character = profileData.character || {};
      const vitals = profileData.vitals || {};
      const stats = profileData.stats || {};

      document.getElementById('hub-avatar').src = character.avatar_url || 'https://placehold.co/100x100/1a3828/13ec6d?text=?';
      document.getElementById('hub-nickname').textContent = profileData.nickname || 'Aventureiro';
      document.getElementById('hub-level').textContent = `Nv. ${character.level || 1}`;

      const hpPercent = (character.hp_atual / character.hp_max) * 100 || 100;
      const manaPercent = (character.mana_atual / character.mana_max) * 100 || 100;
      const xpPercent = (character.xp_atual / character.xp_para_upar) * 100 || 0;

      document.getElementById('hub-hp-bar').style.width = `${hpPercent}%`;
      document.getElementById('hub-hp-text').textContent = `${character.hp_atual}/${character.hp_max}`;
      document.getElementById('hub-mana-bar').style.width = `${manaPercent}%`;
      document.getElementById('hub-mana-text').textContent = `${character.mana_atual}/${character.mana_max}`;
      document.getElementById('hub-xp-bar').style.width = `${xpPercent}%`;
      document.getElementById('hub-xp-text').textContent = `${character.xp_atual}/${character.xp_para_upar}`;

      document.getElementById('hub-stats-forca').innerHTML = `<span class="material-symbols-outlined text-red-400 text-base">swords</span> <span>Força: ${stats.forca?.level || 1}</span>`;
      document.getElementById('hub-stats-inteligencia').innerHTML = `<span class="material-symbols-outlined text-blue-400 text-base">school</span> <span>Inteligência: ${stats.inteligencia?.level || 1}</span>`;
      document.getElementById('hub-stats-vitalidade').innerHTML = `<span class="material-symbols-outlined text-green-400 text-base">shield</span> <span>Vitalidade: ${stats.vitalidade?.level || 1}</span>`;
      document.getElementById('hub-stats-velocidade').innerHTML = `<span class="material-symbols-outlined text-yellow-400 text-base">sprint</span> <span>Velocidade: ${stats.velocidade?.level || 1}</span>`;

      const statusContainer = document.getElementById('hub-status-effects');
      statusContainer.innerHTML = '';
      if (profileData.status_effects && profileData.status_effects.length > 0) {
        profileData.status_effects.forEach(effect => {
          const effectEl = document.createElement('div');
          effectEl.className = 'flex items-center gap-2 text-sm';
          effectEl.innerHTML = `<span class="material-symbols-outlined text-yellow-500 text-base">spark</span> <span>${effect.label}</span>`;
          statusContainer.appendChild(effectEl);
        });
      } else {
        statusContainer.innerHTML = '<p class="text-sm text-text-dark-secondary">Nenhum efeito ativo.</p>';
      }
    }

    async function checkAndGenerateRecurrentTasks(tasks) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todayStr = today.toISOString().split('T')[0];

        const templates = tasks.filter(t => t.isTemplate);

        for (const template of templates) {
            const lastGenerated = template.lastGenerated ? new Date(template.lastGenerated.toDate()) : null;
            let shouldGenerate = false;

            if (!lastGenerated) {
                 shouldGenerate = true;
            } else {
                const lastGeneratedStr = lastGenerated.toISOString().split('T')[0];
                if (lastGeneratedStr !== todayStr) {
                    shouldGenerate = true;
                }
            }

            if (shouldGenerate) {
                let isValidToday = false;
                if (template.recorrencia.type === 'weekdays') {
                    if (template.recorrencia.value.includes(today.getDay())) {
                        isValidToday = true;
                    }
                } else if (template.recorrencia.type === 'days') {
                    const createdAt = template.createdAt.toDate();
                    createdAt.setHours(0, 0, 0, 0);
                    const diffTime = Math.abs(today - createdAt);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    if (diffDays % template.recorrencia.value === 0) {
                        isValidToday = true;
                    }
                }

                if (isValidToday) {
                    const newTask = { ...template };
                    delete newTask.id;
                    newTask.isTemplate = false;
                    newTask.recorrencia = null;
                    newTask.createdAt = Timestamp.now();
                    newTask.titulo = `${template.titulo} (${today.toLocaleDateString('pt-BR')})`;

                    try {
                        const tasksRef = collection(db, 'artifacts', appId, 'users', currentUserId, 'tasks');
                        await addDoc(tasksRef, newTask);

                        const templateRef = doc(db, 'artifacts', appId, 'users', currentUserId, 'tasks', template.id);
                        await updateDoc(templateRef, { lastGenerated: Timestamp.now() });

                        console.log(`Tarefa recorrente '${newTask.titulo}' gerada.`);

                    } catch (error) {
                        console.error("Erro ao gerar tarefa recorrente:", error);
                    }
                }
            }
        }
    }

    async function calculateTotalTime(taskId) {
        if (!currentUserId || !taskId) return '00:00:00';

        const eventLogsRef = collection(db, 'artifacts', appId, 'users', currentUserId, 'tasks', taskId, 'event_logs');
        const q = query(eventLogsRef, orderBy('timestamp', 'asc'));

        try {
            const querySnapshot = await getDocs(q);
            const events = querySnapshot.docs.map(doc => doc.data());

            let totalSeconds = 0;
            let lastStartTime = null;

            events.forEach(event => {
                const eventType = event.tipo;
                const eventTime = event.timestamp.toDate();

                if (eventType === 'INICIO' || eventType === 'RETOMADA') {
                    lastStartTime = eventTime;
                } else if ((eventType === 'PAUSA' || eventType === 'CONCLUSAO') && lastStartTime) {
                    const diffSeconds = (eventTime - lastStartTime) / 1000;
                    totalSeconds += diffSeconds;
                    lastStartTime = null; // Reseta para o próximo par
                }
            });

            // Se a missão ainda está EM_ANDAMENTO, adiciona o tempo decorrido desde o último início
            if (lastStartTime && activeMission.data.status === 'EM_ANDAMENTO') {
                 const diffSeconds = (new Date() - lastStartTime) / 1000;
                 totalSeconds += diffSeconds;
            }

            return formatTime(Math.round(totalSeconds));

        } catch (error) {
            console.error("Erro ao calcular tempo total:", error);
            return 'Erro';
        }
    }

    function populateMissions(tasks) {
        const missionContainer = document.getElementById('hub-mission-list');
        missionContainer.innerHTML = '';

        const visibleTasks = tasks.filter(t => !t.isTemplate);

        if (!visibleTasks || visibleTasks.length === 0) {
            missionContainer.innerHTML = '<p class="text-sm text-text-dark-secondary p-4">Nenhuma missão encontrada. Adicione uma nova!</p>';
            return;
        }

        const priorityOrder = { 'principal': 1, 'contrato': 2, 'secundaria': 3 };
        const statusOrder = { 'EM_ANDAMENTO': 1, 'PAUSADA': 2, 'PENDENTE': 3, 'CONCLUIDA': 4 };

        visibleTasks.sort((a, b) => {
             const statusA = statusOrder[a.status] || 4;
             const statusB = statusOrder[b.status] || 4;
             if (statusA !== statusB) return statusA - statusB;
             return (priorityOrder[a.prioridade] || 3) - (priorityOrder[b.prioridade] || 3);
        });

        visibleTasks.forEach(task => {
            const taskEl = document.createElement('div');
            // NOVO: Adiciona o ID da tarefa ao elemento e classe para identificar cliques
            taskEl.dataset.taskId = task.id;
            taskEl.classList.add('mission-item', 'cursor-pointer');

            const isCompleted = task.status === 'CONCLUIDA';

            const priorityClasses = {
                principal: 'border-red-500/80',
                contrato: 'border-border-dark',
                secundaria: 'border-gray-500/80'
            };
            const priorityClass = priorityClasses[task.prioridade] || 'border-border-dark';

            const iconMap = {
                diaria: 'fitness_center',
                habito: 'menu_book',
                projeto: 'work',
                FORCA: 'swords',
                INTELIGENCIA: 'school',
                VELOCIDADE: 'sprint',
                VITALIDADE: 'shield',
                CARISMA: 'sentiment_satisfied',
                default: 'task'
            };

            const statusMap = {
                EM_ANDAMENTO: { text: 'Em Andamento', icon: 'directions_run', color: 'text-blue-400'},
                PAUSADA: { text: 'Pausada', icon: 'pause_circle', color: 'text-yellow-400'},
                PENDENTE: { text: 'Pendente', icon: 'pending', color: 'text-text-dark-secondary'},
                CONCLUIDA: { text: 'Concluída', icon: 'check_circle', color: 'text-primary'}
            };

            const icon = iconMap[task.tipo] || iconMap[task.atributo_associado] || iconMap.default;
            const statusInfo = statusMap[task.status] || statusMap.PENDENTE;

            taskEl.className = `mission-item cursor-pointer flex flex-col rounded-lg bg-surface-dark/50 p-4 backdrop-blur-sm border-l-4 ${priorityClass} ${isCompleted ? 'opacity-60' : ''}`;
            taskEl.dataset.taskId = task.id; // Garante que o ID está no elemento

            let subtasksHTML = '';
            if (task.subtarefas && task.subtarefas.length > 0) {
                 const completedCount = task.subtarefas.filter(s => s.concluida).length;
                 subtasksHTML = `<p class="text-sm ${completedCount === task.subtarefas.length ? 'text-primary' : 'text-text-dark-secondary'}">${completedCount}/${task.subtarefas.length} sub-tarefas</p>`;
            }

            taskEl.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="flex h-12 w-12 items-center justify-center rounded-lg bg-primary/20">
                      <span class="material-symbols-outlined text-primary text-3xl">${icon}</span>
                    </div>
                    <div class="flex-1">
                      <p class="font-bold ${isCompleted ? 'line-through' : ''}">${task.titulo || 'Missão sem título'}</p>
                      <div class="flex items-center gap-4 mt-1">
                          <div class="flex items-center gap-1 text-sm ${statusInfo.color}">
                              <span class="material-symbols-outlined !text-base">${statusInfo.icon}</span>
                              <span>${statusInfo.text}</span>
                          </div>
                          ${subtasksHTML}
                      </div>
                    </div>
                </div>
            `;
            missionContainer.appendChild(taskEl);
        });
    }

    document.getElementById('hub-mission-list').addEventListener('click', async (e) => {
        // Lógica para abrir detalhes da missão
        const missionItem = e.target.closest('.mission-item');
        if (missionItem) {
            const taskId = missionItem.dataset.taskId;
            loadMissionDetails(taskId);
            return; // Impede que o código abaixo seja executado desnecessariamente
        }

        const checkbox = e.target.closest('.subtask-checkbox');
        if (!checkbox || !currentUserId) return;

        const taskId = checkbox.dataset.taskId;
        const subtaskIndex = parseInt(checkbox.dataset.subtaskIndex, 10);

        const taskRef = doc(db, 'artifacts', appId, 'users', currentUserId, 'tasks', taskId);

        try {
            const taskDoc = await getDoc(taskRef);
            if (taskDoc.exists()) {
                const taskData = taskDoc.data();
                const subtarefas = taskData.subtarefas || [];

                if (subtarefas[subtaskIndex]) {
                    subtarefas[subtaskIndex].concluida = !subtarefas[subtaskIndex].concluida;
                }

                await updateDoc(taskRef, { subtarefas: subtarefas });
            }
        } catch (error) {
            console.error("Erro ao atualizar sub-tarefa:", error);
            showMessage('Erro', 'Não foi possível atualizar o status da sub-tarefa.');
        }
    });

    async function handleSubtaskStateChange(subtaskId, newStatus, eventType) {
        if (!activeMission.id || !subtaskId) return;

        const subtaskRef = doc(db, 'artifacts', appId, 'users', currentUserId, 'tasks', activeMission.id, 'sub_tasks', subtaskId);
        const eventLogsRef = collection(subtaskRef, 'event_logs');

        try {
            const batch = writeBatch(db);
            batch.update(subtaskRef, { status: newStatus });
            batch.set(doc(eventLogsRef), { tipo: eventType, timestamp: Timestamp.now() });
            await batch.commit();

            // Recarrega tudo para manter a UI sincronizada.
            // Uma otimização futura seria atualizar apenas o item da sub-tarefa.
            loadMissionDetails(activeMission.id);
        } catch (error) {
            console.error("Erro ao mudar estado da sub-tarefa:", error);
            showMessage('Erro', 'Não foi possível atualizar a sub-tarefa.');
        }
    }

    document.getElementById('mission-sub-task-list').addEventListener('click', (e) => {
        const button = e.target.closest('button');
        if (!button) return;

        const subtaskId = button.dataset.subtaskId;
        if (!subtaskId) return;

        if (button.classList.contains('subtask-start-btn')) {
            handleSubtaskStateChange(subtaskId, 'EM_ANDAMENTO', 'INICIO');
        } else if (button.classList.contains('subtask-pause-btn')) {
            handleSubtaskStateChange(subtaskId, 'PAUSADA', 'PAUSA');
        } else if (button.classList.contains('subtask-resume-btn')) {
            handleSubtaskStateChange(subtaskId, 'EM_ANDAMENTO', 'RETOMADA');
        } else if (button.classList.contains('subtask-complete-btn')) {
            handleSubtaskStateChange(subtaskId, 'CONCLUIDA', 'CONCLUSAO');
        }
    });


    // --- LÓGICA DA TELA DE DETALHES DA MISSÃO ---
    function formatTime(seconds) {
        const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
        const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
        const s = (seconds % 60).toString().padStart(2, '0');
        return `${h}:${m}:${s}`;
    }

    function startSessionTimer() {
        if (activeMission.timerInterval) return;

        // Timer da sessão atual (a cada segundo)
        activeMission.timerInterval = setInterval(() => {
            activeMission.sessionSeconds++;
            document.getElementById('session-timer').textContent = formatTime(activeMission.sessionSeconds);
        }, 1000);

        // Timer de atualização do tempo total (a cada 30 segundos)
        activeMission.totalTimeInterval = setInterval(async () => {
            const totalTimeFormatted = await calculateTotalTime(activeMission.id);
            document.getElementById('total-timer').textContent = `Tempo Total Acumulado: ${totalTimeFormatted}`;
        }, 30000);
    }

    function stopSessionTimer() {
        clearInterval(activeMission.timerInterval);
        clearInterval(activeMission.totalTimeInterval);
        activeMission.timerInterval = null;
        activeMission.totalTimeInterval = null;
    }

    function resetSessionTimer() {
        stopSessionTimer();
        activeMission.sessionSeconds = 0;
        document.getElementById('session-timer').textContent = '00:00:00';
    }

    function renderMissionControls(task) {
        const controlsContainer = document.getElementById('mission-controls-container');
        controlsContainer.innerHTML = '';
        let buttonsHTML = '';

        switch (task.status) {
            case 'PENDENTE':
                buttonsHTML = `
                    <button id="mission-start-btn" class="flex flex-1 min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-12 px-5 bg-primary text-background-dark text-base font-bold">Iniciar Missão</button>
                    <button id="mission-edit-details-btn" class="flex flex-1 min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-12 px-5 bg-surface-dark/80 text-white text-base font-bold">Editar</button>
                `;
                break;
            case 'EM_ANDAMENTO':
                buttonsHTML = `
                    <button id="mission-pause-btn" class="flex flex-1 min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-12 px-5 bg-yellow-500 text-background-dark text-base font-bold">Pausar Missão</button>
                    <button id="mission-complete-btn" class="flex flex-1 min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-12 px-5 bg-primary text-background-dark text-base font-bold">Concluir Missão</button>
                `;
                break;
            case 'PAUSADA':
                buttonsHTML = `
                    <button id="mission-resume-btn" class="flex flex-1 min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-12 px-5 bg-primary text-background-dark text-base font-bold">Retomar Missão</button>
                    <button id="mission-cancel-btn" class="flex flex-1 min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-12 px-5 bg-red-500/80 text-white text-base font-bold">Cancelar Missão</button>
                `;
                break;
            case 'CONCLUIDA':
                 buttonsHTML = `<p class="w-full text-center text-primary font-bold">Missão Concluída com Sucesso!</p>`;
                 break;
        }
        controlsContainer.innerHTML = buttonsHTML;
    }

    async function loadMissionDetails(taskId) {
        if (!currentUserId || !taskId) return;

        activeMission.id = taskId;
        resetSessionTimer();

        const missionRef = doc(db, 'artifacts', appId, 'users', currentUserId, 'tasks', taskId);
        const subtasksRef = collection(missionRef, 'sub_tasks');

        try {
            const missionSnap = await getDoc(missionRef);
            if (!missionSnap.exists()) {
                 showMessage('Erro', 'Missão não encontrada.');
                 return showScreen('dashboard');
            }

            activeMission.data = { id: missionSnap.id, ...missionSnap.data() };

            const subtasksSnap = await getDocs(query(subtasksRef, orderBy('createdAt', 'asc')));
            const subtasks = subtasksSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // Popular a UI
            document.getElementById('details-mission-title').textContent = activeMission.data.titulo;
            const totalTimeFormatted = await calculateTotalTime(taskId);
            document.getElementById('total-timer').textContent = `Tempo Total Acumulado: ${totalTimeFormatted}`;

            // Popular Recompensas
            const rewards = activeMission.data.recompensa;
            const rewardsContainer = document.getElementById('mission-rewards-container').querySelector('div');
            rewardsContainer.innerHTML = '';
            if (rewards) {
                 rewardsContainer.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="flex size-12 items-center justify-center rounded-full bg-primary/20 text-primary"><span class="material-symbols-outlined">star</span></div>
                        <div class="flex-1"><p class="text-white font-semibold">XP da Missão</p><p class="text-gray-400 text-sm">+${rewards.xp_global || 0} XP</p></div>
                    </div>
                     <div class="flex items-center gap-4">
                        <div class="flex size-12 items-center justify-center rounded-full bg-primary/20 text-primary"><span class="material-symbols-outlined">${activeMission.data.atributo_associado === 'INTELIGENCIA' ? 'school' : 'swords'}</span></div>
                        <div class="flex-1"><p class="text-white font-semibold">XP de ${activeMission.data.atributo_associado || 'Atributo'}</p><p class="text-gray-400 text-sm">+${rewards.xp_atributo || 0} XP</p></div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="flex size-12 items-center justify-center rounded-full bg-primary/20 text-primary"><span class="material-symbols-outlined">paid</span></div>
                        <div class="flex-1"><p class="text-white font-semibold">Moedas de Ouro</p><p class="text-gray-400 text-sm">+${rewards.moedas || 0} Moedas</p></div>
                    </div>
                 `;
            }

            renderMissionControls(activeMission.data);
            renderSubtasks(subtasks); // <-- Nova função chamada aqui

            if (activeMission.data.status === 'EM_ANDAMENTO') {
                startSessionTimer();
            }

            showScreen('missionDetails');

        } catch (error) {
            console.error("Erro ao carregar detalhes da missão:", error);
            showMessage('Erro', 'Não foi possível carregar os detalhes da missão.');
            showScreen('dashboard');
        }
    }

    function renderSubtasks(subtasks) {
        const container = document.getElementById('mission-sub-task-list');
        container.innerHTML = '';
        if (subtasks.length === 0) {
            container.innerHTML = '<p class="text-sm text-text-dark-secondary py-4">Nenhuma sub-tarefa definida. Adicione uma!</p>';
            return;
        }

        subtasks.forEach(subtask => {
            const subtaskEl = document.createElement('div');
            subtaskEl.className = 'flex items-center gap-x-3 py-4';

            let buttonsHTML = '';
            switch (subtask.status) {
                case 'EM_ANDAMENTO':
                    buttonsHTML = `
                        <button data-subtask-id="${subtask.id}" class="subtask-pause-btn ml-auto flex shrink-0 items-center justify-center rounded-full size-10 bg-yellow-500/20 text-yellow-400"><span class="material-symbols-outlined">pause</span></button>
                        <button data-subtask-id="${subtask.id}" class="subtask-complete-btn ml-2 flex shrink-0 items-center justify-center rounded-full size-10 bg-primary/20 text-primary"><span class="material-symbols-outlined">check</span></button>
                    `;
                    break;
                case 'PAUSADA':
                    buttonsHTML = `
                        <button data-subtask-id="${subtask.id}" class="subtask-resume-btn ml-auto flex shrink-0 items-center justify-center rounded-full size-10 bg-primary/20 text-primary"><span class="material-symbols-outlined">play_arrow</span></button>
                    `;
                    break;
                case 'CONCLUIDA':
                    buttonsHTML = `
                        <div class="ml-auto text-primary flex items-center gap-2"><span class="material-symbols-outlined">check_circle</span> Concluída</div>
                    `;
                    break;
                case 'PENDENTE':
                default:
                    buttonsHTML = `
                        <button data-subtask-id="${subtask.id}" class="subtask-start-btn ml-auto flex shrink-0 items-center justify-center rounded-full size-10 bg-[#28392f] text-white"><span class="material-symbols-outlined">play_arrow</span></button>
                    `;
                    break;
            }

            subtaskEl.innerHTML = `
                 <div class="flex-grow">
                    <p class="text-white text-base font-normal leading-normal ${subtask.status === 'CONCLUIDA' ? 'line-through text-gray-500' : ''}">${subtask.titulo}</p>
                 </div>
                 ${buttonsHTML}
            `;
            container.appendChild(subtaskEl);
        });
    }

    document.getElementById('details-add-subtask-btn').addEventListener('click', async () => {
        if (!activeMission.id) return;

        const title = prompt("Digite o título da nova sub-tarefa:");
        if (title && title.trim()) {
            const subtasksRef = collection(db, 'artifacts', appId, 'users', currentUserId, 'tasks', activeMission.id, 'sub_tasks');
            try {
                await addDoc(subtasksRef, {
                    titulo: title.trim(),
                    status: 'PENDENTE',
                    createdAt: Timestamp.now()
                });
                // Recarrega os detalhes para mostrar a nova sub-tarefa
                loadMissionDetails(activeMission.id);
            } catch (error) {
                console.error("Erro ao adicionar sub-tarefa:", error);
                showMessage('Erro', 'Não foi possível adicionar a sub-tarefa.');
            }
        }
    });

    async function showHistoryLog(taskId) {
        if (!taskId) return;

        historyModal.content.innerHTML = '<p>Carregando histórico...</p>';
        historyModal.container.classList.remove('hidden');

        const eventLogsRef = collection(db, 'artifacts', appId, 'users', currentUserId, 'tasks', taskId, 'event_logs');
        const q = query(eventLogsRef, orderBy('timestamp', 'asc'));

        try {
            const querySnapshot = await getDocs(q);
            const events = querySnapshot.docs.map(doc => doc.data());

            if (events.length === 0) {
                 historyModal.content.innerHTML = '<p>Nenhum evento registrado para esta missão ainda.</p>';
                 return;
            }

            let logHTML = '';
            let lastTime = null;
            let sessionCounter = 1;

            events.forEach((event, index) => {
                const eventTime = event.timestamp.toDate();
                if (lastTime) {
                    const diffSeconds = Math.round((eventTime - lastTime) / 1000);
                    const duration = formatTime(diffSeconds);
                    const eventType = events[index - 1].tipo;

                    if(eventType === 'INICIO' || eventType === 'RETOMADA') {
                        logHTML += `<div class="flex items-center gap-2"><span class="material-symbols-outlined text-red-400">swords</span><span>Sessão de Atividade ${sessionCounter++}: ${duration}</span></div>`;
                    } else if (eventType === 'PAUSA') {
                        logHTML += `<div class="flex items-center gap-2 ml-4"><span class="material-symbols-outlined text-gray-400">shield</span><span>Pausa: ${duration}</span></div>`;
                    }
                }
                lastTime = eventTime;
            });

            historyModal.content.innerHTML = logHTML;

        } catch (error) {
            console.error("Erro ao buscar histórico:", error);
            historyModal.content.innerHTML = '<p>Erro ao carregar o histórico. Tente novamente.</p>';
        }
    }

    document.getElementById('details-history-btn').addEventListener('click', () => {
        showHistoryLog(activeMission.id);
    });

    historyModal.closeBtn.addEventListener('click', () => {
        historyModal.container.classList.add('hidden');
    });

    document.getElementById('details-back-btn').addEventListener('click', () => {
        stopSessionTimer();
        activeMission.id = null;
        activeMission.data = null;
        showScreen('dashboard');
    });

    async function handleMissionStateChange(newStatus, eventType) {
        if (!activeMission.id || !currentUserId) return;

        const missionRef = doc(db, 'artifacts', appId, 'users', currentUserId, 'tasks', activeMission.id);
        const eventLogsRef = collection(missionRef, 'event_logs');

        try {
            const batch = writeBatch(db);

            // 1. Atualiza o status da missão principal
            batch.update(missionRef, { status: newStatus });

            // 2. Adiciona um novo log de evento
            const newLog = { tipo: eventType, timestamp: Timestamp.now() };
            const eventLogDoc = doc(eventLogsRef); // Cria uma referência com ID automático
            batch.set(eventLogDoc, newLog);

            await batch.commit();

            // Atualiza o estado local e a UI
            activeMission.data.status = newStatus;
            renderMissionControls(activeMission.data);

            // Controle do cronômetro e UI
            if (eventType === 'INICIO' || eventType === 'RETOMADA') {
                resetSessionTimer();
                startSessionTimer();
            } else if (eventType === 'PAUSA' || eventType === 'CONCLUSAO') {
                stopSessionTimer();
                // Recalcula o tempo total final ao pausar ou concluir
                const totalTimeFormatted = await calculateTotalTime(activeMission.id);
                document.getElementById('total-timer').textContent = `Tempo Total Acumulado: ${totalTimeFormatted}`;
            }

            console.log(`Missão ${activeMission.id} atualizada para ${newStatus} com evento ${eventType}.`);

        } catch (error) {
            console.error("Erro ao mudar estado da missão:", error);
            showMessage('Erro de Rede', 'Não foi possível atualizar a missão. Tente novamente.');
        }
    }


    document.getElementById('mission-controls-container').addEventListener('click', (e) => {
        const button = e.target.closest('button');
        if (!button) return;

        switch(button.id) {
            case 'mission-start-btn':   handleMissionStateChange('EM_ANDAMENTO', 'INICIO'); break;
            case 'mission-pause-btn':   handleMissionStateChange('PAUSADA', 'PAUSA'); break;
            case 'mission-resume-btn':  handleMissionStateChange('EM_ANDAMENTO', 'RETOMADA'); break;
            case 'mission-complete-btn':handleMissionStateChange('CONCLUIDA', 'CONCLUSAO'); break;
            // O botão Cancelar pode ter uma lógica diferente (ex: reverter para PENDENTE)
            case 'mission-cancel-btn':  handleMissionStateChange('PENDENTE', 'CANCELAMENTO'); break;
        }
    });

    function resetRegistrationForm() {
      currentRegistrationStep = 1;
      updateRegistrationStepUI();
      Object.values(regInputs).forEach(input => {
        input.value = '';
        input.disabled = false;
      });
      regInputs.password.closest('label').classList.remove('hidden');
      selectedAvatarUrl = null;
      document.querySelectorAll('.avatar-option').forEach(el => {
        el.classList.remove('avatar-selected', 'border-primary');
        el.classList.add('border-transparent');
      });
    }

    async function handleRegister() {
      let user;

      const basicData = {
          nickname: regInputs.nickname.value,
          email: regInputs.email.value,
          createdAt: Timestamp.now(),
          uid: null
      };

      const vitals = {
          altura_cm: Number(regInputs.height.value),
          peso_atual_kg: Number(regInputs.weight.value),
          meta_peso_kg: Number(regInputs.weightTarget.value) || null,
          imc: 0
      };
      if (vitals.altura_cm > 0) {
          const altura_m = vitals.altura_cm / 100;
          vitals.imc = parseFloat((vitals.peso_atual_kg / (altura_m * altura_m)).toFixed(1));
      }

      const defaultStat = { level: 1, xp_atual: 0, xp_para_upar: 100 };
      const stats = {
          forca: { ...defaultStat },
          inteligencia: { ...defaultStat },
          velocidade: { ...defaultStat },
          vitalidade: { ...defaultStat },
          carisma: { ...defaultStat }
      };

      const base_hp = 100 + (stats.vitalidade.level * 10);
      const base_mana = 100 + (stats.inteligencia.level * 10);

      const character = {
          level: 1,
          xp_atual: 0,
          xp_para_upar: 1000,
          hp_max: base_hp,
          hp_atual: base_hp,
          energia_max: 100,
          energia_atual: 100,
          mana_max: base_mana,
          mana_atual: base_mana,
          moedas: 0,
          avatar_url: selectedAvatarUrl
      };

      const status_effects = [];
      if (vitals.imc > 25) {
          status_effects.push({ id: "debuff_imc_alto", label: "Sobrepeso", effect: "energia_max", value: -10 });
      } else if (vitals.imc < 18.5) {
          status_effects.push({ id: "debuff_imc_baixo", label: "Abaixo do Peso", effect: "hp_max", value: -10 });
      }

      const profileData = {
          ...basicData,
          vitals,
          stats,
          character,
          status_effects
      };

      try {
        if (auth.currentUser && !auth.currentUser.isAnonymous && regInputs.email.disabled) {
          user = auth.currentUser;
          console.log('Atualizando perfil existente do Google...');
          profileData.email = user.email;
          profileData.nickname = user.displayName || basicData.nickname;
          character.avatar_url = user.photoURL || selectedAvatarUrl;
        } else {
          console.log('Criando novo usuário com Email/Senha...');
          const userCredential = await createUserWithEmailAndPassword(auth, basicData.email, regInputs.password.value);
          user = userCredential.user;
          await updateProfile(user, { displayName: basicData.nickname });
        }

        profileData.uid = user.uid;
        const profileRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'details');
        await setDoc(profileRef, profileData);

        console.log('Personagem criado e salvo!');

      } catch (error) {
        console.error("Erro ao criar personagem:", error);
        showMessage('Erro na Criação', `Não foi possível criar seu personagem. Erro: ${error.message}`);
      }
    }

    document.getElementById('login-btn').addEventListener('click', async () => {
      const email = loginInputs.email.value;
      const password = loginInputs.password.value;
      if (!email || !password) {
        return showMessage('Campos Vazios', 'Digite seu email e senha.');
      }
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (error) {
        console.error("Erro no login:", error);
        showMessage('Erro ao Entrar', 'Email ou senha inválidos. Verifique seus dados.');
      }
    });
    document.getElementById('btn-google-login').addEventListener('click', async () => {
      const provider = new GoogleAuthProvider();
      try {
        await signInWithPopup(auth, provider);
      } catch (error) {
        console.error("Erro no login com Google:", error);
        showMessage('Erro no Login', `Não foi possível logar com o Google. Erro: ${error.message}`);
      }
    });
    document.getElementById('forgot-btn').addEventListener('click', async () => {
      const email = document.getElementById('forgot-email').value;
      if (!email) {
        return showMessage('Campo Vazio', 'Digite seu email para recuperação.');
      }
      try {
        await sendPasswordResetEmail(auth, email);
        showMessage('Pergaminho Enviado', 'Um email de recuperação foi enviado para ' + email + '. Verifique sua caixa de entrada (e spam).');
        showScreen('login');
      } catch (error) {
        console.error("Erro ao enviar email de recuperação:", error);
        showMessage('Erro', `Não foi possível enviar o email. Verifique o endereço digitado. Erro: ${error.message}`);
      }
    });
    document.getElementById('hub-logout-btn').addEventListener('click', async (e) => {
        e.preventDefault();
        try {
            await signOut(auth);
        } catch (error) {
            console.error("Erro ao sair:", error);
            showMessage('Erro', 'Não foi possível sair da aventura no momento.');
        }
    });

    // --- LÓGICA DA TELA DE CRIAR TAREFAS (IA) ---
    function resetTaskForm() {
        taskForm.title.value = '';
        taskForm.durationHours.value = '';
        taskForm.durationMinutes.value = '';
        taskForm.deadline.value = '';
        taskForm.notes.value = '';
        taskForm.subtaskInput.value = '';
        selectedTaskType = null;
        selectedTaskPriority = 'contrato';
        recurrenceRule = null;
        taskForm.recurrenceSummary.textContent = '';
        attachmentFile = null; // Limpa o anexo
        taskForm.attachmentInput.value = ''; // Limpa o input de arquivo
        taskForm.attachmentName.textContent = ''; // Limpa o nome do anexo
        aiResults = null;
        calculatedRewards = null;
        subtasksList = [];
        renderSubtasks();

        taskForm.typeButtons.forEach(btn => btn.classList.remove('task-type-selected'));
        taskForm.priorityButtons.forEach(btn => btn.classList.remove('task-priority-selected'));

        rewardBox.loading.classList.remove('hidden');
        rewardBox.loadingText.textContent = 'Digite sua missão para calcularmos a recompensa...';
        rewardBox.spinner.classList.add('hidden');
        rewardBox.results.classList.add('hidden');
    }
    function renderSubtasks() {
        taskForm.subtaskList.innerHTML = '';
        subtasksList.forEach((task, index) => {
            const taskEl = document.createElement('div');
            taskEl.className = 'flex items-center justify-between bg-surface-dark/50 p-3 rounded-lg';
            taskEl.innerHTML = `
                <span class="text-white/90">${task.titulo}</span>
                <button data-index="${index}" class="remove-subtask-btn flex items-center justify-center h-6 w-6 rounded-full text-red-400 hover:bg-red-400/20">
                    <span class="material-symbols-outlined text-base">close</span>
                </button>
            `;
            taskForm.subtaskList.appendChild(taskEl);
        });
    }

    taskForm.addSubtaskBtn.addEventListener('click', () => {
        const title = taskForm.subtaskInput.value.trim();
        if (title) {
            subtasksList.push({ titulo: title, concluida: false });
            taskForm.subtaskInput.value = '';
            renderSubtasks();
            triggerAIAnalysis();
        }
    });
    taskForm.subtaskList.addEventListener('click', (e) => {
        const removeBtn = e.target.closest('.remove-subtask-btn');
        if (removeBtn) {
            const index = parseInt(removeBtn.dataset.index, 10);
            subtasksList.splice(index, 1);
            renderSubtasks();
            triggerAIAnalysis();
        }
    });
    taskForm.typeGroup.addEventListener('click', (e) => {
        const button = e.target.closest('.task-type-btn');
        if (!button) return;
        selectedTaskType = button.dataset.type;
        taskForm.typeButtons.forEach(btn => btn.classList.remove('task-type-selected'));
        button.classList.add('task-type-selected');
        triggerAIAnalysis();
    });
    taskForm.priorityGroup.addEventListener('click', (e) => {
        const button = e.target.closest('.task-priority-btn');
        if (!button) return;
        selectedTaskPriority = button.dataset.priority;
        taskForm.priorityButtons.forEach(btn => btn.classList.remove('task-priority-selected'));
        button.classList.add('task-priority-selected');
    });
    taskForm.openRecurrenceBtn.addEventListener('click', (e) => {
        e.preventDefault();
        recurrenceModal.container.classList.remove('hidden');
    });
    recurrenceModal.cancelBtn.addEventListener('click', () => {
        recurrenceModal.container.classList.add('hidden');
    });
    recurrenceModal.daysInput.addEventListener('input', () => {
        recurrenceModal.weekdayButtons.forEach(btn => btn.classList.remove('weekday-btn-selected'));
    });
    recurrenceModal.weekdaysGroup.addEventListener('click', (e) => {
        const button = e.target.closest('.weekday-btn');
        if (button) {
            recurrenceModal.daysInput.value = '';
            button.classList.toggle('weekday-btn-selected');
        }
    });
    recurrenceModal.saveBtn.addEventListener('click', () => {
        const days = parseInt(recurrenceModal.daysInput.value, 10);
        const selectedWeekdays = [...recurrenceModal.weekdayButtons]
            .filter(btn => btn.classList.contains('weekday-btn-selected'))
            .map(btn => parseInt(btn.dataset.day, 10));

        if (days > 0) {
            recurrenceRule = { type: 'days', value: days };
            taskForm.recurrenceSummary.textContent = `Repete a cada ${days} dia(s).`;
        } else if (selectedWeekdays.length > 0) {
            recurrenceRule = { type: 'weekdays', value: selectedWeekdays.sort() };
            const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
            const summary = selectedWeekdays.map(d => dayNames[d]).join(', ');
            taskForm.recurrenceSummary.textContent = `Repete em: ${summary}.`;
        } else {
            recurrenceRule = null;
            taskForm.recurrenceSummary.textContent = '';
        }
        recurrenceModal.container.classList.add('hidden');
    });

    function triggerAIAnalysis() {
        const title = taskForm.title.value.trim();
        const hours = parseInt(taskForm.durationHours.value, 10) || 0;
        const minutes = parseInt(taskForm.durationMinutes.value, 10) || 0;
        const totalMinutes = (hours * 60) + minutes;
        
        if (title.length < 3 || !selectedTaskType) {
             rewardBox.loading.classList.remove('hidden');
             rewardBox.loadingText.textContent = 'Preencha o Título e o Tipo de Missão...';
             rewardBox.spinner.classList.add('hidden');
             rewardBox.results.classList.add('hidden');
            return;
        }
        
        rewardBox.loading.classList.remove('hidden');
        rewardBox.loadingText.textContent = 'Analisando missão...';
        rewardBox.spinner.classList.remove('hidden');
        rewardBox.results.classList.add('hidden');
        
        debounce(() => analyzeTaskWithAI(title, totalMinutes, selectedTaskType, subtasksList), 1000);
    }

    taskForm.title.addEventListener('keyup', triggerAIAnalysis);
    taskForm.durationHours.addEventListener('keyup', triggerAIAnalysis);
    taskForm.durationMinutes.addEventListener('keyup', triggerAIAnalysis);

    taskForm.addAttachmentBtn.addEventListener('click', () => {
        taskForm.attachmentInput.click();
    });

    taskForm.attachmentInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            attachmentFile = file;
            taskForm.attachmentName.textContent = file.name;
        } else {
            attachmentFile = null;
            taskForm.attachmentName.textContent = '';
        }
    });

    async function analyzeTaskWithAI(taskTitle, totalMinutes, taskType, subtasks) {
        console.log(`Analisando: Tipo=${taskType}, Título='${taskTitle}', Duração=${totalMinutes} min, Sub-tarefas=${subtasks.length}`);
        
        const apiKey = "AIzaSyCF4tD2jq3pEHfuilwMq-fjdUnBZDxcoxM";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        const subtasksString = JSON.stringify(subtasks.map(s => s.titulo));
        const combinedPrompt = `Você é um mestre de jogo (Game Master) de um RPG da vida real. Sua função é analisar tarefas e classificá-las. Responda APENAS com um objeto JSON. Não inclua \`\`\`json ou qualquer texto antes ou depois.

Analise a tarefa. Considere o TIPO, Título, Duração e Sub-tarefas para definir o atributo_associado (FORCA, INTELIGENCIA, VELOCIDADE, VITALIDADE, CARISMA) e a dificuldade (FACIL, MEDIA, DIFICIL).

Use estas definições de Atributo:
FORCA: Academia, levantar peso, limpeza pesada.
INTELIGENCIA: Estudar, ler, planejar, meditar, aprender.
VELOCIDADE: Correr, organizar, tarefas rápidas, caminhada.
VITALIDADE: Beber água, comer saudável, dormir, tomar sol.
CARISMA: Socializar, ligar para amigos, networking, apresentação.

Regras de Dificuldade (INTELIGENTE - Use o TIPO como base):
TIPO 'habito': É quase sempre FACIL. (Ex: 'Beber água', 'Meditar 5 min'). Só será MEDIA se a Duração for > 30 min. Um Hábito NUNCA pode ser 'DIFICIL'.
TIPO 'diaria': É quase sempre MEDIA. (Ex: 'Ir na academia', 'Correr 30 min'). Só será 'DIFICIL' se Duração > 90 min OU tiver 4+ sub-tarefas.
TIPO 'projeto': É quase sempre DIFICIL. (Ex: 'Fazer TCC', 'Limpar a casa toda'). Só será 'MEDIA' se tiver 0 sub-tarefas E Duração < 60 min.

Exemplos de Classificação:
TIPO: 'habito', Título: 'Beber água 1 copo', Duração: 1, Sub-tarefas: [] -> {"atributo_associado": "VITALIDADE", "dificuldade": "FACIL"}
TIPO: 'diaria', Título: 'Correr', Duração: 30, Sub-tarefas: [] -> {"atributo_associado": "VELOCIDADE", "dificuldade": "MEDIA"}
TIPO: 'projeto', Título: 'Estudar p/ prova', Duração: 60, Sub-tarefas: [] -> {"atributo_associado": "INTELIGENCIA", "dificuldade": "MEDIA"}
TIPO: 'projeto', Título: 'Estudar p/ prova', Duração: 60, Sub-tarefas: ["Ler", "Resumir"] -> {"atributo_associado": "INTELIGENCIA", "dificuldade": "DIFICIL"}

Tarefa:
TIPO: '${taskType}'
Título: '${taskTitle}'
Duração (minutos): ${totalMinutes}
Sub-tarefas: ${subtasksString}`;

        const responseSchema = {
            type: "OBJECT",
            properties: {
                "atributo_associado": { "type": "STRING" },
                "dificuldade": { "type": "STRING" }
            },
            required: ["atributo_associado", "dificuldade"]
        };
        
        const payload = {
            contents: [{ parts: [{ text: combinedPrompt }] }],
            generationConfig: {
                responseMimeType: "application/json",
                responseSchema: responseSchema,
                temperature: 0.1
            }
        };

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`Erro na API: ${response.statusText}`);
            }

            const result = await response.json();
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (!text) {
                 throw new Error("A IA não retornou uma análise válida.");
            }

            aiResults = JSON.parse(text);
            console.log("Resultado da IA:", aiResults);
            
            updateRewardEstimation(aiResults.atributo_associado, aiResults.dificuldade);

        } catch (error) {
            console.error("Erro ao analisar tarefa:", error);
            rewardBox.loading.classList.remove('hidden');
            rewardBox.loadingText.textContent = 'Erro ao analisar. Tente novamente.';
            rewardBox.spinner.classList.add('hidden');
            rewardBox.results.classList.add('hidden');
            aiResults = null;
        }
    }
    
     function updateRewardEstimation(attribute, difficulty) {
        if (!selectedTaskType) {
            rewardBox.loading.classList.remove('hidden');
            rewardBox.loadingText.textContent = 'Selecione um Tipo de Missão...';
            rewardBox.spinner.classList.add('hidden');
            rewardBox.results.classList.add('hidden');
            return;
        }

        const typeKey = selectedTaskType.toLowerCase();
        const difficultyKey = difficulty.toUpperCase();
        const attributeKey = attribute.toUpperCase();

        const typeRewards = REWARDS_TYPE[typeKey] || { xp_global: 0, moedas: 0 };
        const difficultyRewards = REWARDS_DIFFICULTY[difficultyKey] || { xp_attr: 0 };
        
        calculatedRewards = {
            xp_global: typeRewards.xp_global,
            xp_atributo: difficultyRewards.xp_attr,
            moedas: typeRewards.moedas
        };

        rewardBox.attribute.textContent = attributeKey;
        rewardBox.difficulty.textContent = difficultyKey;
        rewardBox.xpGlobal.textContent = `+${calculatedRewards.xp_global} XP`;
        rewardBox.xpAttributeLabel.textContent = `XP de ${attributeKey}:`;
        rewardBox.xpAttribute.textContent = `+${calculatedRewards.xp_atributo} XP`;
        rewardBox.coins.textContent = `+${calculatedRewards.moedas} Moedas`;
        
        rewardBox.loading.classList.add('hidden');
        rewardBox.results.classList.remove('hidden');
     }
     
    taskForm.saveBtn.addEventListener('click', async () => {
        const title = taskForm.title.value.trim();
        const hours = parseInt(taskForm.durationHours.value, 10) || 0;
        const minutes = parseInt(taskForm.durationMinutes.value, 10) || 0;
        const totalMinutes = (hours * 60) + minutes;
        
        if (title.length < 3) {
            return showMessage('Missão Inválida', 'O título da missão é muito curto.');
        }
        if (!selectedTaskType) {
            return showMessage('Missão Inválida', 'Selecione um tipo de missão (Hábito, Diária ou Projeto).');
        }
        if (!aiResults || !calculatedRewards) {
            return showMessage('Missão Inválida', 'Aguarde a análise da IA terminar antes de salvar.');
        }
        if (!currentUserId) {
            return showMessage('Erro', 'Usuário não encontrado. Tente relogar.');
        }
        
        const isRecurrenceTemplate = recurrenceRule !== null;

        let taskData = {
            titulo: title,
            tipo: selectedTaskType,
            prioridade: selectedTaskPriority,
            notas: taskForm.notes.value.trim() || null,
            recorrencia: recurrenceRule,
            isTemplate: isRecurrenceTemplate,
            lastGenerated: null,
            duracao_estimada_minutos: totalMinutes > 0 ? totalMinutes : null,
            atributo_associado: aiResults.atributo_associado,
            dificuldade: aiResults.dificuldade,
            recompensa: calculatedRewards,
            status: 'PENDENTE', // NOVO CAMPO DE ESTADO
            createdAt: Timestamp.now(),
            prazo_final: taskForm.deadline.value || null,
            subtarefas: subtasksList,
            anexo_url: null // <-- ADICIONADO
        };
        
        try {
            // Primeiro, faz o upload do anexo, se houver
            if (attachmentFile) {
                const timestamp = Date.now();
                const attachmentRef = ref(storage, `attachments/${currentUserId}/${timestamp}-${attachmentFile.name}`);

                showMessage('Enviando Anexo...', 'Aguarde enquanto o arquivo é enviado.');

                await uploadBytes(attachmentRef, attachmentFile);
                const downloadURL = await getDownloadURL(attachmentRef);
                taskData.anexo_url = downloadURL;

                console.log('Anexo enviado:', downloadURL);
            }

            const tasksRef = collection(db, 'artifacts', appId, 'users', currentUserId, 'tasks');
            await addDoc(tasksRef, taskData);
            
            console.log('Missão salva:', taskData);
            showMessage('Sucesso!', 'Sua nova missão foi adicionada ao registro!');
            showScreen('dashboard');
            
        } catch (error) {
            console.error("Erro ao salvar missão ou anexo:", error);
            showMessage('Erro', `Não foi possível salvar sua missão. Erro: ${error.message}`);
        }
    });

  </script>

</body>
</html>
