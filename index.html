
    async function startGpsActivity(taskId) {
        activityAssociatedTaskId = taskId;

        // ETAPA 1: SEMPRE resetar o estado interno e a UI para uma NOVA corrida.
        // Isso corrige o bug de dados antigos aparecendo em uma nova corrida.
        activityPolyline = [];
        activityTotalDistanceKm = 0;
        activityStartTime = 0;
        activityTotalCalories = 0;
        activityLastTimestamp = 0;
        activityPaused = false;
        activitySegments = [];
        totalPausedTime = 0;
        lastPauseTime = 0;
        currentSegment = null;

        document.getElementById('metric-time').textContent = "00:00:00";
        document.getElementById('metric-distance').textContent = "0.00";
        document.getElementById('metric-avg-speed').textContent = "0.0";
        document.getElementById('metric-calories').textContent = "0";
        renderLiveSegmentHistory(); // Limpa o histórico de etapas na UI

        // ETAPA 2: VERIFICAR se existe um estado salvo para SOBRESCREVER o estado limpo.
        const task = allUserTasks.find(t => t.id === taskId);
        const liveState = task ? task.liveActivityState : null;

        const setupUI = () => {
            if (liveState) {
                // MODO RETOMAR: Carrega os dados salvos e ajusta a UI.
                activityStartTime = liveState.activityStartTime || Date.now();
                totalPausedTime = liveState.totalPausedTime || 0;
                activityTotalDistanceKm = liveState.activityTotalDistanceKm || 0;
                activityTotalCalories = liveState.activityTotalCalories || 0;
                activityPolyline = liveState.activityPolyline ? JSON.parse(liveState.activityPolyline) : [];
                activitySegments = liveState.activitySegments ? JSON.parse(liveState.activitySegments) : [];
                currentSegment = liveState.currentSegment ? JSON.parse(liveState.currentSegment) : null;
                activityPaused = true;
                lastPauseTime = Date.now();

                atualizarMetricasNaTela();
                renderLiveSegmentHistory();

                document.getElementById('btn-start-activity').classList.add('hidden');
                document.getElementById('btn-pause-activity').classList.add('hidden');
                document.getElementById('btn-resume-activity').classList.remove('hidden');
                document.getElementById('btn-finish-activity').classList.remove('hidden');

                // Lógica do mapa para o modo RETOMAR
                navigator.geolocation.getCurrentPosition(pos => {
                    if(mapa) mapa.remove();
                    document.getElementById('mapa-corrida').innerHTML = '';
                    mapa = L.map('mapa-corrida').setView([pos.coords.latitude, pos.coords.longitude], 16);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapa);

                    activitySegments.forEach(seg => {
                        if (seg.points && seg.points.length > 1) L.polyline(seg.points, { color: seg.color }).addTo(mapa);
                    });
                    if (currentSegment && currentSegment.points && currentSegment.points.length > 1) {
                        linhaDoTrajeto = L.polyline(currentSegment.points, { color: currentSegment.color }).addTo(mapa);
                    }
                    if(activityPolyline.length > 0) {
                        const lastPoint = activityPolyline[activityPolyline.length - 1];
                        L.marker(lastPoint).addTo(mapa).bindPopup("Última Posição");
                        mapa.fitBounds(L.latLngBounds(activityPolyline));
                    }
                }, err => {
                     document.getElementById('mapa-corrida').innerHTML = '<p class="text-red-500">Localização falhou.</p>';
                }, { enableHighAccuracy: true });

            } else {
                // MODO NOVA CORRIDA: Apenas ajusta a UI
                document.getElementById('btn-start-activity').classList.remove('hidden');
                document.getElementById('btn-pause-activity').classList.add('hidden');
                document.getElementById('btn-resume-activity').classList.add('hidden');
                document.getElementById('btn-finish-activity').classList.add('hidden');

                // Lógica do mapa para o modo NOVA CORRIDA
                navigator.geolocation.getCurrentPosition(pos => {
                    if(mapa) mapa.remove();
                    document.getElementById('mapa-corrida').innerHTML = '';
                    mapa = L.map('mapa-corrida').setView([pos.coords.latitude, pos.coords.longitude], 16);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapa);
                    L.marker([pos.coords.latitude, pos.coords.longitude]).addTo(mapa);
                }, err => {
                    document.getElementById('mapa-corrida').innerHTML = '<p class="text-red-500">Localização falhou.</p>';
                }, { enableHighAccuracy: true });
            }
        };

        // ETAPA 3: Mostrar a tela e, SÓ DEPOIS, executar a lógica de UI.
        showScreen('activityTracker', null, setupUI);
    }
