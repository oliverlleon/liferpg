<!DOCTYPE html>
<html class="dark" lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RPG da Vida Real - Aventura</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

  <!-- Google Fonts e Ícones -->
  <link href="https://fonts.googleapis.com/css2?family=Spline+Sans:wght@400;500;700&amp;display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

  <!-- Configuração do Tailwind -->
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#13ec6d",
            "background-light": "#f6f8f7",
            "background-dark": "#102218",
            // Cores do novo Hub
            "surface-dark": "#1a3828",
            "text-dark-primary": "#ffffff",
            "text-dark-secondary": "#9db9a8",
            "border-dark": "#335c47",
            "health": "#ef4444",
            "mana": "#3b82f6",
            "xp": "#f59e0b"
          },
          fontFamily: {
            "display": ["Spline Sans", "sans-serif"]
          },
          borderRadius: {
            "DEFAULT": "1rem",
            "lg": "1.5rem",
            "xl": "2rem",
            "full": "9999px"
          },
          boxShadow: {
            'glow-primary': '0 0 15px 0px rgba(19, 236, 109, 0.3)',
          },
        },
      },
    }
  </script>

  <!-- Estilos Globais -->
  <style>
    body {
      min-height: max(884px, 100dvh);
      background-color: #102218;
      font-family: 'Spline Sans', sans-serif;
    }

    .material-symbols-outlined {
      font-variation-settings:
        'FILL' 0,
        'wght' 400,
        'GRAD' 0,
        'opsz' 24;
    }

    /* Classe helper para a seleção de avatar */
    .avatar-selected {
      border-color: #13ec6d !important;
      box-shadow: 0 0 15px 2px rgba(19, 236, 109, 0.5);
    }

    /* Classe helper para o tipo de tarefa selecionado */
    .task-type-selected {
        background-color: #13ec6d !important;
        color: #102218 !important;
        border-color: #13ec6d !important;
    }
  </style>
</head>

<body class="bg-background-light dark:bg-background-dark font-display text-white">

  <!-- Container Principal da Aplicação -->
  <div id="app-container">

    <!-- Tela 1: Abertura (Splash) -->
    <div id="screen-splash" class="relative flex min-h-screen w-full flex-col dark group/design-root overflow-x-hidden">
      <!-- Background Image -->
      <div class="absolute inset-0 z-0">
        <div class="h-full w-full bg-center bg-no-repeat bg-cover opacity-10" data-alt="A subtle, stylized texture resembling an old, weathered fantasy map." style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuD6sSjEhz7hgGMCO9BdTp0pHGvGbE3XMpV6jPLsVzsYPwCqNXpNCbXwpEujggDvZYrE9pQH3Y5d5BVF7gvg7jPZ0AXCp2Nwx2A7FFDzew_5BcOaQSLjVdbARuQ92QAHPYPKFF8zuiCOXoXUsMSviMA_KKbTiUtBIpnFlJBm280neUs4DCq_Bfit7g90h0YuQrldqBiXPliiGMqqxXfOBfNx_NLz-YaO63IyoVmNdwY8nkPEARovFkiWn0qj-T5XhZjUWMi1i1P7O7tL_");'></div>
      </div>
      <!-- Main Content -->
      <div class="relative z-10 flex w-full grow flex-col justify-between p-4 @container min-h-screen">
        <div class="flex flex-1 flex-col items-center justify-center">
          <!-- Logo -->
          <div class="flex flex-col items-center justify-center text-center mb-8">
            <div class="text-primary" data-icon="ShieldCheck" data-size="64px" data-weight="bold">
              <svg class="fill-current" height="64" viewbox="0 0 256 256" width="64" xmlns="http://www.w3.org/2000/svg">
                <path d="M229.06,75.12,139,17.26a16,16,0,0,0-22,0L26.94,75.12A16,16,0,0,0,20,87.82V168a16,16,0,0,0,16,16H220a16,16,0,0,0,16-16V87.82A16,16,0,0,0,229.06,75.12Z" opacity="0.2"></path>
                <path d="M220,48H36A20,20,0,0,0,16,68V188a20,20,0,0,0,20,20H220a20,20,0,0,0,20-20V68A20,20,0,0,0,220,48Zm4,140a4,4,0,0,1-4,4H36a4,4,0,0,1-4-4V68a4,4,0,0,1,4-4H220a4,4,0,0,1,4,4Zm-54.34-82.34-48,48a8,8,0,0,1-11.32,0l-24-24a8,8,0,0,1,11.32-11.32L112,124.69l42.34-42.35a8,8,0,0,1,11.32,11.32Z"></path>
              </svg>
            </div>
            <h1 class="text-white text-3xl font-bold mt-2">RPG da Vida</h1>
          </div>
          <!-- Slogan/Tagline -->
          <h3 class="text-white tracking-light text-2xl font-bold leading-tight px-4 text-center pb-8 pt-5">Sua vida, suas regras, seu próximo nível.</h3>
        </div>
        <!-- Action Buttons and Social Login -->
        <div class="flex w-full flex-col items-center">
          <div class="flex w-full flex-1 flex-col items-stretch gap-3 max-w-[480px] py-3">
            <button id="btn-goto-register" class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-12 px-5 bg-primary text-background-dark text-base font-bold leading-normal tracking-[0.015em] w-full">
              <span class="truncate">Iniciar Jornada</span>
            </button>
            <button id="btn-goto-login" class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-12 px-5 bg-primary/20 text-white text-base font-bold leading-normal tracking-[0.015em] w-full">
              <span class="truncate">Continuar Aventura</span>
            </button>
          </div>
          <p class="text-[#9db9a8]/80 text-sm font-normal leading-normal pb-3 pt-4 px-4 text-center">Ou entre com</p>
          <div class="w-full max-w-[480px]">
            <div class="gap-4 px-4 grid-cols-[repeat(auto-fit,_minmax(80px,_1fr))] grid">
              <div id="btn-google-login" class="flex flex-col items-center gap-2 py-2.5 text-center cursor-pointer">
                <div class="rounded-full bg-primary/20 p-3.5">
                  <span class="material-symbols-outlined text-white text-[24px]">
                    sports_esports
                  </span>
                </div>
                <p class="text-white text-sm font-medium leading-normal">Google</p>
              </div>
              <div class="flex flex-col items-center gap-2 py-2.5 text-center opacity-50 cursor-not-allowed" title="Login com Apple em breve">
                <div class="rounded-full bg-primary/20 p-3.5">
                  <span class="material-symbols-outlined text-white text-[24px]">ios</span>
                </div>
                <p class="text-white text-sm font-medium leading-normal">Apple</p>
              </div>
              <div class="flex flex-col items-center gap-2 py-2.5 text-center opacity-50 cursor-not-allowed" title="Login com Facebook em breve">
                <div class="rounded-full bg-primary/20 p-3.5">
                  <span class="material-symbols-outlined text-white text-[24px]">social_leaderboard</span>
                </div>
                <p class="text-white text-sm font-medium leading-normal">Facebook</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tela 2: Cadastro (Criação de Personagem) -->
    <div id="screen-register" class="hidden relative flex h-auto min-h-screen w-full flex-col bg-background-light dark:bg-background-dark group/design-root overflow-x-hidden">
      <!-- Top App Bar -->
      <div class="flex items-center bg-background-light dark:bg-background-dark p-4 pb-2 justify-between sticky top-0 z-10">
        <button id="reg-back-btn" class="text-white flex size-12 shrink-0 items-center justify-center cursor-pointer">
          <span class="material-symbols-outlined text-3xl">arrow_back</span>
        </button>
        <h2 class="text-white text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center pr-12">Criação de Personagem</h2>
      </div>
      <!-- Page Indicators -->
      <div class="flex w-full flex-row items-center justify-center gap-3 py-5 px-4">
        <div id="progress-1" class="h-1 flex-1 rounded-full bg-primary"></div>
        <div id="progress-2" class="h-1 flex-1 rounded-full bg-primary/20"></div>
        <div id="progress-3" class="h-1 flex-1 rounded-full bg-primary/20"></div>
      </div>
      <main class="flex-grow px-4">
        <!-- Step 1: Identidade -->
        <section class="flex flex-col gap-4" id="step-1">
          <h1 class="text-white tracking-light text-[32px] font-bold leading-tight text-left pb-3 pt-6">Identidade</h1>
          <div class="flex flex-col gap-4">
            <label class="flex flex-col w-full">
              <p class="text-white text-base font-medium leading-normal pb-2">Nome de Aventureiro</p>
              <input id="reg-nickname" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-white focus:outline-0 focus:ring-0 border border-primary/30 bg-[#1C2720] focus:border-primary h-14 placeholder:text-white/40 p-[15px] text-base font-normal leading-normal" placeholder="Ex: Aragorn" value="" />
            </label>
            <label class="flex flex-col w-full">
              <p class="text-white text-base font-medium leading-normal pb-2">Email</p>
              <input id="reg-email" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-white focus:outline-0 focus:ring-0 border border-primary/30 bg-[#1C2720] focus:border-primary h-14 placeholder:text-white/40 p-[15px] text-base font-normal leading-normal" placeholder="seu.email@dominio.com" type="email" value="" />
            </label>
            <label class="flex flex-col w-full">
              <p class="text-white text-base font-medium leading-normal pb-2">Senha</p>
              <input id="reg-password" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-white focus:outline-0 focus:ring-0 border border-primary/30 bg-[#1C2720] focus:border-primary h-14 placeholder:text-white/40 p-[15px] text-base font-normal leading-normal" placeholder="Crie uma senha forte" type="password" value="" />
            </label>
          </div>
        </section>
        <!-- Step 2: Vitals -->
        <section class="hidden flex-col gap-4" id="step-2">
          <h1 class="text-white tracking-light text-[32px] font-bold leading-tight text-left pb-1 pt-6">Atributos Físicos</h1>
          <p class="text-white/70 text-base font-normal leading-normal px-0 pb-4">Esses são seus "atributos base" iniciais. Você poderá evoluí-los durante sua jornada.</p>
          <div class="flex flex-col gap-4">
            <label class="flex flex-col w-full">
              <p class="text-white text-base font-medium leading-normal pb-2">Altura (cm)</p>
              <input id="reg-height" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-white focus:outline-0 focus:ring-0 border border-primary/30 bg-[#1C2720] focus:border-primary h-14 placeholder:text-white/40 p-[15px] text-base font-normal leading-normal" placeholder="Ex: 180" type="number" value="" />
            </label>
            <div class="grid grid-cols-2 gap-4">
              <label class="flex flex-col w-full">
                <p class="text-white text-base font-medium leading-normal pb-2">Peso Atual (kg)</p>
                <input id="reg-weight" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-white focus:outline-0 focus:ring-0 border border-primary/30 bg-[#1C2720] focus:border-primary h-14 placeholder:text-white/40 p-[15px] text-base font-normal leading-normal" placeholder="Ex: 85" type="number" value="" />
              </label>
              <label class="flex flex-col w-full">
                <p class="text-white text-base font-medium leading-normal pb-2">Meta de Peso (kg)</p>
                <input id="reg-weight-target" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-white focus:outline-0 focus:ring-0 border border-primary/30 bg-[#1C2720] focus:border-primary h-14 placeholder:text-white/40 p-[15px] text-base font-normal leading-normal" placeholder="Ex: 80" type="number" value="" />
              </label>
            </div>
          </div>
        </section>
        <!-- Step 3: Aparência -->
        <section class="hidden flex-col gap-4" id="step-3">
          <h1 class="text-white tracking-light text-[32px] font-bold leading-tight text-left pb-1 pt-6">Aparência</h1>
          <p class="text-white/70 text-base font-normal leading-normal px-0 pb-4">Escolha sua representação no jogo. Esta será sua identidade visual.</p>
          <div class="grid grid-cols-2 gap-4" id="avatar-selection">
            <div class="avatar-option aspect-square bg-primary/20 rounded-lg flex items-center justify-center border-2 border-transparent cursor-pointer transition-all" data-avatar-url="https://lh3.googleusercontent.com/aida-public/AB6AXuDTxayBmUlfJy71v5imptwwCT0UyzBNOkbhEA-t6F2WaM8NWdT5j0bfCglTU4pllPR2e_1y6jYkKhzENWZrh1VKExhriwROlAjFE7YD3FxTA6CFpG80I7MBWdHw2RFQ6MPMK9AP6tB8eoFjjtVXcpwxntGiq995k5WVtg_7PNsrhToO7kcyGsjqtQ8yYsD4kKHSFVTG_6fC86DCZOGTRR6MVocBqIfg0hoU_0pBKWQ-GBcl10KH3aQAJV5ku9BFDaHxpGqfEgXb85eG">
              <img class="w-full h-full object-cover rounded-lg" alt="Avatar de uma mulher com cabelos escuros e olhar sério." src="https://lh3.googleusercontent.com/aida-public/AB6AXuDTxayBmUlfJy71v5imptwwCT0UyzBNOkbhEA-t6F2WaM8NWdT5j0bfCglTU4pllPR2e_1y6jYkKhzENWZrh1VKExhriwROlAjFE7YD3FxTA6CFpG80I7MBWdHw2RFQ6MPMK9AP6tB8eoFjjtVXcpwxntGiq995k5WVtg_7PNsrhToO7kcyGsjqtQ8yYsD4kKHSFVTG_6fC86DCZOGTRR6MVocBqIfg0hoU_0pBKWQ-GBcl10KH3aQAJV5ku9BFDaHxpGqfEgXb85eG" />
            </div>
            <div class="avatar-option aspect-square bg-primary/20 rounded-lg flex items-center justify-center border-2 border-transparent cursor-pointer transition-all" data-avatar-url="https://lh3.googleusercontent.com/aida-public/AB6AXuD1-IRdijy5eIYxAJ8uLTiddsEQK3MJwU5C_RvIxbDB9hNknG2wwTYDShf_fTx_J4zhN90tO-xtflTqR4QukN-Vw09rmrUe_2RUryc74DsE84MJcvzOVP7mu52BaYchp6OI0cYIZO0-kIwmZfI85sAot-g-CrAR9eLRT-2anb-SRe86Cj1sCqJSbiRWOpOJDLWbrm4MCVXxMP31_p3E3B3vIzqAuquxMz-f3s_XKhmHY7ekL2tWx0qoM3JDAe__2XXs0iCCaRrAJ0yE">
              <img class="w-full h-full object-cover rounded-lg" alt="Avatar de um homem com barba e cabelo claro." src="https://lh3.googleusercontent.com/aida-public/AB6AXuD1-IRdijy5eIYxAJ8uLTiddsEQK3MJwU5C_RvIxbDB9hNknG2wwTYDShf_fTx_J4zhN90tO-xtflTqR4QukN-Vw09rmrUe_2RUryc74DsE84MJcvzOVP7mu52BaYchp6OI0cYIZO0-kIwmZfI85sAot-g-CrAR9eLRT-2anb-SRe86Cj1sCqJSbiRWOpOJDLWbrm4MCVXxMP31_p3E3B3vIzqAuquxMz-f3s_XKhmHY7ekL2tWx0qoM3JDAe__2XXs0iCCaRrAJ0yE" />
            </div>
            <div class="avatar-option aspect-square bg-primary/20 rounded-lg flex items-center justify-center border-2 border-transparent cursor-pointer transition-all" data-avatar-url="https://lh3.googleusercontent.com/aida-public/AB6AXuCwJvAfIhox0DQ7co5wKoPWq0KzXMm51LJPD_1nNcjur8TKp2PPRLlgHNdSdPSdSaq6X6P0n8syWafh4hKCORvoUMXl1dBJHiV0mSjoL7xSGkhY2gRcWPX2y-AIh0pWYCfQPYWl0CqjgTNtl88r-pfB12qjAECTYmw3rnbUwQC4WjY8qnOqWd80zLeT-2I66Y5nRV9yCZNjaCpzE4zvqgDL3gHyjcCVPAyo2qIfLwD-NY6aajvPCgnr_G8w03U2yDgYPlSvZVMcsKgY">
              <img class="w-full h-full object-cover rounded-lg" alt="Avatar de uma mulher com sardas e cabelo castanho." src="https://lh3.googleusercontent.com/aida-public/AB6AXuCwJvAfIhox0DQ7co5wKoPWq0KzXMm51LJPD_1nNcjur8TKp2PPRLlgHNdSdPSdSaq6X6P0n8syWafh4hKCORvoUMXl1dBJHiV0mSjoL7xSGkhY2gRcWPX2y-AIh0pWYCfQPYWl0CqjgTNtl88r-pfB12qjAECTYmw3rnbUwQC4WjY8qnOqWd80zLeT-2I66Y5nRV9yCZNjaCpzE4zvqgDL3gHyjcCVPAyo2qIfLwD-NY6aajvPCgnr_G8w03U2yDgYPlSvZVMcsKgY" />
            </div>
            <div class="avatar-option aspect-square bg-primary/20 rounded-lg flex items-center justify-center border-2 border-transparent cursor-pointer transition-all" data-avatar-url="https://lh3.googleusercontent.com/aida-public/AB6AXuCaowuyHYeVV7QLQqkErji5qLb-CvJFR_rMYtZL7M6YLr1_O81-xKH-NNRhUm420Z8-FlXfIjQJmh8Xsq7ZKS2zyPFvLqGKvJSn_qgtwm71_5hCGdwD8ZRu9nvr2r93N39r1md_0C_ux1921h8wuWOD-OqZYoIL1nP4laPvRN0A-fQBRFxRr-Mz1J_7qnacmNgqF2h_srHsnmNr6kqETAh9l9wSS0FzA8na_BvHMxHN8E7E6wj-4ZIiXEsZ5ulR7MCUFhJcjDMfdJT5">
              <img class="w-full h-full object-cover rounded-lg" alt="Avatar de um homem sorrindo com cabelo escuro." src="https://lh3.googleusercontent.com/aida-public/AB6AXuCaowuyHYeVV7QLQqkErji5qLb-CvJFR_rMYtZL7M6YLr1_O81-xKH-NNRhUm420Z8-FlXfIjQJmh8Xsq7ZKS2zyPFvLqGKvJSn_qgtwm71_5hCGdwD8ZRu9nvr2r93N39r1md_0C_ux1921h8wuWOD-OqZYoIL1nP4laPvRN0A-fQBRFxRr-Mz1J_7qnacmNgqF2h_srHsnmNr6kqETAh9l9wSS0FzA8na_BvHMxHN8E7E6wj-4ZIiXEsZ5ulR7MCUFhJcjDMfdJT5" />
            </div>
          </div>
        </section>
      </main>
      <!-- Footer with Action Button -->
      <footer class="sticky bottom-0 bg-background-light dark:bg-background-dark p-4 pt-6">
        <button id="reg-next-btn" class="flex w-full items-center justify-center rounded-xl bg-primary h-14 text-background-dark text-lg font-bold">
          Próximo
        </button>
      </footer>
    </div>

    <!-- Tela 3: Login (Acessar Personagem) -->
    <div id="screen-login" class="hidden relative flex h-auto min-h-screen w-full flex-col items-center bg-background-light dark:bg-background-dark group/design-root overflow-x-hidden p-4">
      <button id="login-back-btn" class="text-white flex size-12 shrink-0 items-center justify-center cursor-pointer absolute top-4 left-4 z-10">
        <span class="material-symbols-outlined text-3xl">arrow_back</span>
      </button>
      <div class="flex w-full max-w-md flex-col items-center justify-center pt-20 pb-8">
        <svg class="h-20 w-20 text-primary" fill="none" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" fill="currentColor"></path>
        </svg>
        <h1 class="text-white text-2xl font-bold leading-tight text-center tracking-wider mt-4">RPG DA VIDA REAL</h1>
      </div>
      <div class="w-full max-w-md">
        <h1 class="text-white tracking-light text-[32px] font-bold leading-tight px-4 text-center pb-8 pt-6">Acessar seu Personagem</h1>
        <div class="flex w-full flex-col gap-4 px-4 py-3">
          <label class="flex flex-col w-full flex-1">
            <p class="text-white text-base font-medium leading-normal pb-2">Email</p>
            <div class="flex w-full flex-1 items-stretch rounded-xl border border-[#3b5445] bg-[#1c2720] focus-within:ring-2 focus-within:ring-primary focus-within:border-primary">
              <div class="text-[#9db9a8] flex items-center justify-center pl-[15px]">
                <span class="material-symbols-outlined">person</span>
              </div>
              <input id="login-email" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden text-white focus:outline-0 focus:ring-0 border-0 bg-transparent h-14 placeholder:text-[#9db9a8] p-[15px] text-base font-normal leading-normal" placeholder="Digite seu email" value="" />
            </div>
          </label>
        </div>
        <div class="flex w-full flex-col gap-4 px-4 py-3">
          <label class="flex flex-col w-full flex-1">
            <p class="text-white text-base font-medium leading-normal pb-2">Senha</p>
            <div class="flex w-full flex-1 items-stretch rounded-xl border border-[#3b5445] bg-[#1c2720] focus-within:ring-2 focus-within:ring-primary focus-within:border-primary">
              <div class="text-[#9db9a8] flex items-center justify-center pl-[15px]">
                <span class="material-symbols-outlined">lock</span>
              </div>
              <input id="login-password" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden text-white focus:outline-0 focus:ring-0 border-0 bg-transparent h-14 placeholder:text-[#9db9a8] p-[15px] text-base font-normal leading-normal" placeholder="Digite sua senha" type="password" value="" />
              <button class="text-[#9db9a8] flex items-center justify-center pr-[15px] bg-transparent border-0" onclick="togglePasswordVisibility('login-password', this)">
                <span class="material-symbols-outlined">visibility</span>
              </button>
            </div>
          </label>
        </div>
        <div class="flex px-4 py-6">
          <button id="login-btn" class="flex min-w-[84px] w-full cursor-pointer items-center justify-center overflow-hidden rounded-full h-12 px-5 flex-1 bg-primary text-[#111814] text-base font-bold leading-normal tracking-[0.015em] hover:bg-opacity-90 transition-opacity">
            <span class="truncate">[ Entrar ]</span>
          </button>
        </div>
        <p id="login-forgot-link" class="text-[#9db9a8] text-sm font-normal leading-normal pb-3 pt-1 px-4 text-center underline cursor-pointer hover:text-primary transition-colors">Perdeu o mapa? (Esqueci a senha)</p>
      </div>
    </div>

    <!-- Tela 4: Recuperação de Senha -->
    <div id="screen-forgot-password" class="hidden relative flex min-h-screen w-full flex-col antialiased">
      <main class="flex flex-1 flex-col">
        <div class="flex items-center p-4">
          <button id="forgot-back-btn" class="text-white flex size-12 shrink-0 items-center justify-start cursor-pointer">
            <span class="material-symbols-outlined text-3xl text-slate-300 dark:text-slate-400">arrow_back</span>
          </button>
          <h1 class="flex-1 text-center text-lg font-bold leading-tight tracking-[-0.015em] text-slate-800 dark:text-white -ml-12">Recuperação de Aventura</h1>
        </div>
        <div class="flex flex-1 flex-col justify-center px-4">
          <div class="flex flex-col items-center">
            <p class="text-center text-base font-normal leading-normal text-slate-600 dark:text-slate-300">Enviaremos um 'Pergaminho de Recuperação' para seu email.</p>
          </div>
          <div class="mt-8 mb-4 flex w-full max-w-[480px] flex-col self-center">
            <label class="flex w-full flex-col">
              <p class="pb-2 text-base font-medium leading-normal text-slate-800 dark:text-white">Seu Email</p>
              <div class="relative flex w-full flex-1 items-stretch">
                <input id="forgot-email" class="form-input flex h-14 w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg border border-slate-300/70 bg-background-light p-4 pr-12 text-base font-normal leading-normal text-slate-900 placeholder:text-slate-400 focus:border-primary/80 focus:outline-none focus:ring-2 focus:ring-primary/40 dark:border-slate-700 dark:bg-background-dark dark:text-white dark:placeholder:text-slate-500 dark:focus:border-primary" placeholder="seu-heroi@email.com" value="" />
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center justify-center pr-4 text-slate-400 dark:text-slate-500">
                  <span class="material-symbols-outlined">mail</span>
                </div>
              </div>
            </label>
          </div>
          <div class="mt-4 flex w-full max-w-[480px] self-center">
            <button id="forgot-btn" class="flex h-12 min-w-[84px] flex-1 cursor-pointer items-center justify-center overflow-hidden rounded-full bg-primary px-5 text-base font-bold leading-normal tracking-[0.015em] text-slate-900 transition-colors hover:bg-primary/90">
              <span class="truncate">Enviar Pergaminho de Recuperação</span>
            </button>
          </div>
          <div class="mt-2 flex w-full max-w-[480px] justify-center self-center">
            <button id="forgot-cancel-btn" class="flex h-10 min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-full bg-transparent px-4 text-sm font-bold leading-normal tracking-[0.015em] text-slate-500 transition-colors hover:bg-slate-500/10 dark:text-slate-400 dark:hover:bg-slate-400/10">
              <span class="truncate">Cancelar</span>
            </button>
          </div>
        </div>
      </main>
    </div>

    <!-- Tela 5: Dashboard (Logado) - NOVO DESIGN -->
    <div id="screen-dashboard" class="hidden relative flex min-h-screen w-full flex-col overflow-x-hidden">
      <!-- Background -->
      <div class="absolute inset-0 z-0">
        <div class="h-full w-full bg-center bg-no-repeat bg-cover opacity-10" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuD6sSjEhz7hgGMCO9BdTp0pHGvGbE3XMpV6jPLsVzsYPwCqNXpNCbXwpEujggDvZYrE9pQH3Y5d5BVF7gvg7jPZ0AXCp2Nwx2A7FFDzew_5BcOaQSLjVdbARuQ92QAHPYPKFF8zuiCOXoXUsMSviMA_KKbTiUtBIpnFlJBm280neUs4DCq_Bfit7g90h0YuQrldqBiXPliiGMqqxXfOBfNx_NLz-YaO63IyoVmNdwY8nkPEARovFkiWn0qj-T5XhZjUWMi1i1P7O7tL_");'></div>
      </div>
      <!-- Conteúdo do Hub -->
      <div class="relative z-10 flex w-full grow flex-col pb-24">
        <!-- Header -->
        <header class="flex items-center justify-between p-4">
          <div class="flex items-center gap-3">
            <img id="hub-avatar" alt="Avatar do Aventureiro" class="h-12 w-12 rounded-full border-2 border-primary" src="https://placehold.co/100x100/1a3828/13ec6d?text=?" />
            <div>
              <h1 id="hub-nickname" class="text-xl font-bold">Carregando...</h1>
              <p id="hub-level-title" class="text-sm text-text-dark-secondary">
                <span id="hub-level">Nv. 1</span>
              </p>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <button class="flex h-10 w-10 items-center justify-center rounded-full bg-surface-dark/80 backdrop-blur-sm">
              <span class="material-symbols-outlined text-text-dark-secondary">leaderboard</span>
            </button>
            <button class="flex h-10 w-10 items-center justify-center rounded-full bg-surface-dark/80 backdrop-blur-sm">
              <span class="material-symbols-outlined text-text-dark-secondary">notifications</span>
            </button>
          </div>
        </header>

        <!-- Barras de Status -->
        <section class="px-4 py-2">
          <div class="flex flex-col gap-2.5 rounded-lg bg-surface-dark/50 p-4 backdrop-blur-sm border border-border-dark">
            <!-- HP -->
            <div class="flex items-center gap-2">
              <span class="material-symbols-outlined text-health text-lg">favorite</span>
              <div class="h-2.5 w-full flex-1 rounded-full bg-background-dark">
                <div id="hub-hp-bar" class="h-2.5 rounded-full bg-health" style="width: 100%"></div>
              </div>
              <span id="hub-hp-text" class="text-sm font-semibold text-text-dark-secondary">100/100</span>
            </div>
            <!-- Mana -->
            <div class="flex items-center gap-2">
              <span class="material-symbols-outlined text-mana text-lg">bolt</span>
              <div class="h-2.5 w-full flex-1 rounded-full bg-background-dark">
                <div id="hub-mana-bar" class="h-2.5 rounded-full bg-mana" style="width: 100%"></div>
              </div>
              <span id="hub-mana-text" class="text-sm font-semibold text-text-dark-secondary">100/100</span>
            </div>
            <!-- XP -->
            <div class="flex items-center gap-2">
              <span class="material-symbols-outlined text-xp text-lg">star</span>
              <div class="h-2.5 w-full flex-1 rounded-full bg-background-dark">
                <div id="hub-xp-bar" class="h-2.5 rounded-full bg-xp" style="width: 0%"></div>
              </div>
              <span id="hub-xp-text" class="text-sm font-semibold text-text-dark-secondary">0/1000</span>
            </div>
          </div>
        </section>

        <!-- Atributos e Status -->
        <section class="grid grid-cols-2 gap-4 px-4 py-2">
          <!-- Atributos -->
          <div class="flex flex-col gap-2 rounded-lg bg-surface-dark/50 p-4 backdrop-blur-sm border border-border-dark">
            <h2 class="text-base font-bold text-primary">Atributos</h2>
            <div id="hub-stats-forca" class="flex items-center gap-2 text-sm">
              <span class="material-symbols-outlined text-red-400 text-base">swords</span>
              <span>Força: 1</span>
            </div>
            <div id="hub-stats-inteligencia" class="flex items-center gap-2 text-sm">
              <span class="material-symbols-outlined text-blue-400 text-base">school</span>
              <span>Inteligência: 1</span>
            </div>
            <div id="hub-stats-vitalidade" class="flex items-center gap-2 text-sm">
              <span class="material-symbols-outlined text-green-400 text-base">shield</span>
              <span>Vitalidade: 1</span>
            </div>
            <div id="hub-stats-velocidade" class="flex items-center gap-2 text-sm">
              <span class="material-symbols-outlined text-yellow-400 text-base">sprint</span>
              <span>Velocidade: 1</span>
            </div>
          </div>
          <!-- Status Atuais -->
          <div class="flex flex-col gap-2 rounded-lg bg-surface-dark/50 p-4 backdrop-blur-sm border border-border-dark">
            <h2 class="text-base font-bold text-primary">Status Atuais</h2>
            <div id="hub-status-effects" class="flex flex-col gap-2">
              <!-- Status são inseridos dinamicamente aqui -->
              <p class="text-sm text-text-dark-secondary">Nenhum efeito ativo.</p>
            </div>
          </div>
        </section>

        <!-- Registro de Missões -->
        <section class="flex flex-col gap-3 px-4 py-2">
          <h2 class="text-lg font-bold">Registro de Missões</h2>
          <div id="hub-mission-list" class="flex flex-col gap-3">
            <!-- Missões são inseridas dinamicamente aqui -->
            <p class="text-sm text-text-dark-secondary p-4">Nenhuma missão encontrada. Adicione uma nova!</p>
          </div>
        </section>
      </div>

      <!-- Botão Adicionar Missão -->
      <div class="fixed bottom-24 right-4 z-20">
        <button id="btn-show-add-task" class="flex h-16 w-16 items-center justify-center rounded-full bg-primary text-background-dark shadow-lg shadow-primary/30">
          <span class="material-symbols-outlined text-4xl">add</span>
        </button>
      </div>

      <!-- Navegação Principal -->
      <nav class="fixed bottom-0 left-0 right-0 z-20 border-t border-border-dark bg-surface-dark/80 backdrop-blur-lg">
        <div class="mx-auto flex h-20 max-w-md items-center justify-around px-4">
          <a classa="flex flex-col items-center gap-1 text-primary" href="#">
            <span class="material-symbols-outlined">home</span>
            <span class="text-xs font-bold">Início</span>
          </a>
          <a class="flex flex-col items-center gap-1 text-text-dark-secondary" href="#">
            <span class="material-symbols-outlined">shield_person</span>
            <span class="text-xs">Personagem</span>
          </a>
          <a class="flex flex-col items-center gap-1 text-text-dark-secondary" href="#">
            <span class="material-symbols-outlined">swords</span>
            <span class="text-xs">Guilda</span>
          </a>
          <a class="flex flex-col items-center gap-1 text-text-dark-secondary" href="#">
            <span class="material-symbols-outlined">store</span>
            <span class="text-xs">Mercado</span>
          </a>
          <a id="hub-logout-btn" class="flex flex-col items-center gap-1 text-text-dark-secondary cursor-pointer" href="#">
            <span class="material-symbols-outlined">settings</span>
            <span class="text-xs">Opções</span>
          </a>
        </div>
      </nav>
    </div>

    <!-- Tela 6: Criar Nova Tarefa (IA) -->
    <div id="screen-add-task" class="hidden relative flex min-h-screen w-full flex-col bg-background-dark">
      <!-- Header -->
      <div class="flex items-center bg-background-dark p-4 pb-2 justify-between sticky top-0 z-10">
        <button id="task-back-btn" class="text-white flex size-12 shrink-0 items-center justify-center cursor-pointer">
          <span class="material-symbols-outlined text-3xl">arrow_back</span>
        </button>
        <h2 class="text-white text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center pr-12">Criar Nova Missão</h2>
      </div>

      <!-- Formulário -->
      <main class="flex-grow p-4 space-y-6">
        <!-- Título -->
        <label class="flex flex-col w-full">
          <p class="text-white text-base font-medium leading-normal pb-2">Título da Missão</p>
          <input id="task-title" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-white focus:outline-0 focus:ring-0 border border-primary/30 bg-[#1C2720] focus:border-primary h-14 placeholder:text-white/40 p-[15px] text-base font-normal leading-normal" placeholder="Ex: Correr 30 min na esteira" value="" />
        </label>
        
        <!-- Tipo de Missão -->
        <div>
           <p class="text-white text-base font-medium leading-normal pb-2">Tipo de Missão (Sua escolha)</p>
           <div id="task-type-group" class="grid grid-cols-3 gap-3">
               <button data-type="habito" class="task-type-btn flex items-center justify-center rounded-lg border-2 border-border-dark bg-surface-dark/50 p-4 font-bold text-text-dark-secondary transition-all">
                 <span class="material-symbols-outlined mr-2">menu_book</span> Hábito
               </button>
               <button data-type="diaria" class="task-type-btn flex items-center justify-center rounded-lg border-2 border-border-dark bg-surface-dark/50 p-4 font-bold text-text-dark-secondary transition-all">
                 <span class="material-symbols-outlined mr-2">fitness_center</span> Diária
               </button>
               <button data-type="projeto" class="task-type-btn flex items-center justify-center rounded-lg border-2 border-border-dark bg-surface-dark/50 p-4 font-bold text-text-dark-secondary transition-all">
                 <span class="material-symbols-outlined mr-2">work</span> Projeto
               </button>
           </div>
        </div>

        <!-- Duração (Opcional) -->
        <div>
            <p class="text-white/70 text-base font-medium leading-normal pb-2">Duração Estimada (Opcional)</p>
            <div class="grid grid-cols-2 gap-4">
                <label class="flex flex-col w-full">
                    <p class="text-white/70 text-sm pb-1">Horas</p>
                    <input id="task-duration-hours" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-white focus:outline-0 focus:ring-0 border border-primary/30 bg-[#1C2720] focus:border-primary h-14 placeholder:text-white/40 p-[15px] text-base font-normal leading-normal" type="number" min="0" placeholder="0" />
                </label>
                <label class="flex flex-col w-full">
                    <p class="text-white/70 text-sm pb-1">Minutos</p>
                    <input id="task-duration-minutes" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-white focus:outline-0 focus:ring-0 border border-primary/30 bg-[#1C2720] focus:border-primary h-14 placeholder:text-white/40 p-[15px] text-base font-normal leading-normal" type="number" min="0" max="59" placeholder="30" />
                </label>
            </div>
        </div>

        <!-- Prazos (Opcional) -->
        <div class="grid grid-cols-2 gap-4">
            <label class="flex flex-col w-full">
              <p class="text-white/70 text-base font-medium leading-normal pb-2">Prazo Final (Opcional)</p>
              <input id="task-deadline" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-white focus:outline-0 focus:ring-0 border border-primary/30 bg-[#1C2720] focus:border-primary h-14 placeholder:text-white/40 p-[15px] text-base font-normal leading-normal" type="date" />
            </label>
            <label class="flex flex-col w-full">
              <p class="text-white/70 text-base font-medium leading-normal pb-2">Lembrete (Opcional)</p>
              <input id="task-reminder" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-white focus:outline-0 focus:ring-0 border border-primary/30 bg-[#1C2720] focus:border-primary h-14 placeholder:text-white/40 p-[15px] text-base font-normal leading-normal" type="time" />
            </label>
        </div>

        <!-- Estimativa de Recompensa (IA) -->
        <div>
          <p class="text-white text-base font-medium leading-normal pb-2">Análise da Missão (IA)</p>
          <div class="rounded-lg bg-surface-dark/50 p-4 backdrop-blur-sm border border-border-dark min-h-[160px] flex items-center justify-center">

            <!-- Estado Inicial/Carregando -->
            <div id="reward-loading" class="text-center text-text-dark-secondary">
              <div id="reward-spinner" class="hidden animate-spin w-6 h-6 border-2 border-primary border-t-transparent rounded-full mx-auto mb-3"></div>
              <p id="reward-loading-text">Digite sua missão para calcularmos a recompensa...</p>
            </div>

            <!-- Resultados da IA -->
            <div id="reward-results" class="hidden w-full space-y-2">
                <div class="flex justify-between items-center">
                    <span class="font-bold text-primary">Atributo:</span>
                    <span id="reward-attribute" class="font-bold uppercase"></span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="font-bold text-primary">Dificuldade:</span>
                    <span id="reward-difficulty" class="font-bold uppercase"></span>
                </div>
                <hr class="border-border-dark my-2" />
                <div class="flex justify-between items-center text-xp">
                    <span class="font-bold">XP Global:</span>
                    <span id="reward-xp-global" class="font-bold"></span>
                </div>
                <div class="flex justify-between items-center text-xp">
                    <span id="reward-xp-attribute-label" class="font-bold">XP de Atributo:</span>
                    <span id="reward-xp-attribute" class="font-bold"></span>
                </div>
                <div class="flex justify-between items-center text-yellow-400">
                    <span class="font-bold">Moedas:</span>
                    <span id="reward-coins" class="font-bold"></span>
                </div>
            </div>

          </div>
        </div>
      </main>

      <!-- Footer com Botão Salvar -->
      <footer class="sticky bottom-0 bg-background-dark p-4 pt-6">
        <button id="task-save-btn" class="flex w-full items-center justify-center rounded-xl bg-primary h-14 text-background-dark text-lg font-bold">
          Salvar Missão
        </button>
      </footer>
    </div>


  </div>

  <!-- Modal de Mensagem/Erro -->
  <div id="modal-message" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
    <div class="bg-[#1C2720] border border-primary/50 rounded-lg p-6 w-full max-w-sm text-center">
      <h3 id="modal-title" class="text-primary text-xl font-bold mb-3"></h3>
      <p id="modal-body" class="text-white/90 mb-6"></p>
      <button id="modal-close-btn" class="flex min-w-[84px] w-full cursor-pointer items-center justify-center overflow-hidden rounded-full h-12 px-5 bg-primary text-[#111814] text-base font-bold">
        Entendido
      </button>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script type="module">
    // Importações do Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth,
      signInAnonymously,
      signInWithCustomToken,
      onAuthStateChanged,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      sendPasswordResetEmail,
      GoogleAuthProvider,
      signInWithPopup,
      signOut,
      updateProfile
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      getDoc,
      onSnapshot,
      collection,
      addDoc, // <--- ADICIONADO
      setLogLevel,
      Timestamp
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Exibe o Domínio para Autorização no Firebase ---
    const currentHostname = window.location.hostname;
    console.warn('--- DOMÍNIO PARA AUTORIZAR NO FIREBASE ---');
    console.warn('Para o Login com Google funcionar, adicione este domínio à sua lista de "Domínios autorizados" no Firebase Auth -> Configurações:');
    console.warn(currentHostname);
    console.warn('----------------------------------------------');

    // --- Configuração do Firebase ---
    // Configuração fornecida pelo usuário
    const firebaseConfigUser = {
      apiKey: "AIzaSyBeLq53I4Zu8TIcttgYwcyhFUBu4uneCxQ",
      authDomain: "rpglife-8f33d.firebaseapp.com",
      projectId: "rpglife-8f33d",
      storageBucket: "rpglife-8f33d.firebasestorage.app",
      messagingSenderId: "428052124083",
      appId: "1:428052124083:web:1190108bd19638ad2bfbc6",
      measurementId: "G-5LCK5W2JNH"
    };

    // Configuração do Canvas (obrigatória)
    const firebaseConfig = typeof __firebase_config !== 'undefined'
      ? JSON.parse(__firebase_config)
      : firebaseConfigUser;

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'rpglife-app';

    // Inicialização do Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    setLogLevel('Debug'); // Para logs detalhados no console

    // --- Variáveis de Estado Global ---
    let currentUserId = null;
    let profileListener = null; // Para o listener do onSnapshot do perfil
    let tasksListener = null; // Para o listener do onSnapshot das tarefas
    let currentRegistrationStep = 1;
    let selectedAvatarUrl = null;

    // --- Variáveis da Tela de Tarefas ---
    let selectedTaskType = null; // 'habito', 'diaria', 'projeto'
    let aiResults = null; // { atributo_associado, dificuldade }
    let calculatedRewards = null; // { xp_global, xp_atributo, moedas }
    let debounceTimer = null;

    // --- Tabelas Base de Recompensa (Conforme GDD) ---
    // XP de Atributo (baseado na dificuldade)
    const REWARDS_DIFFICULTY = {
        FACIL: { xp_attr: 10 },
        MEDIA: { xp_attr: 25 },
        DIFICIL: { xp_attr: 50 }
    };
    // XP Global e Moedas (baseado no tipo)
    const REWARDS_TYPE = {
        habito:  { xp_global: 5,  moedas: 5 },
        diaria:  { xp_global: 15, moedas: 10 },
        projeto: { xp_global: 75, moedas: 50 }
    };

    // --- Seletores de Elementos ---
    const screens = {
      splash: document.getElementById('screen-splash'),
      register: document.getElementById('screen-register'),
      login: document.getElementById('screen-login'),
      forgot: document.getElementById('screen-forgot-password'),
      dashboard: document.getElementById('screen-dashboard'),
      addTask: document.getElementById('screen-add-task') // <-- NOVA TELA
    };

    const registerSteps = {
      step1: document.getElementById('step-1'),
      step2: document.getElementById('step-2'),
      step3: document.getElementById('step-3')
    };

    const taskForm = {
        title: document.getElementById('task-title'),
        typeGroup: document.getElementById('task-type-group'),
        typeButtons: document.querySelectorAll('.task-type-btn'),
        priorityGroup: document.getElementById('task-priority-group'),
        priorityButtons: document.querySelectorAll('.task-priority-btn'),
        durationHours: document.getElementById('task-duration-hours'),
        durationMinutes: document.getElementById('task-duration-minutes'),
        deadline: document.getElementById('task-deadline'),
        openRecurrenceBtn: document.getElementById('btn-open-recurrence'),
        recurrenceSummary: document.getElementById('recurrence-summary'),
        notes: document.getElementById('task-notes'),
        subtaskInput: document.getElementById('task-subtask-input'),
        addSubtaskBtn: document.getElementById('task-add-subtask-btn'),
        subtaskList: document.getElementById('task-subtask-list'),
        saveBtn: document.getElementById('task-save-btn'),
        backBtn: document.getElementById('task-back-btn')
    };

    const rewardBox = {
        loading: document.getElementById('reward-loading'),
        loadingText: document.getElementById('reward-loading-text'),
        spinner: document.getElementById('reward-spinner'),
        results: document.getElementById('reward-results'),
        attribute: document.getElementById('reward-attribute'),
        difficulty: document.getElementById('reward-difficulty'),
        xpGlobal: document.getElementById('reward-xp-global'),
        xpAttribute: document.getElementById('reward-xp-attribute'),
        xpAttributeLabel: document.getElementById('reward-xp-attribute-label'),
        coins: document.getElementById('reward-coins')
    };

    const progressBars = {
      p1: document.getElementById('progress-1'),
      p2: document.getElementById('progress-2'),
      p3: document.getElementById('progress-3')
    };

    const modal = {
      container: document.getElementById('modal-message'),
      title: document.getElementById('modal-title'),
      body: document.getElementById('modal-body'),
      closeBtn: document.getElementById('modal-close-btn')
    };

    // Inputs de Cadastro
    const regInputs = {
      nickname: document.getElementById('reg-nickname'),
      email: document.getElementById('reg-email'),
      password: document.getElementById('reg-password'),
      height: document.getElementById('reg-height'),
      weight: document.getElementById('reg-weight'),
      weightTarget: document.getElementById('reg-weight-target')
    };

    // Inputs de Login
    const loginInputs = {
      email: document.getElementById('login-email'),
      password: document.getElementById('login-password')
    };

    // --- Funções Auxiliares ---

    /**
     * Mostra uma tela específica e esconde as outras
     * @param {string} screenId ('splash', 'register', 'login', 'forgot', 'dashboard', 'addTask')
     */
    function showScreen(screenId) {
      console.log(`Navegando para: ${screenId}`);
      Object.values(screens).forEach(screen => screen.classList.add('hidden'));
      if (screens[screenId]) {
        screens[screenId].classList.remove('hidden');
      }
    }

    /**
     * Mostra o modal de mensagem
     * @param {string} title Título do modal
     * @param {string} message Mensagem do modal
     */
    function showMessage(title, message) {
      modal.title.textContent = title;
      modal.body.textContent = message;
      modal.container.classList.remove('hidden');
    }

    // Evento para fechar o modal
    modal.closeBtn.addEventListener('click', () => modal.container.classList.add('hidden'));

    /**
     * Alterna a visibilidade da senha em um campo
     * @param {string} inputId ID do campo de senha
     * @param {HTMLElement} button Botão clicado
     */
    window.togglePasswordVisibility = (inputId, button) => {
      const input = document.getElementById(inputId);
      const icon = button.querySelector('span');
      if (input.type === 'password') {
        input.type = 'text';
        icon.textContent = 'visibility_off';
      } else {
        input.type = 'password';
        icon.textContent = 'visibility';
      }
    }

    /**
     * Debounce para evitar chamadas excessivas à API
     */
    function debounce(func, delay) {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(func, delay);
    }

    // --- Lógica de Navegação ---

    // Splash
    document.getElementById('btn-goto-register').addEventListener('click', () => showScreen('register'));
    document.getElementById('btn-goto-login').addEventListener('click', () => showScreen('login'));

    // Login
    document.getElementById('login-back-btn').addEventListener('click', () => showScreen('splash'));
    document.getElementById('login-forgot-link').addEventListener('click', () => showScreen('forgot'));

    // Forgot Password
    document.getElementById('forgot-back-btn').addEventListener('click', () => showScreen('login'));
    document.getElementById('forgot-cancel-btn').addEventListener('click', () => showScreen('login'));

    // Dashboard -> Add Task
    document.getElementById('btn-show-add-task').addEventListener('click', () => {
        resetTaskForm();
        showScreen('addTask');
    });

    // Add Task -> Dashboard
    taskForm.backBtn.addEventListener('click', () => showScreen('dashboard'));


    // --- Lógica de Cadastro (Etapas) ---
    // (Ocultado por brevidade, sem alterações)
    function updateRegistrationStepUI() {
      const nextBtn = document.getElementById('reg-next-btn');
      Object.values(registerSteps).forEach(step => step.classList.add('hidden'));
      progressBars.p1.className = 'h-1 flex-1 rounded-full bg-primary/20';
      progressBars.p2.className = 'h-1 flex-1 rounded-full bg-primary/20';
      progressBars.p3.className = 'h-1 flex-1 rounded-full bg-primary/20';
      if (currentRegistrationStep === 1) {
        registerSteps.step1.classList.remove('hidden');
        progressBars.p1.classList.replace('bg-primary/20', 'bg-primary');
        nextBtn.textContent = 'Próximo';
      } else if (currentRegistrationStep === 2) {
        registerSteps.step2.classList.remove('hidden');
        progressBars.p1.classList.replace('bg-primary/20', 'bg-primary');
        progressBars.p2.classList.replace('bg-primary/20', 'bg-primary');
        nextBtn.textContent = 'Próximo';
      } else if (currentRegistrationStep === 3) {
        registerSteps.step3.classList.remove('hidden');
        progressBars.p1.classList.replace('bg-primary/20', 'bg-primary');
        progressBars.p2.classList.replace('bg-primary/20', 'bg-primary');
        progressBars.p3.classList.replace('bg-primary/20', 'bg-primary');
        nextBtn.textContent = 'Confirmar e Iniciar Jornada!';
      }
    }
    document.getElementById('reg-back-btn').addEventListener('click', () => {
      if (currentRegistrationStep > 1) {
        currentRegistrationStep--;
        updateRegistrationStepUI();
      } else {
        showScreen('splash');
      }
    });
    document.getElementById('reg-next-btn').addEventListener('click', () => {
      if (currentRegistrationStep === 1) {
        if (!regInputs.nickname.value || !regInputs.email.value || !regInputs.password.value) {
          showMessage('Campo Obrigatório', 'Por favor, preencha seu nome, email e senha.');
          return;
        }
        if (regInputs.password.value.length < 6) {
          showMessage('Senha Fraca', 'Sua senha deve ter pelo menos 6 caracteres.');
          return;
        }
        currentRegistrationStep = 2;
      } else if (currentRegistrationStep === 2) {
        if (!regInputs.height.value || !regInputs.weight.value) {
          showMessage('Campo Obrigatório', 'Por favor, preencha sua altura e peso atual.');
          return;
        }
        currentRegistrationStep = 3;
      } else if (currentRegistrationStep === 3) {
        if (!selectedAvatarUrl) {
          showMessage('Campo Obrigatório', 'Escolha sua aparência (avatar) para continuar.');
          return;
        }
        handleRegister();
      }
      updateRegistrationStepUI();
    });
    document.getElementById('avatar-selection').addEventListener('click', (e) => {
      const clickedAvatar = e.target.closest('.avatar-option');
      if (!clickedAvatar) return;
      document.querySelectorAll('.avatar-option').forEach(el => {
        el.classList.remove('avatar-selected', 'border-primary');
        el.classList.add('border-transparent');
      });
      clickedAvatar.classList.add('avatar-selected', 'border-primary');
      clickedAvatar.classList.remove('border-transparent');
      selectedAvatarUrl = clickedAvatar.dataset.avatarUrl;
    });


    // --- Lógica de Autenticação Firebase ---

    /**
     * Observador de Estado de Autenticação (CORE)
     */
    onAuthStateChanged(auth, (user) => {
      if (profileListener) profileListener();
      if (tasksListener) tasksListener();

      if (user && !user.isAnonymous) {
        console.log('Usuário logado (APÓS AÇÃO MANUAL):', user.uid);
        currentUserId = user.uid;

        const profileRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'details');
        const tasksRef = collection(db, 'artifacts', appId, 'users', user.uid, 'tasks');

        profileListener = onSnapshot(profileRef, (docSnap) => {
          if (docSnap.exists()) {
            const data = docSnap.data();
            populateDashboard(user, data);
            showScreen('dashboard');
          } else {
            console.log('Perfil não encontrado, redirecionando para cadastro (etapa 2)...');
            showMessage('Personagem Incompleto', 'Quase lá! Precisamos de seus dados vitais para forjar seu personagem.');
            regInputs.nickname.value = user.displayName || '';
            regInputs.email.value = user.email || '';
            if (user.providerData.some(p => p.providerId === 'google.com')) {
              regInputs.nickname.disabled = true;
              regInputs.email.disabled = true;
              regInputs.password.closest('label').classList.add('hidden');
            }
            currentRegistrationStep = 2;
            updateRegistrationStepUI();
            showScreen('register');
          }
        });

        tasksListener = onSnapshot(tasksRef, (querySnapshot) => {
          const tasks = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          populateMissions(tasks);
        });

      } else {
        console.log('Usuário deslogado. Aguardando ação na tela inicial.');
        currentUserId = null;
        profileListener = null;
        tasksListener = null;
        resetRegistrationForm();
        showScreen('splash');
      }
    });

    /**
     * Popula o Dashboard com os dados do perfil
     */
    function populateDashboard(user, profileData) {
      const character = profileData.character || {};
      const vitals = profileData.vitals || {};
      const stats = profileData.stats || {};

      document.getElementById('hub-avatar').src = character.avatar_url || 'https://placehold.co/100x100/1a3828/13ec6d?text=?';
      document.getElementById('hub-nickname').textContent = profileData.nickname || 'Aventureiro';
      document.getElementById('hub-level').textContent = `Nv. ${character.level || 1}`;

      const hpPercent = (character.hp_atual / character.hp_max) * 100 || 100;
      const manaPercent = (character.mana_atual / character.mana_max) * 100 || 100;
      const xpPercent = (character.xp_atual / character.xp_para_upar) * 100 || 0;

      document.getElementById('hub-hp-bar').style.width = `${hpPercent}%`;
      document.getElementById('hub-hp-text').textContent = `${character.hp_atual}/${character.hp_max}`;
      document.getElementById('hub-mana-bar').style.width = `${manaPercent}%`;
      document.getElementById('hub-mana-text').textContent = `${character.mana_atual}/${character.mana_max}`;
      document.getElementById('hub-xp-bar').style.width = `${xpPercent}%`;
      document.getElementById('hub-xp-text').textContent = `${character.xp_atual}/${character.xp_para_upar}`;

      document.getElementById('hub-stats-forca').innerHTML = `<span class="material-symbols-outlined text-red-400 text-base">swords</span> <span>Força: ${stats.forca?.level || 1}</span>`;
      document.getElementById('hub-stats-inteligencia').innerHTML = `<span class="material-symbols-outlined text-blue-400 text-base">school</span> <span>Inteligência: ${stats.inteligencia?.level || 1}</span>`;
      document.getElementById('hub-stats-vitalidade').innerHTML = `<span class="material-symbols-outlined text-green-400 text-base">shield</span> <span>Vitalidade: ${stats.vitalidade?.level || 1}</span>`;
      document.getElementById('hub-stats-velocidade').innerHTML = `<span class="material-symbols-outlined text-yellow-400 text-base">sprint</span> <span>Velocidade: ${stats.velocidade?.level || 1}</span>`;

      const statusContainer = document.getElementById('hub-status-effects');
      statusContainer.innerHTML = '';
      if (profileData.status_effects && profileData.status_effects.length > 0) {
        profileData.status_effects.forEach(effect => {
          const effectEl = document.createElement('div');
          effectEl.className = 'flex items-center gap-2 text-sm';
          effectEl.innerHTML = `<span class="material-symbols-outlined text-yellow-500 text-base">spark</span> <span>${effect.label}</span>`;
          statusContainer.appendChild(effectEl);
        });
      } else {
        statusContainer.innerHTML = '<p class="text-sm text-text-dark-secondary">Nenhum efeito ativo.</p>';
      }
    }

    /**
     * Popula a lista de missões no Dashboard
     */
    function populateMissions(tasks) {
        const missionContainer = document.getElementById('hub-mission-list');
        missionContainer.innerHTML = '';

        if (!tasks || tasks.length === 0) {
            missionContainer.innerHTML = '<p class="text-sm text-text-dark-secondary p-4">Nenhuma missão encontrada. Adicione uma nova!</p>';
            return;
        }

        tasks.forEach(task => {
            const taskEl = document.createElement('div');
            const isCompleted = task.concluida;

            const iconMap = {
                diaria: 'fitness_center',
                habito: 'menu_book',
                projeto: 'work',
                FORCA: 'swords',
                INTELIGENCIA: 'school',
                VELOCIDADE: 'sprint',
                VITALIDADE: 'shield',
                CARISMA: 'sentiment_satisfied',
                default: 'task'
            };

            const icon = iconMap[task.tipo] || iconMap[task.atributo_associado] || iconMap.default;

            taskEl.className = `flex items-center gap-3 rounded-lg bg-surface-dark/50 p-4 backdrop-blur-sm border ${isCompleted ? 'border-primary/50 opacity-60' : 'border-border-dark'}`;

            taskEl.innerHTML = `
                <div class="flex h-12 w-12 items-center justify-center rounded-lg bg-primary/20">
                  <span class="material-symbols-outlined text-primary text-3xl">${icon}</span>
                </div>
                <div class="flex-1">
                  <p class="font-bold ${isCompleted ? 'line-through' : ''}">${task.titulo || 'Missão sem título'}</p>
                  <p class="text-sm text-text-dark-secondary ${isCompleted ? 'line-through' : ''}">Atributo: ${task.atributo_associado || 'Nenhum'}</p>
                </div>
                <div class="flex h-6 w-6 items-center justify-center rounded-full border-2 border-primary ${isCompleted ? 'bg-primary' : ''}">
                  ${isCompleted ? '<span class="material-symbols-outlined text-background-dark text-base font-bold">check</span>' : ''}
                </div>
            `;
            missionContainer.appendChild(taskEl);
        });
    }

    /**
     * Reseta o formulário de cadastro para o estado inicial
     */
    function resetRegistrationForm() {
      currentRegistrationStep = 1;
      updateRegistrationStepUI();
      Object.values(regInputs).forEach(input => {
        input.value = '';
        input.disabled = false;
      });
      regInputs.password.closest('label').classList.remove('hidden');
      selectedAvatarUrl = null;
      document.querySelectorAll('.avatar-option').forEach(el => {
        el.classList.remove('avatar-selected', 'border-primary');
        el.classList.add('border-transparent');
      });
    }

    /**
     * Lidar com o Registro de novo usuário (Email/Senha)
     */
    async function handleRegister() {
      let user;

      const basicData = {
          nickname: regInputs.nickname.value,
          email: regInputs.email.value,
          createdAt: Timestamp.now(),
          uid: null
      };

      const vitals = {
          altura_cm: Number(regInputs.height.value),
          peso_atual_kg: Number(regInputs.weight.value),
          meta_peso_kg: Number(regInputs.weightTarget.value) || null,
          imc: 0
      };
      if (vitals.altura_cm > 0) {
          const altura_m = vitals.altura_cm / 100;
          vitals.imc = parseFloat((vitals.peso_atual_kg / (altura_m * altura_m)).toFixed(1));
      }

      const defaultStat = { level: 1, xp_atual: 0, xp_para_upar: 100 };
      const stats = {
          forca: { ...defaultStat },
          inteligencia: { ...defaultStat },
          velocidade: { ...defaultStat },
          vitalidade: { ...defaultStat },
          carisma: { ...defaultStat } // Adicionando Carisma
      };

      const base_hp = 100 + (stats.vitalidade.level * 10);
      const base_mana = 100 + (stats.inteligencia.level * 10);

      const character = {
          level: 1,
          xp_atual: 0,
          xp_para_upar: 1000,
          hp_max: base_hp,
          hp_atual: base_hp,
          energia_max: 100,
          energia_atual: 100,
          mana_max: base_mana,
          mana_atual: base_mana,
          moedas: 0,
          avatar_url: selectedAvatarUrl
      };

      const status_effects = [];
      if (vitals.imc > 25) {
          status_effects.push({ id: "debuff_imc_alto", label: "Sobrepeso", effect: "energia_max", value: -10 });
      } else if (vitals.imc < 18.5) {
          status_effects.push({ id: "debuff_imc_baixo", label: "Abaixo do Peso", effect: "hp_max", value: -10 });
      }

      const profileData = {
          ...basicData,
          vitals,
          stats,
          character,
          status_effects
      };

      try {
        if (auth.currentUser && !auth.currentUser.isAnonymous && regInputs.email.disabled) {
          user = auth.currentUser;
          console.log('Atualizando perfil existente do Google...');
          profileData.email = user.email;
          profileData.nickname = user.displayName || basicData.nickname;
          character.avatar_url = user.photoURL || selectedAvatarUrl;
        } else {
          console.log('Criando novo usuário com Email/Senha...');
          const userCredential = await createUserWithEmailAndPassword(auth, basicData.email, regInputs.password.value);
          user = userCredential.user;
          await updateProfile(user, { displayName: basicData.nickname });
        }

        profileData.uid = user.uid;
        const profileRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'details');
        await setDoc(profileRef, profileData);

        console.log('Personagem criado e salvo!');

      } catch (error) {
        console.error("Erro ao criar personagem:", error);
        showMessage('Erro na Criação', `Não foi possível criar seu personagem. Erro: ${error.message}`);
      }
    }

    // --- Lógica de Login/Logout/Recuperação (Sem alterações) ---
    document.getElementById('login-btn').addEventListener('click', async () => {
      const email = loginInputs.email.value;
      const password = loginInputs.password.value;
      if (!email || !password) {
        return showMessage('Campos Vazios', 'Digite seu email e senha.');
      }
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (error) {
        console.error("Erro no login:", error);
        showMessage('Erro ao Entrar', 'Email ou senha inválidos. Verifique seus dados.');
      }
    });
    document.getElementById('btn-google-login').addEventListener('click', async () => {
      const provider = new GoogleAuthProvider();
      try {
        await signInWithPopup(auth, provider);
      } catch (error) {
        console.error("Erro no login com Google:", error);
        showMessage('Erro no Login', `Não foi possível logar com o Google. Erro: ${error.message}`);
      }
    });
    document.getElementById('forgot-btn').addEventListener('click', async () => {
      const email = document.getElementById('forgot-email').value;
      if (!email) {
        return showMessage('Campo Vazio', 'Digite seu email para recuperação.');
      }
      try {
        await sendPasswordResetEmail(auth, email);
        showMessage('Pergaminho Enviado', 'Um email de recuperação foi enviado para ' + email + '. Verifique sua caixa de entrada (e spam).');
        showScreen('login');
      } catch (error) {
        console.error("Erro ao enviar email de recuperação:", error);
        showMessage('Erro', `Não foi possível enviar o email. Verifique o endereço digitado. Erro: ${error.message}`);
      }
    });
    document.getElementById('hub-logout-btn').addEventListener('click', async (e) => {
        e.preventDefault();
        try {
            await signOut(auth);
        } catch (error) {
            console.error("Erro ao sair:", error);
            showMessage('Erro', 'Não foi possível sair da aventura no momento.');
        }
    });

    // --- LÓGICA DA TELA DE CRIAR TAREFAS (IA) ---

    /**
     * Reseta o formulário de criação de tarefa
     */
    function resetTaskForm() {
        taskForm.title.value = '';
        taskForm.durationHours.value = '';
        taskForm.durationMinutes.value = '';
        taskForm.deadline.value = '';
        taskForm.notes.value = '';
        taskForm.subtaskInput.value = '';
        selectedTaskType = null;
        selectedTaskPriority = 'contrato';
        recurrenceRule = null;
        taskForm.recurrenceSummary.textContent = '';
        aiResults = null;
        calculatedRewards = null;
        subtasksList = [];
        renderSubtasks();

        taskForm.typeButtons.forEach(btn => btn.classList.remove('task-type-selected'));
        taskForm.priorityButtons.forEach(btn => btn.classList.remove('task-priority-selected'));

        rewardBox.loading.classList.remove('hidden');
        rewardBox.loadingText.textContent = 'Digite sua missão para calcularmos a recompensa...';
        rewardBox.spinner.classList.add('hidden');
        rewardBox.results.classList.add('hidden');
    }

    /**
     * Lógica de Seleção e Análise da IA
     */
    function setupTaskFormListeners() {
        // Adiciona listeners para todos os campos que afetam a análise da IA
        ['keyup', 'click'].forEach(eventType => {
            taskForm.title.addEventListener(eventType, triggerAIAnalysis);
            taskForm.durationHours.addEventListener(eventType, triggerAIAnalysis);
            taskForm.durationMinutes.addEventListener(eventType, triggerAIAnalysis);
            taskForm.typeGroup.addEventListener(eventType, triggerAIAnalysis);
            taskForm.addSubtaskBtn.addEventListener(eventType, () => {
                const title = taskForm.subtaskInput.value.trim();
                if (title) {
                    subtasksList.push({ titulo: title, concluida: false });
                    taskForm.subtaskInput.value = '';
                    renderSubtasks();
                    triggerAIAnalysis();
                }
            });
            taskForm.subtaskList.addEventListener(eventType, (e) => {
                if (e.target.closest('.remove-subtask-btn')) {
                    const index = parseInt(e.target.closest('.remove-subtask-btn').dataset.index, 10);
                    subtasksList.splice(index, 1);
                    renderSubtasks();
                    triggerAIAnalysis();
                }
            });
        });

        taskForm.priorityGroup.addEventListener('click', (e) => {
            const button = e.target.closest('.task-priority-btn');
            if (!button) return;
            selectedTaskPriority = button.dataset.priority;
            taskForm.priorityButtons.forEach(btn => btn.classList.remove('task-priority-selected'));
            button.classList.add('task-priority-selected');
        });
    }

    function triggerAIAnalysis() {
        const title = taskForm.title.value.trim();
        const hours = parseInt(taskForm.durationHours.value, 10) || 0;
        const minutes = parseInt(taskForm.durationMinutes.value, 10) || 0;
        const totalMinutes = (hours * 60) + minutes;
        
        if (title.length < 3 || !selectedTaskType) {
             rewardBox.loading.classList.remove('hidden');
             rewardBox.loadingText.textContent = 'Preencha o Título e o Tipo de Missão...';
             rewardBox.spinner.classList.add('hidden');
             rewardBox.results.classList.add('hidden');
            return;
        }
        
        rewardBox.loading.classList.remove('hidden');
        rewardBox.loadingText.textContent = 'Analisando missão...';
        rewardBox.spinner.classList.remove('hidden');
        rewardBox.results.classList.add('hidden');
        
        debounce(() => analyzeTaskWithAI(title, totalMinutes, selectedTaskType, subtasksList), 1000);
    }

    async function analyzeTaskWithAI(taskTitle, totalMinutes, taskType, subtasks) {
        console.log(`Analisando: Tipo=${taskType}, Título='${taskTitle}', Duração=${totalMinutes} min, Sub-tarefas=${subtasks.length}`);
        
        const apiKey = "AIzaSyCF4tD2jq3pEHfuilwMq-fjdUnBZDxcoxM";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        const subtasksString = JSON.stringify(subtasks.map(s => s.titulo));
        const combinedPrompt = `Você é um mestre de jogo (Game Master) de um RPG da vida real. Sua função é analisar tarefas e classificá-las. Responda APENAS com um objeto JSON. Não inclua \`\`\`json ou qualquer texto antes ou depois.

Analise a tarefa. Considere o TIPO, Título, Duração e Sub-tarefas para definir o atributo_associado (FORCA, INTELIGENCIA, VELOCIDADE, VITALIDADE, CARISMA) e a dificuldade (FACIL, MEDIA, DIFICIL).

Use estas definições de Atributo:
FORCA: Academia, levantar peso, limpeza pesada.
INTELIGENCIA: Estudar, ler, planejar, meditar, aprender.
VELOCIDADE: Correr, organizar, tarefas rápidas, caminhada.
VITALIDADE: Beber água, comer saudável, dormir, tomar sol.
CARISMA: Socializar, ligar para amigos, networking, apresentação.

Regras de Dificuldade (INTELIGENTE - Use o TIPO como base):
TIPO 'habito': É quase sempre FACIL. (Ex: 'Beber água', 'Meditar 5 min'). Só será MEDIA se a Duração for > 30 min. Um Hábito NUNCA pode ser 'DIFICIL'.
TIPO 'diaria': É quase sempre MEDIA. (Ex: 'Ir na academia', 'Correr 30 min'). Só será 'DIFICIL' se Duração > 90 min OU tiver 4+ sub-tarefas.
TIPO 'projeto': É quase sempre DIFICIL. (Ex: 'Fazer TCC', 'Limpar a casa toda'). Só será 'MEDIA' se tiver 0 sub-tarefas E Duração < 60 min.

Exemplos de Classificação:
TIPO: 'habito', Título: 'Beber água 1 copo', Duração: 1, Sub-tarefas: [] -> {"atributo_associado": "VITALIDADE", "dificuldade": "FACIL"}
TIPO: 'diaria', Título: 'Correr', Duração: 30, Sub-tarefas: [] -> {"atributo_associado": "VELOCIDADE", "dificuldade": "MEDIA"}
TIPO: 'projeto', Título: 'Estudar p/ prova', Duração: 60, Sub-tarefas: [] -> {"atributo_associado": "INTELIGENCIA", "dificuldade": "MEDIA"}
TIPO: 'projeto', Título: 'Estudar p/ prova', Duração: 60, Sub-tarefas: ["Ler", "Resumir"] -> {"atributo_associado": "INTELIGENCIA", "dificuldade": "DIFICIL"}

Tarefa:
TIPO: '${taskType}'
Título: '${taskTitle}'
Duração (minutos): ${totalMinutes}
Sub-tarefas: ${subtasksString}`;

        // Schema de Resposta (para forçar JSON)
        const responseSchema = {
            type: "OBJECT",
            properties: {
                "atributo_associado": { "type": "STRING" },
                "dificuldade": { "type": "STRING" }
            },
            required: ["atributo_associado", "dificuldade"]
        };
        
        // Payload corrigido, sem 'systemInstruction'
        const payload = {
            contents: [{ parts: [{ text: combinedPrompt }] }],
            generationConfig: {
                responseMimeType: "application/json",
                responseSchema: responseSchema,
                temperature: 0.1 // Baixa temperatura para respostas consistentes
            }
        };

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`Erro na API: ${response.statusText}`);
            }

            const result = await response.json();
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (!text) {
                 throw new Error("A IA não retornou uma análise válida.");
            }

            aiResults = JSON.parse(text); // Salva os resultados globais
            console.log("Resultado da IA:", aiResults);
            
            // Atualiza a caixa de recompensa
            updateRewardEstimation(aiResults.atributo_associado, aiResults.dificuldade);

        } catch (error) {
            console.error("Erro ao analisar tarefa:", error);
            rewardBox.loading.classList.remove('hidden');
            rewardBox.loadingText.textContent = 'Erro ao analisar. Tente novamente.';
            rewardBox.spinner.classList.add('hidden');
            rewardBox.results.classList.add('hidden');
            aiResults = null;
        }
    }
    
    /**
     * Atualiza a caixa de estimativa de recompensa
     */
     function updateRewardEstimation(attribute, difficulty) {
        if (!selectedTaskType) {
            // Se a IA respondeu mas o tipo não foi selecionado
            rewardBox.loading.classList.remove('hidden');
            rewardBox.loadingText.textContent = 'Selecione um Tipo de Missão...';
            rewardBox.spinner.classList.add('hidden');
            rewardBox.results.classList.add('hidden');
            return;
        }

        // Normaliza as chaves (ex: "FORCA" -> "forca")
        const typeKey = selectedTaskType.toLowerCase();
        const difficultyKey = difficulty.toUpperCase();
        const attributeKey = attribute.toUpperCase();

        const typeRewards = REWARDS_TYPE[typeKey] || { xp_global: 0, moedas: 0 };
        const difficultyRewards = REWARDS_DIFFICULTY[difficultyKey] || { xp_attr: 0 };
        
        // Salva as recompensas calculadas
        calculatedRewards = {
            xp_global: typeRewards.xp_global,
            xp_atributo: difficultyRewards.xp_attr,
            moedas: typeRewards.moedas // Moedas baseadas apenas no tipo, conforme GDD
        };

        // Exibe os resultados
        rewardBox.attribute.textContent = attributeKey;
        rewardBox.difficulty.textContent = difficultyKey;
        rewardBox.xpGlobal.textContent = `+${calculatedRewards.xp_global} XP`;
        rewardBox.xpAttributeLabel.textContent = `XP de ${attributeKey}:`;
        rewardBox.xpAttribute.textContent = `+${calculatedRewards.xp_atributo} XP`;
        rewardBox.coins.textContent = `+${calculatedRewards.moedas} Moedas`;
        
        rewardBox.loading.classList.add('hidden');
        rewardBox.results.classList.remove('hidden');
     }
     
    /**
     * Salva a nova tarefa no Firestore
     */
    taskForm.saveBtn.addEventListener('click', async () => {
        const title = taskForm.title.value.trim();
        const hours = parseInt(taskForm.durationHours.value, 10) || 0;
        const minutes = parseInt(taskForm.durationMinutes.value, 10) || 0;
        const totalMinutes = (hours * 60) + minutes;
        
        // Validação
        if (title.length < 3) {
            return showMessage('Missão Inválida', 'O título da missão é muito curto.');
        }
        if (!selectedTaskType) {
            return showMessage('Missão Inválida', 'Selecione um tipo de missão (Hábito, Diária ou Projeto).');
        }
        if (!aiResults || !calculatedRewards) {
            return showMessage('Missão Inválida', 'Aguarde a análise da IA terminar antes de salvar.');
        }
        if (!currentUserId) {
            return showMessage('Erro', 'Usuário não encontrado. Tente relogar.');
        }
        
        const isRecurrenceTemplate = recurrenceRule !== null;

        const taskData = {
            titulo: title,
            tipo: selectedTaskType,
            prioridade: selectedTaskPriority,
            notas: taskForm.notes.value.trim() || null,
            recorrencia: recurrenceRule,
            isTemplate: isRecurrenceTemplate,
            lastGenerated: null,
            duracao_estimada_minutos: totalMinutes > 0 ? totalMinutes : null,
            atributo_associado: aiResults.atributo_associado,
            dificuldade: aiResults.dificuldade,
            recompensa: calculatedRewards,
            concluida: false,
            createdAt: Timestamp.now(),
            prazo_final: taskForm.deadline.value || null,
            subtarefas: subtasksList
        };
        
        try {
            const tasksRef = collection(db, 'artifacts', appId, 'users', currentUserId, 'tasks');
            await addDoc(tasksRef, taskData);
            
            console.log('Missão salva:', taskData);
            showMessage('Sucesso!', 'Sua nova missão foi adicionada ao registro!');
            showScreen('dashboard');
            
        } catch (error) {
            console.error("Erro ao salvar missão:", error);
            showMessage('Erro no Firestore', `Não foi possível salvar sua missão. Erro: ${error.message}`);
        }
    });

    // --- Inicialização da Aplicação ---
    setupTaskFormListeners(); // Configura os listeners do formulário de tarefas

  </script>

</body>
</html>
