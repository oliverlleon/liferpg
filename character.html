<!DOCTYPE html>
<html class="dark" lang="pt"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Ficha de Personagem &amp; Inventário</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Spline+Sans:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#13ec6d",
            "background-light": "#f6f8f7",
            "background-dark": "#111814",
            "surface": "#1a241e",
            "surface-secondary": "#28392f",
            "text-primary": "#ffffff",
            "text-secondary": "#a0a0a0",
            "border-color": "#3b5445",
            "debuff": "#ef4444",
          },
          fontFamily: {
            "display": ["Spline Sans", "Noto Sans", "sans-serif"]
          },
          borderRadius: {
            "DEFAULT": "1rem",
            "lg": "1.5rem",
            "xl": "2rem",
            "full": "9999px"
          },
        },
      },
    }
  </script>
<style>
    .material-symbols-outlined {
      font-variation-settings:
        'FILL' 0,
        'wght' 400,
        'GRAD' 0,
        'opsz' 24
    }
    body {
      min-height: 100dvh;
    }
    .equipment-slot {
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .equipment-slot:hover {
        background-color: #28392f;
    }
  </style>
</head>
<body class="bg-background-dark font-display text-text-primary">
<div id="app-container" class="flex h-auto min-h-screen w-full flex-col">
<header class="flex flex-col items-center p-4 pt-8">
<div class="relative w-full max-w-sm mx-auto h-72">
<div class="absolute z-10 top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">
<img alt="Avatar do Aventureiro" id="avatar-img" class="w-32 h-32 rounded-full border-4 border-primary object-cover shadow-lg" src="https://placehold.co/128x128/1a241e/13ec6d?text=?"/>
</div>
<div id="slot-cabeca" data-slot="cabeca" class="equipment-slot absolute w-16 h-16 rounded-lg bg-surface border-2 border-border-color flex items-center justify-center text-text-secondary" style="top: 0; left: 50%; transform: translateX(-50%);"><span class="material-symbols-outlined">skull</span></div>
<div id="slot-peitoral" data-slot="peitoral" class="equipment-slot absolute w-16 h-16 rounded-lg bg-surface border-2 border-border-color flex items-center justify-center text-text-secondary" style="top: 50%; left: 0; transform: translateY(-50%);"><span class="material-symbols-outlined">shield</span></div>
<div id="slot-mao_direita" data-slot="mao_direita" class="equipment-slot absolute w-16 h-16 rounded-lg bg-surface border-2 border-border-color flex items-center justify-center text-text-secondary" style="top: 50%; right: 0; transform: translateY(-50%);"><span class="material-symbols-outlined">swords</span></div>
<div id="slot-amuleto" data-slot="amuleto" class="equipment-slot absolute w-16 h-16 rounded-lg bg-surface border-2 border-border-color flex items-center justify-center text-text-secondary" style="bottom: 0; left: 25%; transform: translateX(-50%);"><span class="material-symbols-outlined">diamond</span></div>
<div id="slot-botas" data-slot="botas" class="equipment-slot absolute w-16 h-16 rounded-lg bg-surface border-2 border-border-color flex items-center justify-center text-text-secondary" style="bottom: 0; right: 25%; transform: translateX(50%);"><span class="material-symbols-outlined">foot_bones</span></div>
</div>
<h1 id="character-level-title" class="text-2xl font-bold mt-4">Carregando...</h1>
<p id="character-name" class="text-text-secondary">...</p>
</header>
<main class="flex-1 pb-24 px-4 space-y-8">
<section>
<div class="bg-surface rounded-lg p-4">
<div class="flex justify-between items-center mb-4">
<div>
<p class="text-text-secondary text-sm">Peso Atual</p>
<p id="current-weight" class="text-xl font-bold">- kg</p>
</div>
<div>
<p class="text-text-secondary text-sm text-right">IMC</p>
<p id="current-imc" class="text-xl font-bold text-right">-</p>
</div>
<button id="add-daily-log-btn" class="flex items-center justify-center gap-2 rounded-full h-10 px-4 bg-surface-secondary text-primary text-sm font-bold">
<span class="material-symbols-outlined !text-base">add_circle</span>
<span>Adicionar Log Diário</span>
</button>
</div>
<div id="status-effects-container" class="border-t border-border-color pt-4">
<h3 class="font-bold mb-2">Efeitos Ativos</h3>
</div>
</div>
</section>
<section id="health-chart-container" class="bg-surface rounded-lg p-4">
    <canvas id="healthChart"></canvas>
</section>
<section>
<h2 class="text-xl font-bold mb-4">Atributos</h2>
<div id="attributes-list" class="bg-surface rounded-lg p-4 space-y-4">
</div>
</section>
<section>
<h2 class="text-xl font-bold mb-4">Inventário</h2>
<div id="inventory-grid" class="grid grid-cols-4 sm:grid-cols-5 gap-4">
</div>
</section>
<section>
<h2 class="text-xl font-bold mb-4">Conquistas</h2>
<div id="achievements-list" class="space-y-3">
</div>
</section>
</main>
<nav class="fixed bottom-0 left-0 right-0 bg-surface-secondary/80 backdrop-blur-sm border-t border-border-color">
<div class="flex justify-around h-20">
<a class="flex flex-col items-center justify-center w-full text-text-secondary hover:text-primary" href="./index.html">
<span class="material-symbols-outlined">home</span>
<span class="text-xs">Início</span>
</a>
<a class="flex flex-col items-center justify-center w-full text-primary" href="#">
<span class="material-symbols-outlined">person</span>
<span class="text-xs">Personagem</span>
</a>
<a class="flex flex-col items-center justify-center w-full text-text-secondary hover:text-primary" href="./index.html">
<span class="material-symbols-outlined">shield_moon</span>
<span class="text-xs">Missões</span>
</a>
<a class="flex flex-col items-center justify-center w-full text-text-secondary hover:text-primary" href="#">
<span class="material-symbols-outlined">bar_chart</span>
<span class="text-xs">Progresso</span>
</a>
</div>
</nav>
</div>

<!-- Modal de Adicionar Log Diário -->
<div id="modal-daily-log" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
    <div class="bg-surface border border-border-color rounded-lg p-6 w-full max-w-sm space-y-4">
        <h3 class="text-primary text-xl font-bold text-center">Adicionar Log Diário</h3>

        <div>
            <label for="log-peso" class="block text-sm font-medium text-text-secondary mb-1">Novo Peso (kg) <span class="text-debuff">*</span></label>
            <input id="log-peso" type="number" placeholder="Obrigatório" class="form-input w-full bg-background-dark border-border-color rounded-md text-center text-lg">
        </div>

        <div class="border-t border-border-color my-4"></div>

        <p class="text-center text-sm text-text-secondary">Opcional - Para cálculos mais precisos:</p>

        <div>
            <label for="log-gordura" class="block text-sm font-medium text-text-secondary mb-1">Gordura Corporal (%)</label>
            <input id="log-gordura" type="number" placeholder="Ex: 15.2" class="form-input w-full bg-background-dark border-border-color rounded-md text-center text-lg">
        </div>

        <div>
            <label for="log-sono" class="block text-sm font-medium text-text-secondary mb-1">Horas de Sono</label>
            <input id="log-sono" type="number" placeholder="Ex: 8" class="form-input w-full bg-background-dark border-border-color rounded-md text-center text-lg">
        </div>

        <div>
            <label for="log-estresse" class="block text-sm font-medium text-text-secondary mb-1">Nível de Estresse (1-5)</label>
            <input id="log-estresse" type="number" min="1" max="5" placeholder="1 (baixo) - 5 (alto)" class="form-input w-full bg-background-dark border-border-color rounded-md text-center text-lg">
        </div>

        <div class="flex gap-4 pt-4">
            <button id="cancel-daily-log" class="flex-1 rounded-full h-12 bg-surface-secondary text-text-primary font-bold">Cancelar</button>
            <button id="confirm-daily-log" class="flex-1 rounded-full h-12 bg-primary text-background-dark font-bold">Salvar</button>
        </div>
    </div>
</div>

<!-- Modal de Ação de Item -->
<div id="modal-item-action" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
<div class="bg-surface border border-border-color rounded-lg p-6 w-full max-w-sm text-center">
<h3 id="item-modal-title" class="text-primary text-xl font-bold mb-2">Nome do Item</h3>
<p id="item-modal-effect" class="text-text-secondary mb-6">Efeito do item</p>
<div class="flex gap-4">
<button id="item-action-secondary-btn" class="flex-1 rounded-full h-12 bg-surface-secondary text-text-primary font-bold">Descartar</button>
<button id="item-action-primary-btn" class="flex-1 rounded-full h-12 bg-primary text-background-dark font-bold">Ação</button>
</div>
<button id="item-action-cancel-btn" class="w-full mt-3 rounded-full h-10 bg-transparent text-text-secondary">Cancelar</button>
</div>
</div>

<script type="module">
    // Importações do Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, getDocs, runTransaction, writeBatch, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    document.addEventListener('DOMContentLoaded', () => {
        // --- Configuração do Firebase ---
        const firebaseConfigUser = {
          apiKey: "AIzaSyBeLq53I4Zu8TIcttgYwcyhFUBu4uneCxQ",
          authDomain: "rpglife-8f33d.firebaseapp.com",
          projectId: "rpglife-8f33d",
          storageBucket: "rpglife-8f33d.firebasestorage.app",
          messagingSenderId: "428052124083",
          appId: "1:428052124083:web:1190108bd19638ad2bfbc6",
          measurementId: "G-5LCK5W2JNH"
        };

        const firebaseConfig = typeof __firebase_config !== 'undefined'
          ? JSON.parse(__firebase_config)
          : firebaseConfigUser;

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'rpglife-app';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserId = null;
        let fullProfileData = null;
        let characterDailyLogs = []; // Armazenar logs para reutilização

        onAuthStateChanged(auth, user => {
            if (user) {
                currentUserId = user.uid;
                loadCharacterData(currentUserId);
            } else {
                window.location.href = 'index.html';
            }
        });

        async function loadCharacterData(uid) {
            const profileRef = doc(db, 'artifacts', appId, 'users', uid, 'profile', 'details');
            const inventoryRef = collection(db, 'artifacts', appId, 'users', uid, 'inventory');
            const goalsRef = collection(db, 'artifacts', appId, 'users', uid, 'goals');

            try {
                const [profileSnap, inventorySnap, goalsSnap] = await Promise.all([
                    getDoc(profileRef),
                    getDocs(inventoryRef),
                    getDocs(goalsRef)
                ]);

                if (profileSnap.exists()) {
                    fullProfileData = profileSnap.data();
                    renderAdventurerPanel(fullProfileData.character, fullProfileData.nickname);
                    renderVitalsPanel(fullProfileData.vitals, fullProfileData.status_effects);
                    renderAttributesPanel(fullProfileData.stats);
                }

                const inventoryItems = inventorySnap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderInventory(inventoryItems);

                const goals = goalsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderAchievements(goals);

            } catch (error) {
                console.error("Error loading character data:", error);
            }
        }

        function renderAdventurerPanel(character, nickname) {
            document.getElementById('avatar-img').src = character.avatar_url || 'https://placehold.co/128x128/1a241e/13ec6d?text=?';
            document.getElementById('character-level-title').textContent = `Nível ${character.level || 1}`;
            document.getElementById('character-name').textContent = nickname || 'Aventureiro';

            const equipment = character.equipment || {};
            const slots = ['cabeca', 'peitoral', 'mao_direita', 'amuleto', 'botas'];
            const defaultIcons = {
                cabeca: 'skull',
                peitoral: 'shield',
                mao_direita: 'swords',
                amuleto: 'diamond',
                botas: 'foot_bones'
            };

            slots.forEach(slot => {
                const slotEl = document.getElementById(`slot-${slot}`);
                const item = equipment[slot];
                if (item && item.icon) {
                    slotEl.innerHTML = `<span class="material-symbols-outlined !text-4xl text-primary">${item.icon}</span>`;
                    slotEl.dataset.equippedItem = JSON.stringify(item);
                } else {
                    slotEl.innerHTML = `<span class="material-symbols-outlined">${defaultIcons[slot]}</span>`;
                    delete slotEl.dataset.equippedItem;
                }
            });
        }

        function renderVitalsPanel(vitals, statusEffects) {
            document.getElementById('current-weight').textContent = `${vitals.peso_atual_kg || '-'} kg`;
            document.getElementById('current-imc').textContent = vitals.imc_atual || vitals.imc || '-';

            const effectsContainer = document.getElementById('status-effects-container');
            effectsContainer.innerHTML = '<h3 class="font-bold mb-2">Efeitos Ativos</h3>';

            if (statusEffects && statusEffects.length > 0) {
                const effectDisplayConfig = {
                    // Buffs (valor > 0)
                    buff_composicao_saudavel: { icon: 'health_and_safety', color: 'text-primary' },
                    buff_descansado: { icon: 'bedtime', color: 'text-blue-400' },
                    buff_focado: { icon: 'psychology', color: 'text-purple-400' },
                    // Debuffs (valor < 0)
                    debuff_gordura_alta: { icon: 'sentiment_very_dissatisfied', color: 'text-debuff' },
                    debuff_gordura_baixa: { icon: 'sentiment_dissatisfied', color: 'text-debuff' },
                    debuff_imc_alto: { icon: 'sentiment_dissatisfied', color: 'text-debuff' },
                    debuff_imc_baixo: { icon: 'sentiment_dissatisfied', color: 'text-debuff' },
                    debuff_cansado: { icon: 'battery_alert', color: 'text-yellow-500' },
                    debuff_estressado: { icon: 'bolt', color: 'text-orange-500' },
                };

                const effectNameMap = {
                    energia_max: "Energia Máx",
                    hp_max: "HP Máx",
                    regeneracao_mana_energia: "Regen. Energia",
                    custo_mana: "Custo de Habilidade"
                };

                statusEffects.forEach(effect => {
                    const config = effectDisplayConfig[effect.id] || { icon: 'help', color: 'text-text-secondary' };
                    const isBuff = (effect.id.startsWith('buff') && effect.value > 0) || (effect.id.startsWith('debuff') && effect.value > 0);
                    const effectText = effectNameMap[effect.effect] || effect.effect;

                    let valuePrefix = (effect.value > 0) ? '+' : '';
                    // Casos especiais onde um valor "positivo" é um debuff (ex: +10% custo de mana)
                    if (effect.id === 'debuff_estressado') {
                         valuePrefix = '+';
                    } else if (effect.id === 'buff_focado') {
                         valuePrefix = ''; // O valor já é negativo
                    }

                    const valueColor = isBuff ? config.color : 'text-debuff';

                    effectsContainer.innerHTML += `
                        <div class="flex items-center gap-3 ${config.color}">
                            <span class="material-symbols-outlined">${config.icon}</span>
                            <p class="text-sm">"${effect.label}": ${valuePrefix}${effect.value}% ${effectText}</p>
                        </div>
                    `;
                });

            } else {
                effectsContainer.innerHTML += `<p class="text-sm text-text-secondary">Nenhum efeito ativo.</p>`;
            }
        }

        function renderAttributesPanel(stats) {
            const attributesList = document.getElementById('attributes-list');
            attributesList.innerHTML = '';
            const attributeConfig = {
                forca: { icon: 'fitness_center', name: 'FORÇA' },
                inteligencia: { icon: 'school', name: 'INTELIGÊNCIA' },
                velocidade: { icon: 'sprint', name: 'VELOCIDADE' },
                vitalidade: { icon: 'favorite', name: 'VITALIDADE' },
                carisma: { icon: 'star', name: 'CARISMA' }
            };

            for (const key in attributeConfig) {
                const stat = stats[key] || { level: 1, xp_atual: 0, xp_para_upar: 100 };
                const config = attributeConfig[key];
                const xpPercent = (stat.xp_atual / stat.xp_para_upar) * 100;

                attributesList.innerHTML += `
                    <div class="flex items-center gap-4">
                        <div class="flex size-10 items-center justify-center rounded-full bg-surface-secondary text-primary"><span class="material-symbols-outlined">${config.icon}</span></div>
                        <div class="flex-1">
                            <div class="flex justify-between items-baseline">
                                <p class="font-bold">${config.name}</p>
                                <p class="text-text-secondary text-xs">Nível: ${stat.level}</p>
                            </div>
                            <div class="w-full bg-surface-secondary rounded-full h-2 mt-1">
                                <div class="bg-primary h-2 rounded-full" style="width: ${xpPercent}%"></div>
                            </div>
                            <p class="text-text-secondary text-xs text-right mt-1">${stat.xp_atual} / ${stat.xp_para_upar} XP</p>
                        </div>
                    </div>
                `;
            }
        }

        function renderInventory(items) {
            const inventoryGrid = document.getElementById('inventory-grid');
            inventoryGrid.innerHTML = '';
            const unequippedItems = items.filter(item => !item.equipado);

            unequippedItems.forEach(item => {
                inventoryGrid.innerHTML += `
                    <div class="inventory-item aspect-square bg-surface border-2 border-border-color rounded-lg flex items-center justify-center cursor-pointer" data-item='${JSON.stringify(item)}'>
                        <span class="material-symbols-outlined !text-4xl text-primary">${item.icon || 'help'}</span>
                    </div>
                `;
            });
        }

        function renderAchievements(goals) {
            const achievementsList = document.getElementById('achievements-list');
            achievementsList.innerHTML = '';
            if (!goals || goals.length === 0) {
                achievementsList.innerHTML = `<p class="text-text-secondary text-center">Nenhuma conquista ainda.</p>`;
                return;
            }

            goals.forEach(goal => {
                const progressPercent = (goal.progresso_atual / goal.progresso_total) * 100;
                achievementsList.innerHTML += `
                    <div class="bg-surface rounded-lg p-4 flex items-center gap-4 ${goal.concluido ? 'opacity-70' : ''}">
                        <span class="material-symbols-outlined !text-4xl text-yellow-400">emoji_events</span>
                        <div class="flex-1">
                            <p class="font-bold">${goal.titulo}</p>
                            <p class="text-text-secondary text-sm">${goal.descricao}</p>
                            ${!goal.concluido ? `
                            <div class="w-full bg-surface-secondary rounded-full h-2 my-1">
                                <div class="bg-yellow-400 h-2 rounded-full" style="width: ${progressPercent}%;"></div>
                            </div>
                            <p class="text-text-secondary text-xs">${goal.progresso_atual} / ${goal.progresso_total}</p>
                            ` : `<p class="text-primary text-sm font-semibold mt-1">Recompensa: ${goal.recompensa || '[Item Raro]'}</p>`}
                        </div>
                    </div>
                `;
            });
        }

        // --- Modals Logic ---
        const dailyLogModal = document.getElementById('modal-daily-log');
        const itemActionModal = document.getElementById('modal-item-action');
        let healthChart = null;


        document.getElementById('add-daily-log-btn').addEventListener('click', () => dailyLogModal.classList.remove('hidden'));
        document.getElementById('cancel-daily-log').addEventListener('click', () => dailyLogModal.classList.add('hidden'));
        document.getElementById('confirm-daily-log').addEventListener('click', handleDailyLogUpdate);
        document.getElementById('item-action-cancel-btn').addEventListener('click', () => itemActionModal.classList.add('hidden'));

        function calcularNovosStatus(imc, gordura_perc, sono, estresse) {
            let status_array = [];

            if (gordura_perc && gordura_perc > 0) {
                if (gordura_perc > 30) {
                    status_array.push({ id: "debuff_gordura_alta", label: "Gordura Elevada", effect: "energia_max", value: -15 });
                } else if (gordura_perc < 10) {
                    status_array.push({ id: "debuff_gordura_baixa", label: "Gordura Baixa", effect: "hp_max", value: -10 });
                } else {
                    status_array.push({ id: "buff_composicao_saudavel", label: "Composição Saudável", effect: "energia_max", value: 5 });
                }
            } else {
                if (imc > 25) {
                    status_array.push({ id: "debuff_imc_alto", label: "Sobrepeso", effect: "energia_max", value: -10 });
                } else if (imc < 18.5) {
                    status_array.push({ id: "debuff_imc_baixo", label: "Abaixo do Peso", effect: "hp_max", value: -10 });
                }
            }

            if (sono && sono >= 8) {
                status_array.push({ id: "buff_descansado", label: "Descansado", effect: "regeneracao_mana_energia", value: 10 });
            } else if (sono && sono < 5) {
                status_array.push({ id: "debuff_cansado", label: "Cansado", effect: "regeneracao_mana_energia", value: -10 });
            }

            if (estresse && estresse === 1) {
                status_array.push({ id: "buff_focado", label: "Focado", effect: "custo_mana", value: -5 });
            } else if (estresse && estresse === 5) {
                status_array.push({ id: "debuff_estressado", label: "Estressado", effect: "custo_mana", value: 10 });
            }

            return status_array;
        }

        function recalcularAtributosDerivados(status, stats) {
            let hp_max = 100 + (stats.vitalidade.level * 10) + (stats.forca.level * 2);
            let energia_max = 100 + (stats.forca.level * 5) + (stats.velocidade.level * 5);

            status.forEach(effect => {
                if (effect.id === "debuff_gordura_alta" || effect.id === "debuff_imc_alto") {
                    energia_max += (energia_max * (effect.value / 100));
                } else if (effect.id === "debuff_gordura_baixa" || effect.id === "debuff_imc_baixo") {
                    hp_max += (hp_max * (effect.value / 100));
                } else if (effect.id === "buff_composicao_saudavel") {
                    energia_max += (energia_max * (effect.value / 100));
                }
            });

            return { hp_max: Math.round(hp_max), energia_max: Math.round(energia_max) };
        }

        async function handleDailyLogUpdate() {
            const inputs = {
                novo_peso: parseFloat(document.getElementById('log-peso').value),
                nova_gordura_perc: parseFloat(document.getElementById('log-gordura').value) || null,
                horas_sono_hoje: parseInt(document.getElementById('log-sono').value) || null,
                estresse_hoje: parseInt(document.getElementById('log-estresse').value) || null
            };

            if (isNaN(inputs.novo_peso) || inputs.novo_peso <= 0) {
                alert("O peso é obrigatório e deve ser um número válido.");
                return;
            }

            try {
                await runTransaction(db, async (transaction) => {
                    const profileRef = doc(db, 'artifacts', appId, 'users', currentUserId, 'profile', 'details');
                    const dailyLogRef = doc(collection(db, 'artifacts', appId, 'users', currentUserId, 'daily_log'));

                    // Passo 1 (Ler): Lê o perfil e os últimos logs
                    const profileSnap = await transaction.get(profileRef);
                    if (!profileSnap.exists()) throw "Perfil não encontrado!";

                    const recentLogsQuery = query(dailyLogCollectionRef, orderBy("timestamp", "desc"), limit(6));
                    const recentLogsSnap = await getDocs(recentLogsQuery); // Executa fora da transação para leitura
                    const recentLogs = recentLogsSnap.docs.map(d => d.data());

                    const profileData = profileSnap.data();

                    const novo_imc = parseFloat((inputs.novo_peso / ((profileData.vitals.altura_cm / 100) ** 2)).toFixed(1));
                    const novos_status = calcularNovosStatus(novo_imc, inputs.nova_gordura_perc, inputs.horas_sono_hoje, inputs.estresse_hoje);
                    const { hp_max, energia_max } = recalcularAtributosDerivados(novos_status, profileData.stats);

                    // Write 1: O Histórico
                    transaction.set(dailyLogRef, {
                        timestamp: new Date(),
                        peso_kg: inputs.novo_peso,
                        gordura_perc: inputs.nova_gordura_perc,
                        horas_sono: inputs.horas_sono_hoje,
                        nivel_estresse: inputs.estresse_hoje
                    });

                    // Write 2: O Snapshot
                    profileData.vitals.peso_atual_kg = inputs.novo_peso;
                    profileData.vitals.imc_atual = novo_imc;
                    if(inputs.nova_gordura_perc) profileData.vitals.gordura_corporal_perc = inputs.nova_gordura_perc;
                    profileData.status_effects = novos_status;

                    // Write 3: Os Atributos Derivados
                    profileData.character.hp_max = hp_max;
                    profileData.character.energia_max = energia_max;

                    transaction.update(profileRef, profileData);
                });

                dailyLogModal.classList.add('hidden');
                ['log-peso', 'log-gordura', 'log-sono', 'log-estresse'].forEach(id => document.getElementById(id).value = '');
                loadCharacterData(currentUserId);

            } catch (e) {
                console.error("Transação de log diário falhou: ", e);
                alert("Falha ao salvar o log diário. Tente novamente.");
            }
        }

        async function renderHealthChart() {
            const dailyLogRef = collection(db, 'artifacts', appId, 'users', currentUserId, 'daily_log');
            const logSnap = await getDocs(dailyLogRef);
            const logs = logSnap.docs.map(d => d.data()).sort((a,b) => a.timestamp.seconds - b.timestamp.seconds);

            const labels = logs.map(log => log.timestamp.toDate().toLocaleDateString('pt-BR'));
            const weightData = logs.map(log => log.peso_kg);
            const fatData = logs.map(log => log.gordura_perc);

            const ctx = document.getElementById('healthChart').getContext('2d');

            if (healthChart) {
                healthChart.destroy();
            }

            healthChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Peso (kg)',
                            data: weightData,
                            borderColor: '#13ec6d',
                            backgroundColor: 'rgba(19, 236, 109, 0.1)',
                            fill: true,
                            yAxisID: 'y',
                        },
                        {
                            label: '% Gordura Corporal',
                            data: fatData,
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            fill: true,
                            yAxisID: 'y1',
                            hidden: !fatData.some(d => d) // Esconde se não houver dados de gordura
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            ticks: { color: '#a0a0a0' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false,
                            },
                            ticks: { color: '#a0a0a0' }
                        },
                        x: {
                           ticks: { color: '#a0a0a0' }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#a0a0a0'
                            }
                        }
                    }
                }
            });
        }

        document.getElementById('inventory-grid').addEventListener('click', (e) => {
            const itemEl = e.target.closest('.inventory-item');
            if (itemEl) {
                const item = JSON.parse(itemEl.dataset.item);
                showItemActionModal(item, 'equip');
            }
        });

        document.querySelectorAll('.equipment-slot').forEach(slot => {
            slot.addEventListener('click', (e) => {
                const itemJson = e.currentTarget.dataset.equippedItem;
                if (itemJson) {
                    const item = JSON.parse(itemJson);
                    showItemActionModal(item, 'unequip');
                }
            });
        });

        function showItemActionModal(item, actionType) {
            document.getElementById('item-modal-title').textContent = item.nome;
            document.getElementById('item-modal-effect').textContent = `Efeito: ${item.efeito}`;

            const primaryBtn = document.getElementById('item-action-primary-btn');
            const secondaryBtn = document.getElementById('item-action-secondary-btn');

            if (actionType === 'equip') {
                primaryBtn.textContent = 'Equipar';
                primaryBtn.onclick = () => {
                    equipItem(item.id, item.slot);
                    itemActionModal.classList.add('hidden');
                };
            } else { // unequip
                primaryBtn.textContent = 'Desequipar';
                primaryBtn.onclick = () => {
                    unequipItem(item.id, item.slot);
                    itemActionModal.classList.add('hidden');
                };
            }
            itemActionModal.classList.remove('hidden');
        }

        async function equipItem(itemId, slot) {
            if (!slot) {
                alert("Este item não pode ser equipado.");
                return;
            }
            if (fullProfileData.character.equipment[slot]) {
                alert("Slot já ocupado. Desequipe o item atual primeiro.");
                return;
            }

            const batch = writeBatch(db);
            const profileRef = doc(db, 'artifacts', appId, 'users', currentUserId, 'profile', 'details');
            const itemRef = doc(db, 'artifacts', appId, 'users', currentUserId, 'inventory', itemId);

            const itemSnap = await getDoc(itemRef);
            const itemData = itemSnap.data();

            batch.update(itemRef, { equipado: true });
            batch.update(profileRef, { [`character.equipment.${slot}`]: itemData });

            await batch.commit();
            loadCharacterData(currentUserId);
        }

        async function unequipItem(itemId, slot) {
            const batch = writeBatch(db);
            const profileRef = doc(db, 'artifacts', appId, 'users', currentUserId, 'profile', 'details');
            const itemRef = doc(db, 'artifacts', appId, 'users', currentUserId, 'inventory', itemId);

            batch.update(itemRef, { equipado: false });
            batch.update(profileRef, { [`character.equipment.${slot}`]: deleteField() });

            await batch.commit();
            loadCharacterData(currentUserId);
        }

        // --- Lógica do Carrossel de Saúde ---
        const dots = document.querySelectorAll('.carousel-dot');
        const slidesContainer = document.getElementById('health-slides');
        let currentSlide = 0;

        const goToSlide = (slideIndex) => {
            currentSlide = slideIndex;
            slidesContainer.style.transform = `translateX(-${slideIndex * 100}%)`;
            dots.forEach((dot, index) => {
                dot.classList.toggle('bg-primary', index === slideIndex);
                dot.classList.toggle('bg-surface-secondary', index !== slideIndex);
            });
        };

        dots.forEach(dot => {
            dot.addEventListener('click', () => {
                goToSlide(parseInt(dot.dataset.slideTo, 10));
            });
        });

        let touchStartX = 0;
        let touchEndX = 0;
        const carousel = document.getElementById('health-carousel');

        carousel.addEventListener('touchstart', (event) => {
            touchStartX = event.changedTouches[0].screenX;
        }, { passive: true });

        carousel.addEventListener('touchend', (event) => {
            touchEndX = event.changedTouches[0].screenX;
            handleSwipe();
        }, { passive: true });

        const handleSwipe = () => {
            const swipeThreshold = 50; // Mínimo de 50px de deslize para mudar o slide
            const swipeDistance = touchEndX - touchStartX;

            if (swipeDistance > swipeThreshold) { // Swipe right
                if (currentSlide > 0) {
                    goToSlide(currentSlide - 1);
                }
            } else if (swipeDistance < -swipeThreshold) { // Swipe left
                if (currentSlide < dots.length - 1) {
                    goToSlide(currentSlide + 1);
                }
            }
        };

        let weightOscillationChart = null;
        function renderWeightOscillationChart(logs, period = 'day') {
            const ctx = document.getElementById('weight-oscillation-chart').getContext('2d');
            if (logs.length < 2) {
                return;
            }

            let labels = [];
            let data = [];

            if (period === 'day') {
                const last7Logs = logs.slice(-7);
                labels = last7Logs.map(log => new Date(log.timestamp.seconds * 1000).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }));
                data = last7Logs.map((log, i) => {
                    if (i === 0) return 0;
                    const change = log.peso_kg - last7Logs[i-1].peso_kg;
                    return parseFloat(change.toFixed(2));
                });
            } else if (period === 'month') {
                const monthlyChanges = logs.reduce((acc, log) => {
                    const date = new Date(log.timestamp.seconds * 1000);
                    const monthYear = date.toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' });
                    if (!acc[monthYear]) {
                        acc[monthYear] = { logs: [] };
                    }
                    acc[monthYear].logs.push(log.peso_kg);
                    return acc;
                }, {});

                labels = Object.keys(monthlyChanges);
                data = labels.map(month => {
                    const monthLogs = monthlyChanges[month].logs;
                    const change = monthLogs[monthLogs.length - 1] - monthLogs[0];
                    return parseFloat(change.toFixed(2));
                });
            } else if (period === 'year') {
                 const yearlyChanges = logs.reduce((acc, log) => {
                    const date = new Date(log.timestamp.seconds * 1000);
                    const year = date.getFullYear().toString();
                    if (!acc[year]) {
                        acc[year] = { logs: [] };
                    }
                    acc[year].logs.push(log.peso_kg);
                    return acc;
                }, {});

                labels = Object.keys(yearlyChanges);
                data = labels.map(year => {
                    const yearLogs = yearlyChanges[year].logs;
                    const change = yearLogs[yearLogs.length - 1] - yearLogs[0];
                    return parseFloat(change.toFixed(2));
                });
            }


            if (weightOscillationChart) {
                weightOscillationChart.destroy();
            }

            weightOscillationChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Oscilação (kg)',
                        data: data,
                        backgroundColor: data.map(d => d >= 0 ? 'rgba(239, 68, 68, 0.6)' : 'rgba(19, 236, 109, 0.6)'),
                        borderColor: data.map(d => d >= 0 ? 'rgba(239, 68, 68, 1)' : 'rgba(19, 236, 109, 1)'),
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: { color: '#a0a0a0' },
                            grid: { color: '#3b5445' }
                        },
                        x: {
                            ticks: { color: '#a0a0a0' },
                            grid: { color: '#3b5445' }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        document.getElementById('oscillation-period-btns').addEventListener('click', (e) => {
            const button = e.target.closest('.oscillation-btn');
            if (button) {
                document.querySelectorAll('.oscillation-btn').forEach(btn => {
                    btn.classList.remove('bg-primary', 'text-background-dark');
                    btn.classList.add('text-text-secondary');
                });
                button.classList.add('bg-primary', 'text-background-dark');
                button.classList.remove('text-text-secondary');

                renderWeightOscillationChart(characterDailyLogs, button.dataset.period);
            }
        });

        function renderProgressStats(logs, vitals) {
            const container = document.getElementById('progress-stats-container');
            if (logs.length < 2) {
                container.innerHTML = '<p class="text-text-secondary">Adicione mais pesagens para ver suas estatísticas.</p>';
                return;
            }

            const lastLog = logs[logs.length - 1];
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

            const logsLast7Days = logs.filter(log => new Date(log.timestamp.seconds * 1000) >= sevenDaysAgo);

            let weightChange7Days = 0;
            if (logsLast7Days.length > 1) {
                const firstWeight = logsLast7Days[0].peso_kg;
                const lastWeight = logsLast7Days[logsLast7Days.length - 1].peso_kg;
                weightChange7Days = lastWeight - firstWeight;
            }

            let timeToGoal = 'N/A';
            if (vitals.meta_peso_kg && weightChange7Days !== 0) {
                const weightToLose = lastLog.peso_kg - vitals.meta_peso_kg;
                if (weightToLose > 0 && weightChange7Days < 0) {
                    const weeksToGoal = weightToLose / -weightChange7Days;
                    timeToGoal = `${Math.ceil(weeksToGoal)} semanas`;
                } else if (weightToLose < 0 && weightChange7Days > 0) {
                    const weeksToGoal = -weightToLose / weightChange7Days;
                    timeToGoal = `${Math.ceil(weeksToGoal)} semanas`;
                }
            }

            const weeklyChangeText = weightChange7Days > 0
                ? `Ganhou ${weightChange7Days.toFixed(1)} kg`
                : `Perdeu ${(-weightChange7Days).toFixed(1)} kg`;

            container.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <p class="text-text-secondary">Variação (7d)</p>
                        <p class="text-2xl font-bold ${weightChange7Days > 0 ? 'text-debuff' : 'text-primary'}">${weeklyChangeText}</p>
                    </div>
                    <div>
                        <p class="text-text-secondary">Ritmo para Meta</p>
                        <p class="text-2xl font-bold">${timeToGoal}</p>
                    </div>
                </div>
            `;
        }
    });
</script>
</body></html>