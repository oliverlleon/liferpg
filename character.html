<!DOCTYPE html>
<html class="dark" lang="pt"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Ficha de Personagem &amp; Inventário</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Spline+Sans:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#13ec6d",
            "background-light": "#f6f8f7",
            "background-dark": "#111814",
            "surface": "#1a241e",
            "surface-secondary": "#28392f",
            "text-primary": "#ffffff",
            "text-secondary": "#a0a0a0",
            "border-color": "#3b5445",
            "debuff": "#ef4444",
          },
          fontFamily: {
            "display": ["Spline Sans", "Noto Sans", "sans-serif"]
          },
          borderRadius: {
            "DEFAULT": "1rem",
            "lg": "1.5rem",
            "xl": "2rem",
            "full": "9999px"
          },
        },
      },
    }
  </script>
<style>
    .material-symbols-outlined {
      font-variation-settings:
        'FILL' 0,
        'wght' 400,
        'GRAD' 0,
        'opsz' 24
    }
    body {
      min-height: 100dvh;
    }
    .equipment-slot {
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .equipment-slot:hover {
        background-color: #28392f;
    }
    .health-swiper .swiper-pagination-bullet {
        background-color: #3b5445;
    }
    .health-swiper .swiper-pagination-bullet-active {
        background-color: #13ec6d;
    }
  </style>
</head>
<body class="bg-background-dark font-display text-text-primary">
<div id="app-container" class="flex h-auto min-h-screen w-full flex-col">
<header class="flex flex-col items-center p-4 pt-8">
<div class="relative w-full max-w-sm mx-auto h-72">
<div class="absolute z-10 top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">
<img alt="Avatar do Aventureiro" id="avatar-img" class="w-32 h-32 rounded-full border-4 border-primary object-cover shadow-lg" src="https://placehold.co/128x128/1a241e/13ec6d?text=?"/>
</div>
<div id="slot-cabeca" data-slot="cabeca" class="equipment-slot absolute w-16 h-16 rounded-lg bg-surface border-2 border-border-color flex items-center justify-center text-text-secondary" style="top: 0; left: 50%; transform: translateX(-50%);"><span class="material-symbols-outlined">skull</span></div>
<div id="slot-peitoral" data-slot="peitoral" class="equipment-slot absolute w-16 h-16 rounded-lg bg-surface border-2 border-border-color flex items-center justify-center text-text-secondary" style="top: 50%; left: 0; transform: translateY(-50%);"><span class="material-symbols-outlined">shield</span></div>
<div id="slot-mao_direita" data-slot="mao_direita" class="equipment-slot absolute w-16 h-16 rounded-lg bg-surface border-2 border-border-color flex items-center justify-center text-text-secondary" style="top: 50%; right: 0; transform: translateY(-50%);"><span class="material-symbols-outlined">swords</span></div>
<div id="slot-amuleto" data-slot="amuleto" class="equipment-slot absolute w-16 h-16 rounded-lg bg-surface border-2 border-border-color flex items-center justify-center text-text-secondary" style="bottom: 0; left: 25%; transform: translateX(-50%);"><span class="material-symbols-outlined">diamond</span></div>
<div id="slot-botas" data-slot="botas" class="equipment-slot absolute w-16 h-16 rounded-lg bg-surface border-2 border-border-color flex items-center justify-center text-text-secondary" style="bottom: 0; right: 25%; transform: translateX(50%);"><span class="material-symbols-outlined">foot_bones</span></div>
</div>
<h1 id="character-level-title" class="text-2xl font-bold mt-4">Carregando...</h1>
<p id="character-name" class="text-text-secondary">...</p>
</header>
<main class="flex-1 pb-24 px-4 space-y-8">
<section>
<div class="bg-surface rounded-lg p-4">
<div class="flex justify-between items-center mb-4">
<div>
<p class="text-text-secondary text-sm">Peso Atual</p>
<p id="current-weight" class="text-xl font-bold">- kg</p>
</div>
<div>
<p class="text-text-secondary text-sm text-right">IMC</p>
<p id="current-imc" class="text-xl font-bold text-right">-</p>
</div>
<button id="add-daily-log-btn" class="flex items-center justify-center gap-2 rounded-full h-10 px-4 bg-surface-secondary text-primary text-sm font-bold">
<span class="material-symbols-outlined !text-base">add_circle</span>
<span>Adicionar Log Diário</span>
</button>
</div>
<div id="status-effects-container" class="border-t border-border-color pt-4">
<h3 class="font-bold mb-2">Efeitos Ativos</h3>
</div>
</div>
</section>
<section>
<h2 class="text-xl font-bold mb-4">Histórico de Saúde</h2>
<div class="swiper health-swiper bg-surface rounded-lg">
<div class="swiper-wrapper">
<!-- Slide 1: Gráfico de Linha Principal -->
<div class="swiper-slide p-4">
<canvas id="health-chart"></canvas>
</div>
<!-- Slide 2: Análise e Projeções -->
<div class="swiper-slide p-4">
<div id="health-analytics-container" class="flex flex-col justify-center items-center h-full">
<!-- Conteúdo será preenchido via JS -->
<p class="text-text-secondary">Carregando análise...</p>
</div>
</div>
<!-- Slide 3: Gráfico de Oscilação -->
<div class="swiper-slide p-4">
<canvas id="oscillation-chart"></canvas>
</div>
</div>
<!-- Paginação -->
<div class="swiper-pagination"></div>
</div>
</section>
<section>
<h2 class="text-xl font-bold mb-4">Atributos</h2>
<div id="attributes-list" class="bg-surface rounded-lg p-4 space-y-4">
</div>
</section>
<section>
<h2 class="text-xl font-bold mb-4">Inventário</h2>
<div id="inventory-grid" class="grid grid-cols-4 sm:grid-cols-5 gap-4">
</div>
</section>
<section>
<h2 class="text-xl font-bold mb-4">Conquistas</h2>
<div id="achievements-list" class="space-y-3">
</div>
</section>
</main>
<nav class="fixed bottom-0 left-0 right-0 bg-surface-secondary/80 backdrop-blur-sm border-t border-border-color">
<div class="flex justify-around h-20">
<a class="flex flex-col items-center justify-center w-full text-text-secondary hover:text-primary" href="./index.html">
<span class="material-symbols-outlined">home</span>
<span class="text-xs">Início</span>
</a>
<a class="flex flex-col items-center justify-center w-full text-primary" href="#">
<span class="material-symbols-outlined">person</span>
<span class="text-xs">Personagem</span>
</a>
<a class="flex flex-col items-center justify-center w-full text-text-secondary hover:text-primary" href="./index.html">
<span class="material-symbols-outlined">shield_moon</span>
<span class="text-xs">Missões</span>
</a>
<a class="flex flex-col items-center justify-center w-full text-text-secondary hover:text-primary" href="#">
<span class="material-symbols-outlined">bar_chart</span>
<span class="text-xs">Progresso</span>
</a>
</div>
</nav>
</div>

<!-- Modal de Adicionar Log Diário -->
<div id="modal-add-log" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
<div class="bg-surface border border-border-color rounded-lg p-6 w-full max-w-sm">
<h3 class="text-primary text-xl font-bold mb-2 text-center">Adicionar Log Diário</h3>
<p class="text-text-secondary mb-6 text-center text-sm">Registre suas métricas de hoje.</p>

<div class="space-y-4">
<div>
<label for="log-weight-input" class="text-text-secondary text-sm font-bold mb-1 block">Novo Peso (kg) <span class="text-debuff">*</span></label>
<input id="log-weight-input" type="number" class="form-input w-full bg-background-dark border-border-color rounded-md text-center text-lg" placeholder="Ex: 75.5">
</div>

<div>
<label for="log-fat-perc-input" class="text-text-secondary text-sm font-bold mb-1 block">Gordura Corporal (%) <span class="text-xs">(Opcional)</span></label>
<input id="log-fat-perc-input" type="number" class="form-input w-full bg-background-dark border-border-color rounded-md text-center text-lg" placeholder="Ex: 18.5">
</div>

<div class="grid grid-cols-2 gap-4">
<div>
<label for="log-sleep-hours-input" class="text-text-secondary text-sm font-bold mb-1 block">Horas de Sono <span class="text-xs">(Opcional)</span></label>
<input id="log-sleep-hours-input" type="number" class="form-input w-full bg-background-dark border-border-color rounded-md text-center text-lg" placeholder="Ex: 8">
</div>
<div>
<label for="log-stress-level-input" class="text-text-secondary text-sm font-bold mb-1 block">Nível Estresse (1-5) <span class="text-xs">(Opcional)</span></label>
<input id="log-stress-level-input" type="number" min="1" max="5" class="form-input w-full bg-background-dark border-border-color rounded-md text-center text-lg" placeholder="Ex: 2">
</div>
</div>
</div>

<div class="flex gap-4 mt-8">
<button id="cancel-log-update" class="flex-1 rounded-full h-12 bg-surface-secondary text-text-primary font-bold">Cancelar</button>
<button id="confirm-log-update" class="flex-1 rounded-full h-12 bg-primary text-background-dark font-bold">Salvar</button>
</div>
</div>
</div>

<!-- Modal de Ação de Item -->
<div id="modal-item-action" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
<div class="bg-surface border border-border-color rounded-lg p-6 w-full max-w-sm text-center">
<h3 id="item-modal-title" class="text-primary text-xl font-bold mb-2">Nome do Item</h3>
<p id="item-modal-effect" class="text-text-secondary mb-6">Efeito do item</p>
<div class="flex gap-4">
<button id="item-action-secondary-btn" class="flex-1 rounded-full h-12 bg-surface-secondary text-text-primary font-bold">Descartar</button>
<button id="item-action-primary-btn" class="flex-1 rounded-full h-12 bg-primary text-background-dark font-bold">Ação</button>
</div>
<button id="item-action-cancel-btn" class="w-full mt-3 rounded-full h-10 bg-transparent text-text-secondary">Cancelar</button>
</div>
</div>

<script type="module">
    // Importações do Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, getDocs, runTransaction, writeBatch, deleteField, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    document.addEventListener('DOMContentLoaded', () => {
        // --- Configuração do Firebase ---
        const firebaseConfigUser = {
          apiKey: "AIzaSyBeLq53I4Zu8TIcttgYwcyhFUBu4uneCxQ",
          authDomain: "rpglife-8f33d.firebaseapp.com",
          projectId: "rpglife-8f33d",
          storageBucket: "rpglife-8f33d.firebasestorage.app",
          messagingSenderId: "428052124083",
          appId: "1:428052124083:web:1190108bd19638ad2bfbc6",
          measurementId: "G-5LCK5W2JNH"
        };

        const firebaseConfig = typeof __firebase_config !== 'undefined'
          ? JSON.parse(__firebase_config)
          : firebaseConfigUser;

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'rpglife-app';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserId = null;
        let fullProfileData = null;

        onAuthStateChanged(auth, user => {
            if (user) {
                currentUserId = user.uid;
                loadCharacterData(currentUserId);
            } else {
                window.location.href = 'index.html';
            }
        });

        async function loadCharacterData(uid) {
            const profileRef = doc(db, 'artifacts', appId, 'users', uid, 'profile', 'details');
            const inventoryRef = collection(db, 'artifacts', appId, 'users', uid, 'inventory');
            const goalsRef = collection(db, 'artifacts', appId, 'users', uid, 'goals');
            const dailyLogRef = collection(db, 'artifacts', appId, 'users', uid, 'daily_log');

            try {
                const [profileSnap, inventorySnap, goalsSnap, dailyLogSnap] = await Promise.all([
                    getDoc(profileRef),
                    getDocs(inventoryRef),
                    getDocs(goalsRef),
                    getDocs(query(dailyLogRef, orderBy("timestamp", "asc")))
                ]);

                if (profileSnap.exists()) {
                    fullProfileData = profileSnap.data();
                    renderAdventurerPanel(fullProfileData.character, fullProfileData.nickname);
                    renderVitalsPanel(fullProfileData.vitals, fullProfileData.status_effects);
                    renderAttributesPanel(fullProfileData.stats);
                }

                const inventoryItems = inventorySnap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderInventory(inventoryItems);

                const goals = goalsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderAchievements(goals);

                const dailyLogs = dailyLogSnap.docs.map(d => d.data());
                renderHealthChart(dailyLogs, fullProfileData.vitals);
                renderHealthAnalytics(dailyLogs, fullProfileData.vitals);
                renderOscillationChart(dailyLogs);


            } catch (error) {
                console.error("Error loading character data:", error);
            }
        }

        let healthChart = null; // Variável para manter a instância do gráfico
        function renderHealthChart(logs, vitals) {
            const ctx = document.getElementById('health-chart').getContext('2d');
            if (!ctx) return;

            const labels = logs.map(log => new Date(log.timestamp.seconds * 1000).toLocaleDateString('pt-BR'));
            const weightData = logs.map(log => log.peso_kg);
            const fatData = logs.map(log => log.gordura_perc);

            const datasets = [{
                label: 'Peso (kg)',
                data: weightData,
                borderColor: 'rgba(19, 236, 109, 1)',
                backgroundColor: 'rgba(19, 236, 109, 0.2)',
                fill: true,
                yAxisID: 'y-weight',
            }];

            if (fatData.some(d => d != null)) {
                datasets.push({
                    label: '% Gordura Corporal',
                    data: fatData,
                    borderColor: 'rgba(245, 158, 11, 1)',
                    backgroundColor: 'rgba(245, 158, 11, 0.2)',
                    fill: false,
                    yAxisID: 'y-fat',
                });
            }

            if (vitals.meta_peso_kg) {
                datasets.push({
                    label: 'Meta de Peso',
                    data: Array(labels.length).fill(vitals.meta_peso_kg),
                    borderColor: 'rgba(239, 68, 68, 1)',
                    borderDash: [5, 5],
                    fill: false,
                    pointRadius: 0,
                    yAxisID: 'y-weight',
                });
            }

            if (healthChart) {
                healthChart.destroy();
            }

            healthChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            ticks: { color: '#a0a0a0' },
                            grid: { color: '#3b5445' }
                        },
                        'y-weight': {
                            type: 'linear',
                            position: 'left',
                            title: { display: true, text: 'Peso (kg)', color: '#13ec6d' },
                            ticks: { color: '#a0a0a0' },
                            grid: { color: '#3b5445' }
                        },
                        'y-fat': {
                            type: 'linear',
                            position: 'right',
                            title: { display: true, text: '% Gordura', color: '#f59e0b' },
                            ticks: { color: '#a0a0a0' },
                            grid: { drawOnChartArea: false } // Só desenha a grade para o eixo principal
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#ffffff' } }
                    }
                }
            });
        }

        function renderHealthAnalytics(logs, vitals) {
            const container = document.getElementById('health-analytics-container');
            if (!logs || logs.length < 2) {
                container.innerHTML = `<p class="text-text-secondary text-center">Dados insuficientes para análise. Continue registrando!</p>`;
                return;
            }

            // Calcula a mudança nos últimos 7 e 30 dias
            const now = new Date();
            const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);

            const recentLogs = logs.filter(log => new Date(log.timestamp.seconds * 1000) > thirtyDaysAgo);
            if (recentLogs.length < 2) {
                 container.innerHTML = `<p class="text-text-secondary text-center">Continue registrando para ver a análise de 30 dias.</p>`;
                return; // Precisa de pelo menos 2 logs no período para calcular a média
            }

            const firstLog = recentLogs[0];
            const lastLog = recentLogs[recentLogs.length - 1];

            const totalDays = (new Date(lastLog.timestamp.seconds * 1000) - new Date(firstLog.timestamp.seconds * 1000)) / (1000 * 60 * 60 * 24);
            const totalWeightChange = lastLog.peso_kg - firstLog.peso_kg;
            const avgDailyChange = totalDays > 0 ? totalWeightChange / totalDays : 0;

            let projectionHtml = `<p class="text-sm text-text-secondary text-center">Mantenha o ritmo!</p>`;
            if (vitals.meta_peso_kg && avgDailyChange !== 0) {
                const weightToGoal = vitals.meta_peso_kg - lastLog.peso_kg;
                if ((weightToGoal > 0 && avgDailyChange > 0) || (weightToGoal < 0 && avgDailyChange < 0)) {
                    const daysToGoal = Math.abs(Math.round(weightToGoal / avgDailyChange));
                    projectionHtml = `
                        <p class="text-lg font-bold text-primary">${daysToGoal} dias</p>
                        <p class="text-sm text-text-secondary text-center">É o tempo estimado para alcançar sua meta de ${vitals.meta_peso_kg} kg.</p>
                    `;
                } else {
                     projectionHtml = `<p class="text-sm text-text-secondary text-center">Você está se afastando da sua meta. Ajuste o curso!</p>`;
                }
            }


            container.innerHTML = `
                <h3 class="text-lg font-bold text-primary mb-4">Análise de Progresso</h3>
                <div class="text-center mb-6">
                     <p class="text-3xl font-bold">${(avgDailyChange * 7).toFixed(2)} kg</p>
                     <p class="text-sm text-text-secondary">Foi sua mudança média nos últimos 7 dias.</p>
                </div>
                <div class="text-center">
                    ${projectionHtml}
                </div>
            `;
        }

        let oscillationChart = null;
        function renderOscillationChart(logs) {
            const ctx = document.getElementById('oscillation-chart').getContext('2d');
            if (!ctx) return;

            if (logs.length < 2) {
                // Não é possível calcular oscilação com menos de 2 pontos
                return;
            }

            const labels = [];
            const data = [];
            const backgroundColors = [];

            for (let i = 1; i < logs.length; i++) {
                const prevLog = logs[i - 1];
                const currentLog = logs[i];

                const date = new Date(currentLog.timestamp.seconds * 1000).toLocaleDateString('pt-BR');
                const weightChange = currentLog.peso_kg - prevLog.peso_kg;

                labels.push(date);
                data.push(weightChange.toFixed(2));

                // Verde para perda de peso, Vermelho para ganho
                if (weightChange < 0) {
                    backgroundColors.push('rgba(19, 236, 109, 0.7)');
                } else {
                    backgroundColors.push('rgba(239, 68, 68, 0.7)');
                }
            }

            if (oscillationChart) {
                oscillationChart.destroy();
            }

            oscillationChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Variação Diária (kg)',
                        data: data,
                        backgroundColor: backgroundColors
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                         x: {
                            ticks: { color: '#a0a0a0' },
                            grid: { color: '#3b5445' }
                        },
                        y: {
                            title: { display: true, text: 'Variação (kg)', color: '#a0a0a0' },
                            ticks: { color: '#a0a0a0' },
                            grid: { color: '#3b5445' }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }


        function renderAdventurerPanel(character, nickname) {
            document.getElementById('avatar-img').src = character.avatar_url || 'https://placehold.co/128x128/1a241e/13ec6d?text=?';
            document.getElementById('character-level-title').textContent = `Nível ${character.level || 1}`;
            document.getElementById('character-name').textContent = nickname || 'Aventureiro';

            const equipment = character.equipment || {};
            const slots = ['cabeca', 'peitoral', 'mao_direita', 'amuleto', 'botas'];
            const defaultIcons = {
                cabeca: 'skull',
                peitoral: 'shield',
                mao_direita: 'swords',
                amuleto: 'diamond',
                botas: 'foot_bones'
            };

            slots.forEach(slot => {
                const slotEl = document.getElementById(`slot-${slot}`);
                const item = equipment[slot];
                if (item && item.icon) {
                    slotEl.innerHTML = `<span class="material-symbols-outlined !text-4xl text-primary">${item.icon}</span>`;
                    slotEl.dataset.equippedItem = JSON.stringify(item);
                } else {
                    slotEl.innerHTML = `<span class="material-symbols-outlined">${defaultIcons[slot]}</span>`;
                    delete slotEl.dataset.equippedItem;
                }
            });
        }

        function renderVitalsPanel(vitals, statusEffects) {
            document.getElementById('current-weight').textContent = `${vitals.peso_atual_kg || '-'} kg`;
            document.getElementById('current-imc').textContent = vitals.imc || '-';

            const effectsContainer = document.getElementById('status-effects-container');
            effectsContainer.innerHTML = '<h3 class="font-bold mb-2">Efeitos Ativos</h3>';
            if (statusEffects && statusEffects.length > 0) {
                const effectMap = {
                    energia_max: "Energia Máxima",
                    hp_max: "HP Máximo"
                };
                statusEffects.forEach(effect => {
                    const effectText = effectMap[effect.effect] || effect.effect;
                    effectsContainer.innerHTML += `
                        <div class="flex items-center gap-3 text-debuff">
                            <span class="material-symbols-outlined">sentiment_dissatisfied</span>
                            <p class="text-sm">"${effect.label}": ${effect.value}% ${effectText}</p>
                        </div>
                    `;
                });
            } else {
                effectsContainer.innerHTML += `<p class="text-sm text-text-secondary">Nenhum efeito ativo.</p>`;
            }
        }

        function renderAttributesPanel(stats) {
            const attributesList = document.getElementById('attributes-list');
            attributesList.innerHTML = '';
            const attributeConfig = {
                forca: { icon: 'fitness_center', name: 'FORÇA' },
                inteligencia: { icon: 'school', name: 'INTELIGÊNCIA' },
                velocidade: { icon: 'sprint', name: 'VELOCIDADE' },
                vitalidade: { icon: 'favorite', name: 'VITALIDADE' },
                carisma: { icon: 'star', name: 'CARISMA' }
            };

            for (const key in attributeConfig) {
                const stat = stats[key] || { level: 1, xp_atual: 0, xp_para_upar: 100 };
                const config = attributeConfig[key];
                const xpPercent = (stat.xp_atual / stat.xp_para_upar) * 100;

                attributesList.innerHTML += `
                    <div class="flex items-center gap-4">
                        <div class="flex size-10 items-center justify-center rounded-full bg-surface-secondary text-primary"><span class="material-symbols-outlined">${config.icon}</span></div>
                        <div class="flex-1">
                            <div class="flex justify-between items-baseline">
                                <p class="font-bold">${config.name}</p>
                                <p class="text-text-secondary text-xs">Nível: ${stat.level}</p>
                            </div>
                            <div class="w-full bg-surface-secondary rounded-full h-2 mt-1">
                                <div class="bg-primary h-2 rounded-full" style="width: ${xpPercent}%"></div>
                            </div>
                            <p class="text-text-secondary text-xs text-right mt-1">${stat.xp_atual} / ${stat.xp_para_upar} XP</p>
                        </div>
                    </div>
                `;
            }
        }

        function renderInventory(items) {
            const inventoryGrid = document.getElementById('inventory-grid');
            inventoryGrid.innerHTML = '';
            const unequippedItems = items.filter(item => !item.equipado);

            unequippedItems.forEach(item => {
                inventoryGrid.innerHTML += `
                    <div class="inventory-item aspect-square bg-surface border-2 border-border-color rounded-lg flex items-center justify-center cursor-pointer" data-item='${JSON.stringify(item)}'>
                        <span class="material-symbols-outlined !text-4xl text-primary">${item.icon || 'help'}</span>
                    </div>
                `;
            });
        }

        function renderAchievements(goals) {
            const achievementsList = document.getElementById('achievements-list');
            achievementsList.innerHTML = '';
            if (!goals || goals.length === 0) {
                achievementsList.innerHTML = `<p class="text-text-secondary text-center">Nenhuma conquista ainda.</p>`;
                return;
            }

            goals.forEach(goal => {
                const progressPercent = (goal.progresso_atual / goal.progresso_total) * 100;
                achievementsList.innerHTML += `
                    <div class="bg-surface rounded-lg p-4 flex items-center gap-4 ${goal.concluido ? 'opacity-70' : ''}">
                        <span class="material-symbols-outlined !text-4xl text-yellow-400">emoji_events</span>
                        <div class="flex-1">
                            <p class="font-bold">${goal.titulo}</p>
                            <p class="text-text-secondary text-sm">${goal.descricao}</p>
                            ${!goal.concluido ? `
                            <div class="w-full bg-surface-secondary rounded-full h-2 my-1">
                                <div class="bg-yellow-400 h-2 rounded-full" style="width: ${progressPercent}%;"></div>
                            </div>
                            <p class="text-text-secondary text-xs">${goal.progresso_atual} / ${goal.progresso_total}</p>
                            ` : `<p class="text-primary text-sm font-semibold mt-1">Recompensa: ${goal.recompensa || '[Item Raro]'}</p>`}
                        </div>
                    </div>
                `;
            });
        }

        // --- Modals Logic ---
        const dailyLogModal = document.getElementById('modal-add-log');
        const itemActionModal = document.getElementById('modal-item-action');

        document.getElementById('add-daily-log-btn').addEventListener('click', () => dailyLogModal.classList.remove('hidden'));
        document.getElementById('cancel-log-update').addEventListener('click', () => dailyLogModal.classList.add('hidden'));
        document.getElementById('confirm-log-update').addEventListener('click', handleAddDailyLog);
        document.getElementById('item-action-cancel-btn').addEventListener('click', () => itemActionModal.classList.add('hidden'));

        function calcularNovosStatus(imc, gordura_perc, sono, estresse) {
            let status_array = [];

            // --- Lógica 1: Gordura vs IMC (O "Override") ---
            if (gordura_perc && gordura_perc > 0) {
                // LÓGICA AVANÇADA (Usuário informou % de gordura)
                if (gordura_perc > 30) {
                    status_array.push({ id: "debuff_gordura_alta", label: "Gordura Elevada", effect: "energia_max", value: -15 });
                } else if (gordura_perc < 10) {
                    status_array.push({ id: "debuff_gordura_baixa", label: "Gordura Baixa", effect: "hp_max", value: -10 });
                } else {
                    status_array.push({ id: "buff_composicao_saudavel", label: "Composição Saudável", effect: "energia_max", value: 5 });
                }
            } else {
                // LÓGICA BÁSICA (Fallback para IMC)
                if (imc > 25) {
                    status_array.push({ id: "debuff_imc_alto", label: "Sobrepeso", effect: "energia_max", value: -10 });
                } else if (imc < 18.5) {
                    status_array.push({ id: "debuff_imc_baixo", label: "Abaixo do Peso", effect: "hp_max", value: -10 });
                }
            }

            // --- Lógica 2: Buffs Opcionais (Sono) ---
            if (sono && sono >= 8) {
                status_array.push({ id: "buff_descansado", label: "Descansado", effect: "regeneracao_mana_energia", value: 10 });
            } else if (sono && sono < 5) {
                status_array.push({ id: "debuff_cansado", label: "Cansado", effect: "regeneracao_mana_energia", value: -10 });
            }

            // --- Lógica 3: Buffs Opcionais (Estresse) ---
            if (estresse && estresse === 1) { // Nível 1 (Baixo)
                status_array.push({ id: "buff_focado", label: "Focado", effect: "custo_mana", value: -5 });
            } else if (estresse && estresse === 5) { // Nível 5 (Alto)
                status_array.push({ id: "debuff_estressado", label: "Estressado", effect: "custo_mana", value: 10 });
            }

            return status_array;
        }

        function recalcularAtributosDerivados(novos_status, stats) {
            // Garante que stats não é nulo ou indefinido
            const safeStats = stats || {};
            const forca = safeStats.forca?.level || 1;
            const vitalidade = safeStats.vitalidade?.level || 1;
            const velocidade = safeStats.velocidade?.level || 1;

            // Fórmulas base
            let hp_max_base = 100 + (vitalidade * 10) + (forca * 2);
            let energia_max_base = 100 + (forca * 5) + (velocidade * 5);

            // Aplica efeitos do array de status
            novos_status.forEach(effect => {
                if (effect.effect === "hp_max") {
                    hp_max_base *= (1 + (effect.value / 100));
                } else if (effect.effect === "energia_max") {
                    energia_max_base *= (1 + (effect.value / 100));
                }
            });

            return {
                hp_max_final: Math.round(hp_max_base),
                energia_max_final: Math.round(energia_max_base)
            };
        }

        async function handleAddDailyLog() {
            const getNumericValue = (id) => {
                const value = document.getElementById(id).value;
                if (value === '' || value === null) return null;
                const parsed = parseFloat(value);
                return isNaN(parsed) ? null : parsed;
            };

            const newWeight = getNumericValue('log-weight-input');
            const newFatPerc = getNumericValue('log-fat-perc-input');
            const newSleepHours = getNumericValue('log-sleep-hours-input');
            const newStressLevel = getNumericValue('log-stress-level-input');

            if (newWeight === null || newWeight <= 0) {
                alert("Por favor, insira um peso válido.");
                return;
            }

            try {
                await runTransaction(db, async (transaction) => {
                    // Passo 1 (Ler): Lê o perfil do usuário e prepara as referências
                    const profileRef = doc(db, 'artifacts', appId, 'users', currentUserId, 'profile', 'details');
                    const dailyLogCollectionRef = collection(db, 'artifacts', appId, 'users', currentUserId, 'daily_log');
                    const newLogRef = doc(dailyLogCollectionRef); // Cria uma referência para o novo log

                    const profileSnap = await transaction.get(profileRef);
                    if (!profileSnap.exists()) throw "Documento de perfil não existe!";

                    const profileData = profileSnap.data();

                    // Passo 2 (Calcular): Calcula o novo IMC e os novos status
                    const altura_m = profileData.vitals.altura_cm / 100;
                    const newImc = parseFloat((newWeight / (altura_m * altura_m)).toFixed(1));
                    const novosStatus = calcularNovosStatus(newImc, newFatPerc, newSleepHours, newStressLevel);
                    const atributosDerivados = recalcularAtributosDerivados(novosStatus, profileData.stats);

                    // Passo 3 (Escrever - Write 1: O Histórico): Cria o novo documento de log diário
                    const logData = {
                        timestamp: new Date(),
                        peso_kg: newWeight,
                        gordura_perc: newFatPerc,
                        horas_sono: newSleepHours,
                        nivel_estresse: newStressLevel
                    };
                    transaction.set(newLogRef, logData);

                    // Passo 4 (Escrever - Write 2: O Snapshot): Prepara a atualização do perfil
                    const vitalsUpdate = {
                        ...profileData.vitals,
                        peso_atual_kg: newWeight,
                        imc_atual: newImc,
                        gordura_corporal_perc: newFatPerc || profileData.vitals.gordura_corporal_perc || null,
                        horas_sono_media: newSleepHours || profileData.vitals.horas_sono_media || null, // Simplificado por enquanto
                        estresse_medio: newStressLevel || profileData.vitals.estresse_medio || null // Simplificado
                    };

                    const characterUpdate = {
                        ...profileData.character,
                        hp_max: atributosDerivados.hp_max_final,
                        energia_max: atributosDerivados.energia_max_final
                    };

                    // Atualiza o documento principal com todos os novos dados
                    transaction.update(profileRef, {
                        vitals: vitalsUpdate,
                        status_effects: novosStatus,
                        character: characterUpdate
                    });
                });

                // Primeiro, esconde o modal e limpa os campos
                dailyLogModal.classList.add('hidden');
                document.getElementById('log-weight-input').value = '';
                document.getElementById('log-fat-perc-input').value = '';
                document.getElementById('log-sleep-hours-input').value = '';
                document.getElementById('log-stress-level-input').value = '';

                // Atualiza a UI imediatamente para uma resposta mais rápida
                document.getElementById('current-weight').textContent = `${newWeight} kg`;
                document.getElementById('current-imc').textContent = newImc;

                // Depois, carrega os novos dados em segundo plano para atualizar os gráficos e o resto
                loadCharacterData(currentUserId);

            } catch (e) {
                console.error("Transação falhou: ", e);
                alert("Falha ao adicionar o log diário. Tente novamente.");
            }
        }

        document.getElementById('inventory-grid').addEventListener('click', (e) => {
            const itemEl = e.target.closest('.inventory-item');
            if (itemEl) {
                const item = JSON.parse(itemEl.dataset.item);
                showItemActionModal(item, 'equip');
            }
        });

        document.querySelectorAll('.equipment-slot').forEach(slot => {
            slot.addEventListener('click', (e) => {
                const itemJson = e.currentTarget.dataset.equippedItem;
                if (itemJson) {
                    const item = JSON.parse(itemJson);
                    showItemActionModal(item, 'unequip');
                }
            });
        });

        function showItemActionModal(item, actionType) {
            document.getElementById('item-modal-title').textContent = item.nome;
            document.getElementById('item-modal-effect').textContent = `Efeito: ${item.efeito}`;

            const primaryBtn = document.getElementById('item-action-primary-btn');
            const secondaryBtn = document.getElementById('item-action-secondary-btn');

            if (actionType === 'equip') {
                primaryBtn.textContent = 'Equipar';
                primaryBtn.onclick = () => {
                    equipItem(item.id, item.slot);
                    itemActionModal.classList.add('hidden');
                };
            } else { // unequip
                primaryBtn.textContent = 'Desequipar';
                primaryBtn.onclick = () => {
                    unequipItem(item.id, item.slot);
                    itemActionModal.classList.add('hidden');
                };
            }
            itemActionModal.classList.remove('hidden');
        }

        async function equipItem(itemId, slot) {
            if (!slot) {
                alert("Este item não pode ser equipado.");
                return;
            }
            if (fullProfileData.character.equipment[slot]) {
                alert("Slot já ocupado. Desequipe o item atual primeiro.");
                return;
            }

            const batch = writeBatch(db);
            const profileRef = doc(db, 'artifacts', appId, 'users', currentUserId, 'profile', 'details');
            const itemRef = doc(db, 'artifacts', appId, 'users', currentUserId, 'inventory', itemId);

            const itemSnap = await getDoc(itemRef);
            const itemData = itemSnap.data();

            batch.update(itemRef, { equipado: true });
            batch.update(profileRef, { [`character.equipment.${slot}`]: itemData });

            await batch.commit();
            loadCharacterData(currentUserId);
        }

        async function unequipItem(itemId, slot) {
            const batch = writeBatch(db);
            const profileRef = doc(db, 'artifacts', appId, 'users', currentUserId, 'profile', 'details');
            const itemRef = doc(db, 'artifacts', appId, 'users', currentUserId, 'inventory', itemId);

            batch.update(itemRef, { equipado: false });
            batch.update(profileRef, { [`character.equipment.${slot}`]: deleteField() });

            await batch.commit();
            loadCharacterData(currentUserId);
        }

        const healthSwiper = new Swiper('.health-swiper', {
            // Optional parameters
            loop: false,
            // If we need pagination
            pagination: {
                el: '.swiper-pagination',
                clickable: true,
            },
        });
    });
</script>
</body></html>